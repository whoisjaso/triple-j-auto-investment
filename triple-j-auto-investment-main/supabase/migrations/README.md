# Registration Schema Migrations

## Migration Order

1. `../registration_ledger.sql` - Creates base registration tables
2. `02_registration_schema_update.sql` - Updates schema for 6-stage workflow
3. `03_customer_portal_access.sql` - Adds token-based customer access
4. `04_notification_system.sql` - Notification queue, preferences, debounce trigger, phone-auth RLS, pg_cron

## What This Migration Does

Updates the registration schema for a 6-stage dealer-controlled workflow:

- Adds `is_registration_admin` role to profiles
- Adds document checklist (5 booleans) and milestone timestamps
- Creates `registration_audit` table with trigger for all field changes
- Enforces forward-only status transitions at database level
- Updates RLS policies for granular permissions

## Breaking Changes

### Stage Keys Changed

| Old Stage | New Stage |
|-----------|-----------|
| payment | sale_complete |
| insurance | documents_collected |
| inspection | documents_collected |
| submission | submitted_to_dmv |
| dmv_processing | dmv_processing |
| approved | sticker_ready |
| ready | sticker_delivered |

### Data Migration (run BEFORE applying constraint)

```sql
UPDATE public.registrations SET current_stage = CASE
  WHEN current_stage = 'payment' THEN 'sale_complete'
  WHEN current_stage = 'insurance' THEN 'documents_collected'
  WHEN current_stage = 'inspection' THEN 'documents_collected'
  WHEN current_stage = 'submission' THEN 'submitted_to_dmv'
  WHEN current_stage = 'dmv_processing' THEN 'dmv_processing'
  WHEN current_stage = 'approved' THEN 'sticker_ready'
  WHEN current_stage = 'ready' THEN 'sticker_delivered'
  ELSE 'sale_complete'
END;
```

## New Roles: is_registration_admin

Grants permission to manage registrations without full admin access.

**Permissions:** INSERT, UPDATE, SELECT on registrations; SELECT on audit
**NOT permitted:** DELETE registrations (requires is_admin)

```sql
UPDATE public.profiles SET is_registration_admin = true WHERE id = 'user-uuid';
```

## Rollback

### Migration 02 Rollback

```sql
-- Drop triggers and functions
DROP TRIGGER IF EXISTS registration_audit_trigger ON public.registrations;
DROP TRIGGER IF EXISTS validate_registration_status ON public.registrations;
DROP TRIGGER IF EXISTS auto_milestone_dates ON public.registrations;
DROP FUNCTION IF EXISTS audit_registration_changes();
DROP FUNCTION IF EXISTS validate_status_transition();
DROP FUNCTION IF EXISTS auto_set_milestone_dates();

-- Drop audit table and policies
DROP TABLE IF EXISTS public.registration_audit;
DROP POLICY IF EXISTS "Registration admins can insert registrations" ON public.registrations;
DROP POLICY IF EXISTS "Registration admins can update registrations" ON public.registrations;
DROP POLICY IF EXISTS "Only admins can delete registrations" ON public.registrations;

-- Restore old admin policy
CREATE POLICY "Admins can manage registrations" ON public.registrations
  FOR ALL USING (auth.uid() IN (SELECT id FROM public.profiles WHERE is_admin = true));

-- Drop columns and role (optional, causes data loss)
ALTER TABLE public.profiles DROP COLUMN IF EXISTS is_registration_admin;
```

### Migration 03 Rollback

```sql
-- Drop trigger and function
DROP TRIGGER IF EXISTS registration_set_token_expiry ON public.registrations;
DROP FUNCTION IF EXISTS set_token_expiry_on_delivery();

-- Drop RLS policy
DROP POLICY IF EXISTS "Public can view registration by valid token" ON public.registrations;

-- Drop index
DROP INDEX IF EXISTS idx_registrations_access_token;

-- Drop columns (WARNING: loses access tokens)
ALTER TABLE public.registrations DROP COLUMN IF EXISTS access_token;
ALTER TABLE public.registrations DROP COLUMN IF EXISTS token_expires_at;
ALTER TABLE public.registrations DROP COLUMN IF EXISTS vehicle_body_type;

-- Restore old public policy (optional)
CREATE POLICY "Public can view registration by order_id" ON public.registrations
  FOR SELECT TO anon USING (true);
```

---

## Migration 03: Customer Portal Access

### What This Migration Does

Adds token-based access for customer registration tracking:

- `access_token` - 32-char hex token auto-generated at creation
- `token_expires_at` - NULL until sticker delivered, then 30 days
- `vehicle_body_type` - For customer portal car icon display

### Breaking Changes

**Public SELECT now requires valid token:**

| Before (Migration 02) | After (Migration 03) |
|----------------------|---------------------|
| Any order_id returns data | Order ID + valid token required |
| Links never expire | Links expire 30 days after delivery |

### Tracking Link Format

```
/track/{orderId}-{token}
Example: /track/TJ-2026-0001-a1b2c3d4e5f67890a1b2c3d4e5f67890
```

### Token Generation

Tokens are auto-generated by PostgreSQL `gen_random_bytes(16)` at INSERT.
No application code needed for token creation.

---

## Migration 04: Notification System

### Purpose

Notification queue with debounce, preferences, admin notify control, phone-auth RLS, and pg_cron schedule for automated queue processing. This is the database foundation for SMS/email notifications triggered by registration status changes.

### Prerequisites

- **pg_cron extension** must be enabled: Supabase Dashboard -> Database -> Extensions -> pg_cron
- **pg_net extension** must be enabled: Supabase Dashboard -> Database -> Extensions -> pg_net
- Migrations 02 and 03 must be applied first

### What This Migration Does

**Tables created:**
- `notification_queue` - Debounce queue for pending notifications with partial unique index

**Columns added to `registrations`:**
- `notification_pref` - VARCHAR(10), default `'both'`, CHECK constraint (`sms`, `email`, `both`, `none`)
- `pending_notify_customer` - BOOLEAN, admin opt-out flag for individual status changes

**Columns added to `registration_notifications`:**
- `old_stage` - VARCHAR(50), previous stage before transition
- `new_stage` - VARCHAR(50), new stage after transition
- `subject` - TEXT, email subject line
- `template_used` - VARCHAR(100), template identifier for audit
- `provider_message_id` - TEXT, Twilio SID or Resend ID for delivery tracking

**Triggers:**
- `queue_notification_on_status_change` - BEFORE UPDATE on registrations; fires when `current_stage` changes; inserts/upserts into `notification_queue` with 5-minute debounce; clears `pending_notify_customer` after capture

**RLS policies:**
- `"Customers can view own registrations by phone"` - SELECT on registrations for authenticated users where `customer_phone = auth.jwt()->>'phone'`
- `"Admins can manage notification_queue"` - ALL on notification_queue for admin users

**Cron job:**
- `process-notification-queue` - Runs every minute via pg_cron + pg_net; invokes the `process-notification-queue` Edge Function to send ready notifications

### Breaking Changes

None. This is an additive migration. All changes are new columns, new table, new trigger, and new policies. Existing functionality is unaffected.

### Configuration Required

The pg_cron schedule needs access to the Supabase project URL and service role key. Two approaches:

**Approach A: Custom PostgreSQL settings (simpler)**
```sql
ALTER DATABASE postgres SET app.settings.supabase_url = 'https://YOUR_PROJECT.supabase.co';
ALTER DATABASE postgres SET app.settings.service_role_key = 'YOUR_SERVICE_ROLE_KEY';
```

**Approach B: Supabase Vault (more secure, recommended for production)**
```sql
SELECT vault.create_secret('https://YOUR_PROJECT.supabase.co', 'project_url');
SELECT vault.create_secret('YOUR_SERVICE_ROLE_KEY', 'service_role_key');
```

### Debounce Mechanism

The `notification_queue` table uses a partial unique index `uq_pending_notification` on `(registration_id) WHERE (sent = false)`. When a status change occurs:

1. Trigger inserts a queue entry with `send_after = NOW() + 5 minutes`
2. If admin changes status again within 5 minutes, `ON CONFLICT` updates the existing entry with the new stage and resets `send_after`
3. pg_cron picks up ready items (`send_after <= NOW() AND sent = false`) every minute

This ensures only the final status is notified after rapid admin corrections.

### Migration 04 Rollback

```sql
-- Remove cron schedule
SELECT cron.unschedule('process-notification-queue');

-- Drop trigger and function
DROP TRIGGER IF EXISTS queue_notification_on_status_change ON public.registrations;
DROP FUNCTION IF EXISTS queue_status_notification();

-- Drop RLS policies
DROP POLICY IF EXISTS "Customers can view own registrations by phone" ON public.registrations;
DROP POLICY IF EXISTS "Admins can manage notification_queue" ON public.notification_queue;

-- Drop notification queue table
DROP TABLE IF EXISTS public.notification_queue;

-- Drop columns from registrations
ALTER TABLE public.registrations DROP COLUMN IF EXISTS notification_pref;
ALTER TABLE public.registrations DROP COLUMN IF EXISTS pending_notify_customer;

-- Drop columns from registration_notifications
ALTER TABLE public.registration_notifications DROP COLUMN IF EXISTS old_stage;
ALTER TABLE public.registration_notifications DROP COLUMN IF EXISTS new_stage;
ALTER TABLE public.registration_notifications DROP COLUMN IF EXISTS subject;
ALTER TABLE public.registration_notifications DROP COLUMN IF EXISTS template_used;
ALTER TABLE public.registration_notifications DROP COLUMN IF EXISTS provider_message_id;
```
