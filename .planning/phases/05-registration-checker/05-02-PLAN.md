---
phase: 05-registration-checker
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - triple-j-auto-investment-main/components/admin/RegistrationChecker.tsx
  - triple-j-auto-investment-main/pages/admin/Registrations.tsx
autonomous: true

must_haves:
  truths:
    - "Admin sees a Pre-Submission Checker section in the expanded registration row"
    - "Checker shows pass/fail status for all 5 required documents"
    - "System flags if VIN fails format or check digit validation"
    - "Admin can confirm VIN matches each physical document via per-document checkboxes"
    - "Admin can confirm mileage matches on 130-U and Inspection documents"
    - "SURRENDERED stamp has two separate checkboxes (front and back), both required"
    - "Document ordering guide shows the 5 documents in correct webDEALER submission order with tips"
    - "webDEALER link appears only after all checks pass or admin overrides"
    - "Override requires confirmation dialog and is logged"
    - "Checker results persist between sessions and are loaded from DB on expand"
    - "Checker results are cleared when VIN or mileage changes (shown as needing re-check)"
  artifacts:
    - path: "triple-j-auto-investment-main/components/admin/RegistrationChecker.tsx"
      provides: "Complete Registration Checker UI component"
      min_lines: 200
    - path: "triple-j-auto-investment-main/pages/admin/Registrations.tsx"
      provides: "Integration of RegistrationChecker into expanded registration row"
      contains: "RegistrationChecker"
  key_links:
    - from: "components/admin/RegistrationChecker.tsx"
      to: "services/registrationService.ts"
      via: "saveCheckerResults, saveCheckerOverride calls"
      pattern: "saveCheckerResults|saveCheckerOverride"
    - from: "components/admin/RegistrationChecker.tsx"
      to: "utils/vinValidator.ts"
      via: "validateVinFormat, validateVinCheckDigit imports"
      pattern: "validateVinFormat|validateVinCheckDigit"
    - from: "components/admin/RegistrationChecker.tsx"
      to: "types.ts"
      via: "Registration, CheckerResult type imports"
      pattern: "CheckerResult"
    - from: "pages/admin/Registrations.tsx"
      to: "components/admin/RegistrationChecker.tsx"
      via: "Import and render in expanded row"
      pattern: "RegistrationChecker"
---

<objective>
Build the Registration Checker UI component and integrate it into the admin Registrations page. This is the core user-facing feature of Phase 5.

Purpose: Admin needs to validate documents before submitting to webDEALER to prevent DMV rejections. The checker verifies document completeness, VIN consistency (format + check digit + cross-document), mileage consistency, SURRENDERED stamp presence, shows document ordering guide, and provides a webDEALER link when all checks pass or are overridden.

Output: RegistrationChecker.tsx component, updated Registrations.tsx with checker integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-registration-checker/05-CONTEXT.md
@.planning/phases/05-registration-checker/05-RESEARCH.md
@.planning/phases/05-registration-checker/05-01-SUMMARY.md

Key source files:
@triple-j-auto-investment-main/types.ts
@triple-j-auto-investment-main/services/registrationService.ts
@triple-j-auto-investment-main/utils/vinValidator.ts
@triple-j-auto-investment-main/pages/admin/Registrations.tsx
@triple-j-auto-investment-main/components/admin/
</context>

<tasks>

<task type="auto">
  <name>Task 1: RegistrationChecker Component</name>
  <files>
    triple-j-auto-investment-main/components/admin/RegistrationChecker.tsx
  </files>
  <action>
Create `components/admin/RegistrationChecker.tsx` -- a self-contained checker panel that receives a Registration and handles its own state.

**Props interface:**
```typescript
interface RegistrationCheckerProps {
  registration: Registration;
  onRefresh: () => void;  // Called after saving results so parent can reload data
}
```

**Component structure (collapsible section):**

The checker renders as a collapsible section with a header that shows overall status (all pass / N issues / needs re-check). Use the same section styling pattern as the Document Checklist and Stage Progress sections in Registrations.tsx: `<div className="mb-6 pb-6 border-b border-gray-800">` with `<h4 className="text-white text-sm uppercase tracking-widest mb-4">`.

**Section header:** "Pre-Submission Checker" with a summary badge:
- All checks pass: green badge "ALL CLEAR"
- Some checks fail: amber badge "N ISSUES"
- No results yet / invalidated: gray badge "NOT CHECKED"
- Overridden: amber badge "OVERRIDDEN"

**Internal state:**
- `checkerState: CheckerResult` -- Initialize from `registration.checkerResults` if present, otherwise default all booleans to false and Records to empty objects `{}`
- `saving: boolean` -- Loading state for save operations
- `showOverrideConfirm: boolean` -- Override confirmation dialog visibility
- `isExpanded: boolean` -- Whether the checker details are expanded (default: true if no results exist, false if results exist)

**Section 1: Mileage Entry (pre-fill + confirm pattern)**

If `registration.mileage` is null/undefined, show a mileage input field:
- Label: "Odometer Reading"
- Input: `type="number"` with min=0, placeholder "Enter mileage from documents"
- Save button that calls `updateRegistrationMileage(registration.id, value)` then `onRefresh()`
- Info text: "Enter the odometer reading from the documents. This will be used for cross-document consistency checks."

If `registration.mileage` exists, show the value as a pre-filled display: "Odometer: {mileage} mi" with a small edit pencil icon to allow correction.

**Section 2: Document Completeness Check (REGC-01)**

Read the 5 document booleans directly from `registration` (docTitleFront, docTitleBack, doc130u, docInsurance, docInspection). These are NOT part of checkerState -- they come from the existing Document Checklist toggles above.

Display as a summary row:
- Icon: CheckCircle (green) if all 5 are true, AlertCircle (amber) if any false
- Text: "All documents received" or "Missing: Title (Front), 130-U, ..." listing which are false
- This is read-only in the checker (the Document Checklist section above handles toggling)

Update `checkerState.docComplete` automatically: `true` if all 5 booleans are true.

**Section 3: VIN Validation (REGC-02)**

Display the VIN from `registration.vin` prominently.

Run `validateVinFormat(registration.vin)` and `validateVinCheckDigit(registration.vin)` automatically.

Show results:
- Format check: pass/fail with error message if failed
- Check digit: pass/fail (show "Check digit valid" or "Check digit mismatch - verify VIN is correct")

Update `checkerState.vinFormatValid` automatically: true if both format and check digit pass.

**VIN Cross-Document Confirmation (REGC-02 continued):**

Show the pre-filled VIN value and 5 confirmation checkboxes (one per document):
1. "VIN matches Title (Front)" -- checkbox
2. "VIN matches Title (Back)" -- checkbox
3. "VIN matches Form 130-U" -- checkbox
4. "VIN matches Inspection (VIR)" -- checkbox
5. "VIN matches Insurance Proof" -- checkbox

Each checkbox updates `checkerState.vinConfirmedOnDocs[docKey]` where docKeys are: `title_front`, `title_back`, `form_130u`, `inspection`, `insurance`.

A "Confirm All Match" convenience button that checks all 5 at once.

**Section 4: Mileage Cross-Document Confirmation (REGC-03)**

Only show if `registration.mileage` is set. Display the pre-filled mileage value.

Show 2 confirmation checkboxes (only documents that have mileage per research):
1. "Mileage matches Form 130-U (Box 9)" -- checkbox
2. "Mileage matches Inspection (VIR)" -- checkbox

Each updates `checkerState.mileageConfirmedOnDocs[docKey]` where docKeys are: `form_130u`, `inspection`.

If mileage is not set, show info message: "Set odometer reading above to enable mileage consistency checks."

**Section 5: SURRENDERED Stamp Verification (REGC-04)**

Two separate checkboxes (NOT a single checkbox):
1. "SURRENDERED stamp verified on Title FRONT" -- updates `checkerState.surrenderedFront`
2. "SURRENDERED stamp verified on Title BACK" -- updates `checkerState.surrenderedBack`

Info text below: "Both sides of the title must be stamped SURRENDERED before submission. Verify against the original document, not a copy."

**Section 6: Document Ordering Guide (REGC-05)**

A numbered list showing the correct webDEALER submission order. Use this hardcoded data:

```typescript
const WEBDEALER_DOCUMENT_ORDER = [
  { order: 1, name: 'Title (Front)', tip: 'Verify SURRENDERED stamp is clearly visible. Must be original, not a copy.' },
  { order: 2, name: 'Title (Back)', tip: 'Verify SURRENDERED stamp on back. Check all assignment fields are properly signed.' },
  { order: 3, name: 'Form 130-U', tip: 'Verify VIN in Box 1 and Odometer in Box 9. Confirm applicant info matches buyer.' },
  { order: 4, name: 'Vehicle Inspection Report (VIR)', tip: 'Inspection must be current on submission date. Verify VIN matches.' },
  { order: 5, name: 'Proof of Insurance', tip: 'Verify policy is active and VIN matches. Must show liability coverage.' },
];
```

Render as a compact numbered list with document name in bold and tip in gray smaller text. Use Lucide `FileText` icon per item.

**Section 7: Summary + Actions**

Compute `allChecksPassed`:
- `checkerState.docComplete === true`
- `checkerState.vinFormatValid === true`
- All 5 entries in `checkerState.vinConfirmedOnDocs` are true
- All 2 entries in `checkerState.mileageConfirmedOnDocs` are true (if mileage is set)
- `checkerState.surrenderedFront === true`
- `checkerState.surrenderedBack === true`

Compute `failedChecks` count for the badge.

**Save button:** "Save Check Results" -- calls `saveCheckerResults(registration.id, checkerState, allChecksPassed)` then `onRefresh()`. Only enabled when checkerState has changed from what was loaded.

**Override flow (REGC-06 / CONTEXT.md):**
If NOT allChecksPassed, show an "Override and Proceed" button (amber/warning styled). Clicking opens a simple confirmation dialog: "Are you sure? {N} checks have not passed. Override allows submission but issues may cause DMV rejection." with Cancel/Confirm Override buttons.

On confirm: call `saveCheckerOverride(registration.id)` then `onRefresh()`.

**webDEALER Link (REGC-06):**
Only render when `allChecksPassed || registration.checkerOverride`:

```tsx
<a
  href="https://webdealer.txdmv.gov/title/login.do"
  target="_blank"
  rel="noopener noreferrer"
  className="flex items-center gap-2 px-6 py-3 bg-tj-gold text-black font-bold text-sm tracking-wider hover:bg-white transition-colors mt-4"
>
  <ExternalLink size={16} />
  Open webDEALER
</a>
```

**Styling:**
- Follow existing Registrations.tsx patterns: dark background, gray-800 borders, tj-gold accents
- Pass indicators: green (Check icon + green text) for pass, amber (AlertCircle + amber text) for fail, gray for unchecked
- Checkboxes: Use the same toggle button pattern as Document Checklist (border-green-500/50 bg-green-900/20 when checked, border-gray-700 text-gray-500 when unchecked)
- Use Lucide icons: Check, Circle, CheckCircle, AlertCircle, ExternalLink, FileText, Shield, ClipboardCheck, Edit (for mileage edit)

**Icons to import from lucide-react:** Check, Circle, CheckCircle, AlertCircle, ExternalLink, FileText, Shield, ClipboardCheck, ChevronDown, ChevronRight, Pencil (or Edit3)
  </action>
  <verify>
    - File exists at triple-j-auto-investment-main/components/admin/RegistrationChecker.tsx
    - Component imports Registration, CheckerResult from types.ts
    - Component imports validateVinFormat, validateVinCheckDigit from utils/vinValidator.ts
    - Component imports saveCheckerResults, saveCheckerOverride, updateRegistrationMileage from registrationService.ts
    - Component renders 7 sections: mileage entry, doc completeness, VIN validation, mileage confirmation, SURRENDERED stamp, document order guide, summary+actions
    - webDEALER link href is "https://webdealer.txdmv.gov/title/login.do" with target="_blank"
    - SURRENDERED stamp has exactly 2 separate checkboxes (front + back)
    - Override confirmation dialog exists
    - `npm run build` passes
  </verify>
  <done>
    RegistrationChecker component renders all 6 REGC requirements: document completeness check (REGC-01), VIN validation + cross-document confirmation (REGC-02), mileage consistency confirmation (REGC-03), SURRENDERED stamp double checkbox (REGC-04), document ordering guide with tips (REGC-05), and webDEALER link gated behind all-pass or override (REGC-06).
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate Checker into Registrations Page</name>
  <files>
    triple-j-auto-investment-main/pages/admin/Registrations.tsx
  </files>
  <action>
Integrate the RegistrationChecker component into the expanded registration row in Registrations.tsx.

**Import:**
Add import at the top of Registrations.tsx:
```typescript
import RegistrationChecker from '../../components/admin/RegistrationChecker';
```

**Placement in expanded row:**
In the JSX where the expanded registration card renders (the section inside `{expandedId === reg.id && (...)}` around line 490-733), add the RegistrationChecker component BETWEEN the "Document Checklist" section (ends around line 587) and the "Stage Progress" section (starts around line 589).

Insert:
```tsx
{/* Pre-Submission Checker */}
<RegistrationChecker
  registration={reg}
  onRefresh={loadRegistrations}
/>
```

This goes right after the Document Checklist `</div>` (closing the `mb-6 pb-6 border-b border-gray-800` div) and right before the `<h4>Registration Progress</h4>` heading.

**No other changes needed to Registrations.tsx.** The checker is self-contained -- it manages its own state, calls its own service functions, and triggers a refresh via `onRefresh` when results are saved. The parent just provides the registration data and a refresh callback.

**Verify the integration doesn't break existing functionality:**
- Search, filter, expand/collapse still work
- Document Checklist toggles still work (checker reads from them but doesn't modify)
- Stage progression buttons still work
- Audit history and notification history modals still work
- Create registration modal still works
  </action>
  <verify>
    - Registrations.tsx imports RegistrationChecker from components/admin/RegistrationChecker
    - RegistrationChecker renders between Document Checklist and Stage Progress sections
    - RegistrationChecker receives `registration={reg}` and `onRefresh={loadRegistrations}` props
    - `npm run build` passes
    - No other functional changes to Registrations.tsx (only the import line and the component insertion)
  </verify>
  <done>
    RegistrationChecker is integrated into the admin registration expanded view. Admin sees the checker inline with each registration, positioned after document toggles and before stage progress. The checker is self-contained and does not modify any existing Registrations.tsx functionality.
  </done>
</task>

</tasks>

<verification>
1. RegistrationChecker.tsx exists in components/admin/ with all 7 sections
2. Registrations.tsx renders RegistrationChecker in expanded row between Document Checklist and Stage Progress
3. Checker loads persisted results from registration.checkerResults on mount
4. VIN format + check digit validation runs automatically on the registration's VIN
5. SURRENDERED stamp has 2 separate checkboxes (front and back)
6. Document ordering guide shows 5 documents in correct order with tips
7. webDEALER link (https://webdealer.txdmv.gov/title/login.do) only appears when all checks pass or override confirmed
8. Override requires confirmation dialog
9. Build passes
</verification>

<success_criteria>
- Admin sees "Pre-Submission Checker" section in expanded registration with pass/fail indicators
- VIN validation catches format errors AND check digit mismatches
- Admin confirms VIN matches on all 5 documents via individual checkboxes
- Admin confirms mileage matches on 130-U and Inspection via checkboxes
- SURRENDERED stamp requires confirming BOTH front and back (two separate checkboxes)
- Document order guide shows 5 documents in webDEALER submission order with helpful tips
- webDEALER link opens https://webdealer.txdmv.gov/title/login.do in new tab ONLY after all checks pass or override
- Override shows "Are you sure?" confirmation with failed check count
- Results persist to DB and reload on next visit
- Results auto-clear when VIN or mileage changes (DB trigger from Plan 01)
</success_criteria>

<output>
After completion, create `.planning/phases/05-registration-checker/05-02-SUMMARY.md`
</output>
