---
phase: 05-registration-checker
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - triple-j-auto-investment-main/supabase/migrations/05_registration_checker.sql
  - triple-j-auto-investment-main/utils/vinValidator.ts
  - triple-j-auto-investment-main/types.ts
  - triple-j-auto-investment-main/services/registrationService.ts
autonomous: true

must_haves:
  truths:
    - "Registration record can store mileage value"
    - "Registration record can store checker results as structured JSON"
    - "Checker results are automatically cleared when VIN or mileage changes on the record"
    - "VIN check digit validation catches invalid VINs that pass format checks"
    - "Registration interface includes mileage and checker fields in TypeScript"
    - "Service layer can persist and retrieve checker results"
  artifacts:
    - path: "triple-j-auto-investment-main/supabase/migrations/05_registration_checker.sql"
      provides: "Schema migration adding mileage, checker_results, checker_completed_at, checker_override, checker_override_at columns plus invalidation trigger"
      contains: "checker_results JSONB"
    - path: "triple-j-auto-investment-main/utils/vinValidator.ts"
      provides: "VIN format validation and ISO 3779 check digit validation"
      exports: ["validateVinFormat", "validateVinCheckDigit"]
      min_lines: 40
    - path: "triple-j-auto-investment-main/types.ts"
      provides: "CheckerResult interface and updated Registration interface with mileage + checker fields"
      contains: "CheckerResult"
    - path: "triple-j-auto-investment-main/services/registrationService.ts"
      provides: "saveCheckerResults, updateRegistrationMileage functions and updated transformer"
      exports: ["saveCheckerResults", "updateRegistrationMileage"]
  key_links:
    - from: "types.ts"
      to: "services/registrationService.ts"
      via: "CheckerResult type used in service functions"
      pattern: "CheckerResult"
    - from: "services/registrationService.ts"
      to: "supabase registrations table"
      via: "checker_results JSONB column read/write"
      pattern: "checker_results"
    - from: "utils/vinValidator.ts"
      to: "standalone utility"
      via: "Pure functions, no external dependencies"
      pattern: "validateVinCheckDigit"
---

<objective>
Add the database schema, VIN validation utility, TypeScript types, and service layer functions needed for the Registration Checker feature.

Purpose: The Registration Checker (Plan 02) needs a mileage field, persistent checker state in the DB, VIN check digit validation, and service functions to read/write checker results. This plan creates all foundational artifacts.

Output: Migration SQL file, VIN validator utility, updated types.ts with CheckerResult interface, updated registrationService.ts with checker persistence functions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-registration-checker/05-CONTEXT.md
@.planning/phases/05-registration-checker/05-RESEARCH.md

Key source files:
@triple-j-auto-investment-main/types.ts
@triple-j-auto-investment-main/services/registrationService.ts
@triple-j-auto-investment-main/supabase/migrations/04_notification_system.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database Migration and VIN Validator Utility</name>
  <files>
    triple-j-auto-investment-main/supabase/migrations/05_registration_checker.sql
    triple-j-auto-investment-main/utils/vinValidator.ts
  </files>
  <action>
**Migration (05_registration_checker.sql):**

Create migration file following the pattern established in 04_notification_system.sql (header comment with phase/plan/purpose/depends-on, section comments).

Add these columns to the `registrations` table:
- `mileage INTEGER` -- Odometer reading for cross-document consistency checks
- `checker_results JSONB DEFAULT NULL` -- Persistent checker state (see CheckerResult interface in Task 2)
- `checker_completed_at TIMESTAMPTZ DEFAULT NULL` -- When checker was last fully completed
- `checker_override BOOLEAN DEFAULT FALSE` -- Whether admin overrode failed checks
- `checker_override_at TIMESTAMPTZ DEFAULT NULL` -- When override happened

Use `ALTER TABLE public.registrations ADD COLUMN IF NOT EXISTS` for each column.

Create a trigger function `invalidate_checker_on_data_change()` that:
1. Fires BEFORE UPDATE on registrations
2. Checks if `OLD.vin IS DISTINCT FROM NEW.vin OR OLD.mileage IS DISTINCT FROM NEW.mileage`
3. If either changed, sets `NEW.checker_results = NULL`, `NEW.checker_completed_at = NULL`, `NEW.checker_override = FALSE`, `NEW.checker_override_at = NULL`
4. Returns NEW

Create the trigger: `CREATE TRIGGER trg_invalidate_checker BEFORE UPDATE ON public.registrations FOR EACH ROW EXECUTE FUNCTION invalidate_checker_on_data_change();`

Use `CREATE OR REPLACE FUNCTION` and `DROP TRIGGER IF EXISTS ... ; CREATE TRIGGER ...` pattern for idempotency.

Depends on: 02_registration_schema_update.sql

**VIN Validator (utils/vinValidator.ts):**

Create a new utility file with two exported functions:

1. `validateVinFormat(vin: string): { valid: boolean; error?: string }` -- Checks:
   - Not empty (error: 'VIN is required')
   - Uppercase, alphanumeric only (error: 'VIN must be alphanumeric only')
   - No I, O, Q characters (error: 'VIN contains invalid character(s): ...')
   - Exactly 17 characters (error: 'VIN must be 17 characters (got N)')
   - Returns `{ valid: true }` on success

2. `validateVinCheckDigit(vin: string): boolean` -- Implements ISO 3779 check digit algorithm:
   - VIN_TRANSLITERATION map: A=1, B=2, C=3, D=4, E=5, F=6, G=7, H=8, J=1, K=2, L=3, M=4, N=5, P=7, R=9, S=2, T=3, U=4, V=5, W=6, X=7, Y=8, Z=9, and 0-9 = their numeric values
   - VIN_WEIGHTS array: [8, 7, 6, 5, 4, 3, 2, 10, 0, 9, 8, 7, 6, 5, 4, 3, 2]
   - For each of 17 positions: sum += transliteration[char] * weight[position]
   - remainder = sum % 11
   - Check digit (position 9, index 8) should be remainder (or 'X' if remainder is 10)
   - Returns true if valid, false otherwise

Use the exact transliteration table and weights from the research document. The code example in 05-RESEARCH.md is verified and can be used directly.
  </action>
  <verify>
    - File triple-j-auto-investment-main/supabase/migrations/05_registration_checker.sql exists with ALTER TABLE statements for all 5 columns
    - File contains trigger function `invalidate_checker_on_data_change` and trigger `trg_invalidate_checker`
    - File triple-j-auto-investment-main/utils/vinValidator.ts exists with both exported functions
    - `validateVinFormat('1HGBH41JXMN109186')` returns `{ valid: true }` (valid VIN format)
    - `validateVinFormat('IOQ')` returns error about invalid characters
    - `validateVinCheckDigit('11111111111111111')` returns true (all 1s has check digit 1)
    - `npx tsc --noEmit` passes for vinValidator.ts (or build check)
  </verify>
  <done>
    Migration SQL creates mileage + checker columns with invalidation trigger. VIN validator utility exports validateVinFormat and validateVinCheckDigit with correct ISO 3779 algorithm.
  </done>
</task>

<task type="auto">
  <name>Task 2: TypeScript Types and Service Layer Updates</name>
  <files>
    triple-j-auto-investment-main/types.ts
    triple-j-auto-investment-main/services/registrationService.ts
  </files>
  <action>
**Types (types.ts):**

Add a `CheckerResult` interface in the REGISTRATION STATUS LEDGER TYPES section:

```typescript
export interface CheckerResult {
  docComplete: boolean;        // All 5 documents marked as received
  vinFormatValid: boolean;     // VIN passes format + check digit validation
  vinConfirmedOnDocs: Record<string, boolean>; // Admin confirmed VIN matches each doc: { 'title_front': true, 'title_back': false, ... }
  mileageConfirmedOnDocs: Record<string, boolean>; // Admin confirmed mileage matches each doc (only docs with mileage: '130u', 'inspection')
  surrenderedFront: boolean;   // Admin confirmed SURRENDERED stamp on title front
  surrenderedBack: boolean;    // Admin confirmed SURRENDERED stamp on title back
}
```

Extend the `Registration` interface with these new fields (add after `notificationPref`):

```typescript
  // Mileage (for checker cross-document validation)
  mileage?: number;

  // Checker state
  checkerResults?: CheckerResult | null;
  checkerCompletedAt?: string;
  checkerOverride: boolean;
  checkerOverrideAt?: string;
```

**Service Layer (registrationService.ts):**

1. Update `transformRegistration` to map the new fields:
   - `mileage: data.mileage ?? null` (after vin/vehicleYear/vehicleMake/vehicleModel)
   - `checkerResults: data.checker_results ?? null` (after notificationPref)
   - `checkerCompletedAt: data.checker_completed_at`
   - `checkerOverride: data.checker_override ?? false`
   - `checkerOverrideAt: data.checker_override_at`

2. Add `saveCheckerResults` function:
```typescript
export async function saveCheckerResults(
  registrationId: string,
  results: CheckerResult,
  allPassed: boolean
): Promise<boolean>
```
   - Updates `checker_results` (the JSONB column) with the results object
   - Sets `checker_completed_at` to `new Date().toISOString()` if `allPassed` is true, otherwise null
   - Sets `checker_override` to false, `checker_override_at` to null (saving fresh results clears any prior override)
   - Sets `pending_change_reason` to 'Checker results updated'
   - Uses the same error handling pattern as other update functions in the service

3. Add `saveCheckerOverride` function:
```typescript
export async function saveCheckerOverride(
  registrationId: string
): Promise<boolean>
```
   - Updates `checker_override` to true
   - Sets `checker_override_at` to `new Date().toISOString()`
   - Sets `pending_change_reason` to 'Checker override confirmed'

4. Add `updateRegistrationMileage` function:
```typescript
export async function updateRegistrationMileage(
  registrationId: string,
  mileage: number,
  changeReason?: string
): Promise<boolean>
```
   - Updates the `mileage` column
   - Sets `pending_change_reason` to changeReason or 'Mileage updated'
   - Note: The DB trigger will automatically clear checker_results when mileage changes

5. Import `CheckerResult` from types.ts at the top of registrationService.ts (add to existing import).

6. Update `createRegistration` to accept optional `mileage` in the input parameter and map it to the `mileage` DB column in the insert.
  </action>
  <verify>
    - types.ts contains `CheckerResult` interface with all 6 fields (docComplete, vinFormatValid, vinConfirmedOnDocs, mileageConfirmedOnDocs, surrenderedFront, surrenderedBack)
    - Registration interface has mileage, checkerResults, checkerCompletedAt, checkerOverride, checkerOverrideAt fields
    - registrationService.ts transformer maps all 5 new DB columns
    - registrationService.ts exports saveCheckerResults, saveCheckerOverride, updateRegistrationMileage
    - `npm run build` passes (or `npx tsc --noEmit` if build script unavailable)
  </verify>
  <done>
    CheckerResult interface defined. Registration interface extended with mileage + checker fields. Service layer has saveCheckerResults, saveCheckerOverride, and updateRegistrationMileage functions. Transformer maps all new DB columns.
  </done>
</task>

</tasks>

<verification>
1. Migration file exists at triple-j-auto-investment-main/supabase/migrations/05_registration_checker.sql
2. VIN validator exists at triple-j-auto-investment-main/utils/vinValidator.ts with two exported functions
3. types.ts has CheckerResult interface and Registration has mileage + checker fields
4. registrationService.ts has 3 new exported functions + updated transformer
5. Build passes (npx tsc --noEmit or npm run build)
</verification>

<success_criteria>
- Database migration adds mileage INTEGER, checker_results JSONB, checker_completed_at, checker_override, checker_override_at columns to registrations
- DB trigger automatically nullifies checker_results when vin or mileage change
- VIN validator correctly implements ISO 3779 check digit algorithm
- TypeScript types and service layer fully support reading/writing checker state
- Build compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-registration-checker/05-01-SUMMARY.md`
</output>
