---
phase: 04-customer-portal-notifications-login
plan: 04
type: execute
wave: 3
depends_on: ["04-03"]
files_modified:
  - triple-j-auto-investment-main/pages/CustomerLogin.tsx
  - triple-j-auto-investment-main/pages/CustomerDashboard.tsx
  - triple-j-auto-investment-main/components/NotificationPreferences.tsx
  - triple-j-auto-investment-main/pages/CustomerStatusTracker.tsx
  - triple-j-auto-investment-main/index.tsx
autonomous: false

must_haves:
  truths:
    - "Customer can enter phone number and receive OTP via SMS"
    - "Customer can verify OTP code and see their registrations"
    - "Logged-in dashboard shows active registrations on top, completed in collapsible section"
    - "Customer can change notification preferences from tracker page and dashboard"
    - "Token link access and phone login coexist - both paths work"
    - "CustomerStatusTracker shows login link for returning customers"
    - "Session persists across page refresh (7-day Supabase default)"
    - "Routes /login and /dashboard are registered in the app router"
  artifacts:
    - path: "triple-j-auto-investment-main/pages/CustomerLogin.tsx"
      provides: "Phone OTP login page with phone input and code verification"
      contains: "signInWithOtp"
    - path: "triple-j-auto-investment-main/pages/CustomerDashboard.tsx"
      provides: "Logged-in view showing all registrations for authenticated phone number"
      contains: "CustomerDashboard"
    - path: "triple-j-auto-investment-main/components/NotificationPreferences.tsx"
      provides: "Reusable preference toggle component (SMS/Email/Both/None)"
      exports: ["NotificationPreferences"]
    - path: "triple-j-auto-investment-main/pages/CustomerStatusTracker.tsx"
      provides: "Updated tracker with notification preference toggle and login link"
      contains: "NotificationPreferences"
    - path: "triple-j-auto-investment-main/index.tsx"
      provides: "Route definitions for /login and /dashboard"
      contains: "CustomerLogin"
  key_links:
    - from: "pages/CustomerLogin.tsx"
      to: "supabase.auth.signInWithOtp"
      via: "supabase client phone OTP"
      pattern: "signInWithOtp.*phone"
    - from: "pages/CustomerLogin.tsx"
      to: "supabase.auth.verifyOtp"
      via: "supabase client OTP verification"
      pattern: "verifyOtp.*phone.*token"
    - from: "pages/CustomerDashboard.tsx"
      to: "registrations table via RLS"
      via: "supabase.from('registrations').select() with auth session"
      pattern: "from.*registrations.*select"
    - from: "pages/CustomerStatusTracker.tsx"
      to: "components/NotificationPreferences.tsx"
      via: "import and render"
      pattern: "NotificationPreferences"
    - from: "pages/CustomerDashboard.tsx"
      to: "/track/:accessKey route"
      via: "Link to individual registration detail"
      pattern: "track/.*accessToken"
---

<objective>
Build the customer-facing login flow, dashboard, and notification preferences: phone OTP login page, multi-registration dashboard for authenticated customers, reusable notification preference toggle, updates to the existing tracker page, and route registration.

Purpose: Returning customers can log in via phone OTP to see all their registrations in one place, and all customers can manage their notification preferences. This completes PORT-05 (customer login) and the preference management aspect of PORT-06.

Output: 3 new pages/components, 1 updated page, 1 updated router file.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-customer-portal-notifications-login/04-CONTEXT.md
@.planning/phases/04-customer-portal-notifications-login/04-RESEARCH.md
@.planning/phases/04-customer-portal-notifications-login/04-03-SUMMARY.md

Key source files:
@triple-j-auto-investment-main/pages/CustomerStatusTracker.tsx (existing tracker, needs login link + preferences)
@triple-j-auto-investment-main/index.tsx (router configuration)
@triple-j-auto-investment-main/supabase/config.ts (supabase client)
@triple-j-auto-investment-main/lib/auth.ts (existing admin auth patterns)
@triple-j-auto-investment-main/services/notificationService.ts (from Plan 03: updateNotificationPreference)
@triple-j-auto-investment-main/utils/phone.ts (from Plan 03: normalizePhone)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CustomerLogin page and NotificationPreferences component</name>
  <files>
    triple-j-auto-investment-main/pages/CustomerLogin.tsx
    triple-j-auto-investment-main/components/NotificationPreferences.tsx
  </files>
  <action>
**CustomerLogin.tsx:**

Create a customer phone OTP login page. Follow the app's design patterns (dark theme, gold accents, font-display for headings, Tailwind classes matching existing pages like CustomerStatusTracker).

Two-step flow with state machine:

Step 1 - Phone Input:
- Header: "Track Your Registrations" with sub-text: "Enter your phone number to view all your registrations with Triple J Auto Investment."
- Phone input field with country code prefix (+1) shown as label
- Input accepts (XXX) XXX-XXXX, XXX-XXX-XXXX, or plain 10 digits
- "Send Code" button (gold/tj-gold bg, black text, like other CTAs)
- Loading state while sending
- Error display for invalid phone or rate limit
- Import `normalizePhone` from `../utils/phone` and normalize before calling signInWithOtp

Supabase OTP call:
```typescript
import { supabase } from '../supabase/config';
import { normalizePhone } from '../utils/phone';

const handleSendCode = async () => {
  setLoading(true);
  setError(null);
  const normalized = normalizePhone(phone);
  const { error } = await supabase.auth.signInWithOtp({ phone: normalized });
  if (error) {
    setError(error.message);
    setLoading(false);
  } else {
    setNormalizedPhone(normalized);
    setStep('verify');
    setLoading(false);
  }
};
```

Step 2 - Code Verification:
- "Enter the 6-digit code sent to {formatted phone}"
- 6 individual digit inputs (each input maxLength=1, auto-advance on input) OR a single 6-character input field. Use a single input for simplicity.
- "Verify" button
- "Resend code" link (with 60-second cooldown timer)
- "Use a different number" link (goes back to step 1)

Verify call:
```typescript
const handleVerify = async () => {
  setLoading(true);
  setError(null);
  const { data, error } = await supabase.auth.verifyOtp({
    phone: normalizedPhone,
    token: code,
    type: 'sms',
  });
  if (error) {
    setError(error.message);
    setLoading(false);
  } else {
    // Success - navigate to dashboard
    navigate('/dashboard');
  }
};
```

Use `useNavigate` from react-router-dom. Import `useState` from React.

Bottom of page: "Have a tracking link? Use it directly" with a text input and go button (links to /track/:accessKey). This bridges the two access methods.

Match the visual style of CustomerStatusTracker: centered content, max-w-md on mobile, dark bg, gold accents, font-display headings.

**NotificationPreferences.tsx:**

Create a reusable component for notification preference management.

Props:
```typescript
interface NotificationPreferencesProps {
  registrationId: string;
  currentPreference: 'sms' | 'email' | 'both' | 'none';
  onUpdate?: (newPref: 'sms' | 'email' | 'both' | 'none') => void;
  compact?: boolean; // true for tracker page (gear icon toggle), false for dashboard (full settings)
}
```

Compact mode (for tracker page):
- Gear icon button that opens a small dropdown/popover
- Four options: SMS, Email, Both, None
- Current selection highlighted
- Selecting updates immediately via `updateNotificationPreference` from notificationService
- Shows brief toast/feedback: "Preferences updated"
- Note below: "You'll still receive verification codes when logging in."

Full mode (for dashboard):
- Section header: "Notification Preferences"
- Four toggle buttons in a row: SMS | Email | Both | None
- Active button styled gold, inactive gray
- Same immediate update behavior
- Same auth OTP note

Import `updateNotificationPreference` from `../services/notificationService`.
Import `NotificationPreference` type from `../types`.

Use `useState` for local pref state, initialize from `currentPreference` prop. On change, optimistically update local state, call service, revert on failure.
  </action>
  <verify>
    - `pages/CustomerLogin.tsx` exists with phone input and OTP verification steps
    - CustomerLogin imports supabase and calls signInWithOtp/verifyOtp
    - CustomerLogin uses normalizePhone before OTP call
    - CustomerLogin navigates to /dashboard on success
    - `components/NotificationPreferences.tsx` exists with compact and full modes
    - NotificationPreferences calls updateNotificationPreference on selection
    - `npm run build` passes
  </verify>
  <done>CustomerLogin page has two-step phone OTP flow (send code, verify) with proper Supabase auth integration. NotificationPreferences component supports compact (gear icon) and full (toggle buttons) modes with immediate preference updates.</done>
</task>

<task type="auto">
  <name>Task 2: Create CustomerDashboard and update tracker + routes</name>
  <files>
    triple-j-auto-investment-main/pages/CustomerDashboard.tsx
    triple-j-auto-investment-main/pages/CustomerStatusTracker.tsx
    triple-j-auto-investment-main/index.tsx
  </files>
  <action>
**CustomerDashboard.tsx:**

Create the logged-in customer dashboard. This page is only accessible to authenticated (phone OTP) users.

On mount:
1. Check for auth session: `supabase.auth.getSession()`
2. If no session, redirect to /login via `navigate('/login')`
3. If session exists, fetch registrations. The RLS policy (from Plan 01) filters by `customer_phone = auth.jwt()->>'phone'`, so a simple SELECT returns only this customer's registrations:
```typescript
const { data, error } = await supabase
  .from('registrations')
  .select('*')
  .eq('is_archived', false)
  .order('created_at', { ascending: false });
```
4. Transform results using a local transform function (same mapping as registrationService.transformRegistration, but since transformRegistration is not exported as a standalone, either export it or duplicate the mapping here). Actually, check if `transformRegistration` is exported from registrationService.ts -- it's a `const` not exported. For this plan, import and use `supabase` directly with the raw query, then map the fields inline. This avoids modifying registrationService.ts exports.

Actually, a cleaner approach: create a new service function in registrationService.ts that is already exported. Check if `getRegistrationsByStage` or similar exists that we can reuse. Per the research, registrationService.ts has query helpers. BUT those use admin-level access. For the customer dashboard, we rely on RLS to filter. So just query directly from the component and do the field mapping.

Layout (per CONTEXT.md: "active registrations prominently on top, completed in collapsible history section below"):

Header:
- "Your Registrations" with phone number displayed
- "Log Out" button (calls `supabase.auth.signOut()`, navigates to /login)
- NotificationPreferences component (full mode) for the first/most recent registration, or a general note

Active Registrations section (current_stage !== 'sticker_delivered'):
- Card per registration showing:
  - Vehicle: {year} {make} {model}
  - Order: {orderId}
  - Current stage with colored badge
  - Mini progress bar (simple div-based, 6 segments filled/empty)
  - "View Details" link to `/track/{orderId}-{accessToken}`
  - NotificationPreferences (compact mode) per registration

Completed Registrations section (current_stage === 'sticker_delivered'):
- Collapsible (default collapsed) with "Completed ({count})" header
- Click to expand, shows same cards but muted styling
- Each card has "View Details" link

Empty state: "No registrations found for this phone number. If you recently purchased a vehicle, your registration may still be processing."

Match the dark theme, gold accents, font-display headings. Use framer-motion for section transitions (import `motion` from 'framer-motion', which is already installed).

Listen for auth state changes to handle session expiry:
```typescript
useEffect(() => {
  const { data: { subscription } } = supabase.auth.onAuthStateChange((event) => {
    if (event === 'SIGNED_OUT') {
      navigate('/login');
    }
  });
  return () => subscription.unsubscribe();
}, []);
```

**CustomerStatusTracker.tsx updates:**

Add two elements to the existing tracker page:

1. **Login link for returning customers**: Add near the bottom of the page (after the stage info section, before the footer):
```tsx
<div className="text-center mt-8 pt-6 border-t border-gray-800">
  <p className="text-gray-500 text-sm">
    Have multiple registrations?{' '}
    <a href="/login" className="text-tj-gold hover:text-white transition-colors">
      Log in with your phone number
    </a>
    {' '}to see them all.
  </p>
</div>
```

2. **Notification preferences toggle**: Add the NotificationPreferences component in compact mode. Place it near the top of the loaded registration view (after the vehicle info header area, before the progress visualization):
```tsx
{registration && (
  <NotificationPreferences
    registrationId={registration.id}
    currentPreference={registration.notificationPref}
    compact={true}
  />
)}
```
Import NotificationPreferences from `../components/NotificationPreferences`.

**index.tsx route updates:**

Read the existing index.tsx to understand the current routing structure (likely uses react-router-dom with HashRouter based on the auth.ts `/#/reset-password` reference).

Add two new routes:
```tsx
import CustomerLogin from './pages/CustomerLogin';
import CustomerDashboard from './pages/CustomerDashboard';

// Inside the route configuration:
<Route path="/login" element={<CustomerLogin />} />
<Route path="/dashboard" element={<CustomerDashboard />} />
```

Place these routes alongside the existing `/track/:accessKey` route. These are public routes (no admin auth required) -- the CustomerDashboard handles its own auth check internally.
  </action>
  <verify>
    - `pages/CustomerDashboard.tsx` exists and checks auth session on mount
    - CustomerDashboard fetches registrations via Supabase client (RLS-filtered)
    - Active registrations shown prominently, completed in collapsible section
    - Each registration card links to /track/{orderId}-{accessToken}
    - Each registration has NotificationPreferences (compact mode)
    - Dashboard has logout button
    - `pages/CustomerStatusTracker.tsx` has login link text
    - CustomerStatusTracker renders NotificationPreferences component
    - `index.tsx` has /login and /dashboard routes
    - `npm run build` passes
  </verify>
  <done>CustomerDashboard shows active and completed registrations with preference controls. CustomerStatusTracker has login link and preference toggle. Routes /login and /dashboard are registered.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete notification and login system for Phase 4:
    - Database migration with debounce queue, preferences, phone-auth RLS
    - Edge Functions for SMS (Twilio), email (Resend), queue processing, unsubscribe
    - Admin "Notify customer" checkbox and notification history modal
    - Customer phone OTP login page (/login)
    - Customer dashboard showing all registrations (/dashboard)
    - Notification preference controls on tracker and dashboard
    - Phone number normalization for E.164 format
  </what-built>
  <how-to-verify>
    NOTE: Full end-to-end verification requires:
    1. Migration 04 applied to Supabase
    2. Twilio account configured (SID, token, phone number)
    3. Resend account configured (API key)
    4. Supabase phone auth enabled with Twilio
    5. Edge Functions deployed
    6. pg_cron and pg_net extensions enabled

    For code verification without live services:
    1. Run `npm run build` -- should pass with no errors
    2. Start dev server: `npm run dev`
    3. Visit /login -- should show phone input form
    4. Visit /dashboard without auth -- should redirect to /login
    5. Visit an existing /track/:accessKey URL -- should show tracker with:
       - Notification preferences gear icon
       - "Have multiple registrations? Log in" link at bottom
    6. Go to admin /registrations -- click a registration to expand:
       - "Notifications" button should appear
       - Change a status -- confirmation dialog should have "Notify customer" checkbox
    7. Review Edge Function files under supabase/functions/ for correct structure

    With live services (after setup):
    8. Change a registration status with "Notify customer" checked
    9. Wait 5+ minutes for debounce
    10. Verify customer receives SMS and/or email
    11. Test phone login: enter phone, receive code, verify, see dashboard
    12. Test unsubscribe link in email
    13. Test notification preference changes
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
- `npm run build` passes clean
- /login route renders phone OTP form
- /dashboard route renders registration list (or redirects to /login if unauthenticated)
- CustomerStatusTracker shows NotificationPreferences and login link
- All new components follow existing design patterns (dark theme, gold accents, font-display)
- Auth session check prevents unauthenticated dashboard access
- Supabase signInWithOtp/verifyOtp calls use correct parameters
- Phone normalization applied before Supabase auth calls
</verification>

<success_criteria>
1. CustomerLogin page has two-step phone OTP flow (input -> verify)
2. CustomerDashboard shows active registrations on top, completed in collapsible section
3. NotificationPreferences component works in both compact and full modes
4. CustomerStatusTracker has login link and preference toggle
5. Routes /login and /dashboard registered in app router
6. Build passes with no type errors
7. Human verification confirms UI renders correctly
</success_criteria>

<output>
After completion, create `.planning/phases/04-customer-portal-notifications-login/04-04-SUMMARY.md`
</output>
