---
phase: 04-customer-portal-notifications-login
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - triple-j-auto-investment-main/types.ts
  - triple-j-auto-investment-main/services/registrationService.ts
  - triple-j-auto-investment-main/services/notificationService.ts
  - triple-j-auto-investment-main/utils/phone.ts
  - triple-j-auto-investment-main/pages/admin/Registrations.tsx
autonomous: true

must_haves:
  truths:
    - "Registration interface includes notificationPref field"
    - "RegistrationNotification interface includes extended fields (oldStage, newStage, subject, templateUsed, providerMessageId)"
    - "Phone numbers are normalized to E.164 format before storage"
    - "updateRegistrationStatus accepts notifyCustomer option that sets pending_notify_customer"
    - "Admin sees 'Notify customer' checkbox (default checked) in status change confirmation dialog"
    - "Admin can view notification history per registration"
    - "transformRegistration maps notification_pref from DB"
    - "getNotificationHistory returns audit trail of sent notifications"
  artifacts:
    - path: "triple-j-auto-investment-main/types.ts"
      provides: "Updated Registration and RegistrationNotification interfaces"
      contains: "notificationPref"
    - path: "triple-j-auto-investment-main/services/registrationService.ts"
      provides: "Updated updateRegistrationStatus with notifyCustomer option, transformRegistration with notificationPref"
      contains: "pending_notify_customer"
    - path: "triple-j-auto-investment-main/services/notificationService.ts"
      provides: "getNotificationHistory, updateNotificationPreference functions"
      exports: ["getNotificationHistory", "updateNotificationPreference"]
    - path: "triple-j-auto-investment-main/utils/phone.ts"
      provides: "normalizePhone utility for E.164 formatting"
      exports: ["normalizePhone"]
    - path: "triple-j-auto-investment-main/pages/admin/Registrations.tsx"
      provides: "Notify checkbox in confirm dialog, notification history tab"
      contains: "notifyCustomer"
  key_links:
    - from: "pages/admin/Registrations.tsx"
      to: "services/registrationService.ts updateRegistrationStatus"
      via: "notifyCustomer option passed through"
      pattern: "notifyCustomer.*updateRegistrationStatus"
    - from: "services/registrationService.ts"
      to: "registrations.pending_notify_customer column"
      via: "updateData.pending_notify_customer = options.notifyCustomer"
      pattern: "pending_notify_customer"
    - from: "services/notificationService.ts"
      to: "registration_notifications table"
      via: "supabase.from('registration_notifications').select()"
      pattern: "registration_notifications"
---

<objective>
Update TypeScript types, service layer, and admin UI to support the notification system: add notification preference to Registration interface, extend RegistrationNotification, create phone normalization utility, add notifyCustomer flag to status updates, and add "Notify customer" checkbox plus notification history to the admin Registrations page.

Purpose: Connects the database migration (Plan 01) to the frontend. Admin controls whether notifications fire, can view notification history, and phone numbers are normalized for Twilio/Supabase Auth compatibility.

Output: Updated types.ts, registrationService.ts, new notificationService.ts, new phone utility, updated admin Registrations.tsx.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-customer-portal-notifications-login/04-CONTEXT.md
@.planning/phases/04-customer-portal-notifications-login/04-RESEARCH.md
@.planning/phases/04-customer-portal-notifications-login/04-01-SUMMARY.md

Key source files:
@triple-j-auto-investment-main/types.ts (Registration interface at line 145, RegistrationNotification at line 238)
@triple-j-auto-investment-main/services/registrationService.ts (transformRegistration at line 29, updateRegistrationStatus at line 342, logNotification at line 756)
@triple-j-auto-investment-main/pages/admin/Registrations.tsx (confirmDialog at line 914, handleConfirmedStatusChange at line 166)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update types, services, and phone utility</name>
  <files>
    triple-j-auto-investment-main/types.ts
    triple-j-auto-investment-main/services/registrationService.ts
    triple-j-auto-investment-main/services/notificationService.ts
    triple-j-auto-investment-main/utils/phone.ts
  </files>
  <action>
**types.ts changes:**

1. Add `notificationPref` to the `Registration` interface (after `isArchived`):
```typescript
notificationPref: 'sms' | 'email' | 'both' | 'none';
```

2. Update the `RegistrationNotification` interface to add extended fields:
```typescript
export interface RegistrationNotification {
  id: string;
  registrationId: string;
  notificationType: 'stage_complete' | 'action_required' | 'blocked' | 'ready_pickup';
  channel: 'sms' | 'email';
  recipient: string;
  message: string;
  sentAt: string;
  delivered?: boolean;
  deliveryError?: string;
  triggeredBy: 'admin_action' | 'auto' | 'system';
  // Extended fields (Phase 4)
  oldStage?: string;
  newStage?: string;
  subject?: string;
  templateUsed?: string;
  providerMessageId?: string;
  createdAt: string;
}
```

3. Export a new type for notification preference:
```typescript
export type NotificationPreference = 'sms' | 'email' | 'both' | 'none';
```

**registrationService.ts changes:**

1. Update `transformRegistration` to map `notification_pref`:
Add after the `isArchived` mapping line:
```typescript
notificationPref: data.notification_pref ?? 'both',
```

2. Update `updateRegistrationStatus` function signature and body to accept `notifyCustomer`:
```typescript
export async function updateRegistrationStatus(
  registrationId: string,
  newStage: RegistrationStageKey,
  options?: {
    changeReason?: string;
    rejectionNotes?: string;
    notifyCustomer?: boolean; // NEW: controls pending_notify_customer column
  }
): Promise<boolean> {
```
In the function body, add after the existing `changeReason` and `rejectionNotes` handling:
```typescript
// Set pending_notify_customer for notification trigger
// Default to true if not explicitly set
if (options?.notifyCustomer !== undefined) {
  updateData.pending_notify_customer = options.notifyCustomer;
} else {
  updateData.pending_notify_customer = true;
}
```

3. Update `logNotification` to accept extended fields:
Add to the input type:
```typescript
oldStage?: string;
newStage?: string;
subject?: string;
templateUsed?: string;
providerMessageId?: string;
```
Add to the insert object:
```typescript
old_stage: input.oldStage,
new_stage: input.newStage,
subject: input.subject,
template_used: input.templateUsed,
provider_message_id: input.providerMessageId,
```

**notificationService.ts (NEW file):**

Create `services/notificationService.ts` with:

```typescript
import { supabase } from '../supabase/config';
import { RegistrationNotification } from '../types';
```

1. `getNotificationHistory(registrationId: string): Promise<RegistrationNotification[]>`
   - Query `registration_notifications` table filtered by registration_id, ordered by sent_at DESC
   - Transform snake_case to camelCase (write a transformNotification helper)
   - Return array of RegistrationNotification

2. `updateNotificationPreference(registrationId: string, pref: NotificationPreference): Promise<boolean>`
   - UPDATE registrations SET notification_pref = pref WHERE id = registrationId
   - Return success/failure
   - Import NotificationPreference from types.ts

3. `getNotificationPreference(registrationId: string): Promise<NotificationPreference | null>`
   - SELECT notification_pref FROM registrations WHERE id = registrationId
   - Return the preference or null if not found

**utils/phone.ts (NEW file):**

Create `utils/phone.ts` with:

```typescript
/**
 * Normalize phone number to E.164 format (+1XXXXXXXXXX)
 * Required for Twilio SMS and Supabase phone auth matching.
 */
export function normalizePhone(phone: string): string {
  // Strip all non-digits
  const digits = phone.replace(/\D/g, '');
  // US: 10 digits -> +1 prefix
  if (digits.length === 10) return `+1${digits}`;
  // US: 11 digits starting with 1 -> + prefix
  if (digits.length === 11 && digits.startsWith('1')) return `+${digits}`;
  // Already has country code or unknown format -> + prefix
  if (digits.length > 10) return `+${digits}`;
  // Too short -- return as-is with + (caller should validate)
  return `+${digits}`;
}

/**
 * Format phone for display: (XXX) XXX-XXXX
 */
export function formatPhone(phone: string): string {
  const digits = phone.replace(/\D/g, '');
  const national = digits.startsWith('1') && digits.length === 11
    ? digits.slice(1)
    : digits;
  if (national.length === 10) {
    return `(${national.slice(0, 3)}) ${national.slice(3, 6)}-${national.slice(6)}`;
  }
  return phone; // Return original if can't format
}
```
  </action>
  <verify>
    - `types.ts` has `notificationPref` in Registration interface
    - `types.ts` has extended fields in RegistrationNotification interface
    - `types.ts` exports `NotificationPreference` type
    - `registrationService.ts` transformRegistration maps notification_pref
    - `registrationService.ts` updateRegistrationStatus accepts notifyCustomer option
    - `registrationService.ts` logNotification accepts extended fields
    - `services/notificationService.ts` exists with getNotificationHistory, updateNotificationPreference, getNotificationPreference
    - `utils/phone.ts` exists with normalizePhone and formatPhone
    - `npm run build` passes
  </verify>
  <done>Types include notification preference and extended notification fields. Service layer passes notifyCustomer flag to DB. Phone normalization utility handles US phone formatting to E.164. Notification service provides history and preference management.</done>
</task>

<task type="auto">
  <name>Task 2: Add notify checkbox and notification history to admin UI</name>
  <files>triple-j-auto-investment-main/pages/admin/Registrations.tsx</files>
  <action>
Modify the existing admin Registrations page to add two features:

**Feature A: "Notify customer" checkbox in status change confirmation dialog**

1. Add state variable near the existing `confirmNotes` state:
```typescript
const [notifyCustomer, setNotifyCustomer] = useState(true);
```

2. Reset it in `openConfirmDialog`:
```typescript
setNotifyCustomer(true); // Default: checked
```

3. Add checkbox to the confirmation dialog UI (between the notes textarea and the button row, inside the `{confirmDialog && (` block around line 924-951):
```tsx
<div className="flex items-center gap-3">
  <input
    type="checkbox"
    id="notify-customer"
    checked={notifyCustomer}
    onChange={e => setNotifyCustomer(e.target.checked)}
    className="w-4 h-4 accent-tj-gold"
  />
  <label htmlFor="notify-customer" className="text-gray-400 text-sm">
    Notify customer via SMS/Email
  </label>
</div>
```

4. Update `handleConfirmedStatusChange` to pass the flag:
```typescript
const success = await updateRegistrationStatus(
  confirmDialog.registrationId,
  confirmDialog.targetStage,
  {
    changeReason: confirmNotes || undefined,
    rejectionNotes: confirmDialog.targetStage === 'rejected' ? confirmNotes : undefined,
    notifyCustomer: notifyCustomer, // NEW
  }
);
```

**Feature B: Notification history per registration**

1. Add imports at top:
```typescript
import { getNotificationHistory } from '../../services/notificationService';
import { Bell } from 'lucide-react'; // Add Bell to existing lucide import
```

2. Add state for notification history:
```typescript
const [notificationHistory, setNotificationHistory] = useState<RegistrationNotification[]>([]);
const [showNotifications, setShowNotifications] = useState<string | null>(null); // registration ID
```
Import `RegistrationNotification` from types.ts if not already imported.

3. Add function to load notification history:
```typescript
const loadNotificationHistory = async (registrationId: string) => {
  const history = await getNotificationHistory(registrationId);
  setNotificationHistory(history);
  setShowNotifications(registrationId);
};
```

4. Add a "Notifications" button near the existing "History" button (audit history) in each registration's expanded detail view. Look for the audit history button (which calls `loadAuditHistory`) and add a similar button next to it:
```tsx
<button
  onClick={() => loadNotificationHistory(reg.id)}
  className="flex items-center gap-1.5 text-gray-500 hover:text-tj-gold transition-colors text-xs"
  title="View notification history"
>
  <Bell size={14} />
  Notifications
</button>
```

5. Add notification history modal (similar to the existing audit history modal). Place it after the audit history modal block:
```tsx
{showNotifications && (
  <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
    <div className="bg-tj-dark border border-gray-700 w-full max-w-2xl max-h-[80vh] flex flex-col">
      <div className="p-6 border-b border-gray-800 flex justify-between items-center">
        <h3 className="text-white font-display text-lg tracking-wide">
          Notification History
        </h3>
        <button
          onClick={() => setShowNotifications(null)}
          className="text-gray-500 hover:text-white transition-colors"
        >
          <X size={20} />
        </button>
      </div>
      <div className="p-6 overflow-y-auto flex-1 space-y-3">
        {notificationHistory.length === 0 ? (
          <p className="text-gray-500 text-sm">No notifications sent yet.</p>
        ) : (
          notificationHistory.map(n => (
            <div key={n.id} className="border border-gray-800 p-4 space-y-2">
              <div className="flex justify-between items-start">
                <div className="flex items-center gap-2">
                  <span className={`text-xs px-2 py-0.5 uppercase tracking-wider ${
                    n.channel === 'sms'
                      ? 'bg-blue-500/20 text-blue-400'
                      : 'bg-purple-500/20 text-purple-400'
                  }`}>
                    {n.channel}
                  </span>
                  <span className={`text-xs ${n.delivered ? 'text-green-400' : n.deliveryError ? 'text-red-400' : 'text-gray-500'}`}>
                    {n.delivered ? 'Delivered' : n.deliveryError ? 'Failed' : 'Pending'}
                  </span>
                </div>
                <span className="text-gray-600 text-xs">
                  {new Date(n.sentAt).toLocaleString()}
                </span>
              </div>
              {n.oldStage && n.newStage && (
                <p className="text-gray-400 text-xs">
                  Stage: {n.oldStage} â†’ {n.newStage}
                </p>
              )}
              <p className="text-gray-300 text-sm">{n.recipient}</p>
              {n.deliveryError && (
                <p className="text-red-400/70 text-xs">Error: {n.deliveryError}</p>
              )}
            </div>
          ))
        )}
      </div>
    </div>
  </div>
)}
```

Keep the existing audit history modal and button unchanged. The notification history is a separate, parallel feature.
  </action>
  <verify>
    - Registrations.tsx has `notifyCustomer` state initialized to true
    - Confirmation dialog has checkbox input with id="notify-customer"
    - handleConfirmedStatusChange passes notifyCustomer to updateRegistrationStatus
    - Bell icon imported from lucide-react
    - Notification history button exists near audit history button
    - Notification history modal renders with channel badge, delivery status, timestamps
    - `npm run build` passes
  </verify>
  <done>Admin confirmation dialog includes "Notify customer" checkbox (default checked). Each registration has a "Notifications" button that opens a modal showing full notification audit trail with channel, delivery status, stage change, and timestamps.</done>
</task>

</tasks>

<verification>
- `npm run build` passes with no type errors
- Registration interface includes notificationPref
- transformRegistration maps notification_pref from DB
- updateRegistrationStatus accepts and passes notifyCustomer to DB
- Admin UI has visible checkbox in confirmation dialog
- Notification history modal shows sent/failed/pending status
- Phone normalization handles common US formats: (713) 555-0192, 713-555-0192, 17135550192, +17135550192
</verification>

<success_criteria>
1. types.ts Registration has notificationPref, RegistrationNotification has 5 new fields
2. registrationService.ts passes pending_notify_customer on status change
3. notificationService.ts provides getNotificationHistory and updateNotificationPreference
4. utils/phone.ts normalizes to E.164 and formats for display
5. Admin confirmation dialog has "Notify customer via SMS/Email" checkbox
6. Admin can view per-registration notification history in modal
7. Build passes clean
</success_criteria>

<output>
After completion, create `.planning/phases/04-customer-portal-notifications-login/04-03-SUMMARY.md`
</output>
