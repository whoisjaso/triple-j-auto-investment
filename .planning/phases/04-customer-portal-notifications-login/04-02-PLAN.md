---
phase: 04-customer-portal-notifications-login
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/functions/_shared/twilio.ts
  - supabase/functions/_shared/resend.ts
  - supabase/functions/_shared/email-templates/status-update.tsx
  - supabase/functions/_shared/email-templates/rejection-notice.tsx
  - supabase/functions/process-notification-queue/index.ts
  - supabase/functions/unsubscribe/index.ts
autonomous: true
user_setup:
  - service: twilio
    why: "SMS delivery for notifications and OTP authentication"
    env_vars:
      - name: TWILIO_ACCOUNT_SID
        source: "Twilio Console -> Account SID (visible on dashboard)"
      - name: TWILIO_AUTH_TOKEN
        source: "Twilio Console -> Auth Token (visible on dashboard)"
      - name: TWILIO_PHONE_NUMBER
        source: "Twilio Console -> Phone Numbers -> Buy a Number ($1.15/month US local)"
    dashboard_config:
      - task: "Create a Messaging Service"
        location: "Twilio Console -> Messaging -> Services -> Create"
      - task: "Configure Supabase phone auth provider with Twilio"
        location: "Supabase Dashboard -> Auth -> Providers -> Phone -> Enable, enter Twilio SID/Token/Messaging Service SID"
  - service: resend
    why: "Rich HTML email delivery for status notifications"
    env_vars:
      - name: RESEND_API_KEY
        source: "Resend Dashboard -> API Keys -> Create"
    dashboard_config:
      - task: "Verify sending domain (optional, can use onboarding@resend.dev for testing)"
        location: "Resend Dashboard -> Domains -> Add Domain"

must_haves:
  truths:
    - "process-notification-queue Edge Function processes ready items from notification_queue"
    - "SMS sends via Twilio REST API with proper Basic auth"
    - "Email sends via Resend REST API with rich HTML template"
    - "Rejection notifications use a distinct template with extra context"
    - "SMS includes STOP keyword for unsubscribe compliance"
    - "Email includes unsubscribe link"
    - "Notification results are logged to registration_notifications table"
    - "Unsubscribe Edge Function updates notification_pref on registration"
  artifacts:
    - path: "supabase/functions/_shared/twilio.ts"
      provides: "sendSms() helper using Twilio REST API"
      exports: ["sendSms"]
    - path: "supabase/functions/_shared/resend.ts"
      provides: "sendEmail() helper using Resend REST API"
      exports: ["sendEmail"]
    - path: "supabase/functions/_shared/email-templates/status-update.tsx"
      provides: "HTML email template for stage change notifications"
      exports: ["renderStatusUpdateEmail"]
    - path: "supabase/functions/_shared/email-templates/rejection-notice.tsx"
      provides: "HTML email template for rejection notifications"
      exports: ["renderRejectionEmail"]
    - path: "supabase/functions/process-notification-queue/index.ts"
      provides: "Edge Function that processes debounced notification queue"
      contains: "Deno.serve"
    - path: "supabase/functions/unsubscribe/index.ts"
      provides: "Edge Function for one-click email unsubscribe"
      contains: "Deno.serve"
  key_links:
    - from: "process-notification-queue/index.ts"
      to: "notification_queue table"
      via: "supabase.from('notification_queue').select()"
      pattern: "notification_queue.*sent.*false"
    - from: "process-notification-queue/index.ts"
      to: "_shared/twilio.ts"
      via: "import sendSms"
      pattern: "import.*sendSms"
    - from: "process-notification-queue/index.ts"
      to: "_shared/resend.ts"
      via: "import sendEmail"
      pattern: "import.*sendEmail"
    - from: "process-notification-queue/index.ts"
      to: "registration_notifications table"
      via: "supabase.from('registration_notifications').insert()"
      pattern: "registration_notifications.*insert"
---

<objective>
Create all Supabase Edge Functions for notification delivery: Twilio SMS helper, Resend email helper, rich HTML email templates, the main queue processor, and an unsubscribe handler.

Purpose: Server-side notification delivery is required because SMS API keys cannot be exposed in the browser SPA. These Edge Functions are the notification pipeline that turns debounced queue entries into actual SMS/email deliveries.

Output: 6 files under `supabase/functions/` ready for deployment via `supabase functions deploy`.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-customer-portal-notifications-login/04-CONTEXT.md
@.planning/phases/04-customer-portal-notifications-login/04-RESEARCH.md

Key references:
- 04-RESEARCH.md contains exact Twilio REST API code, Resend API code, queue processor logic
- CONTEXT.md specifies SMS message format, rejection template requirements, STOP keyword
- registration_notifications table schema (from registration_ledger.sql + migration 04 extensions)
- REGISTRATION_STAGES from types.ts for stage labels
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared SMS and email helpers</name>
  <files>
    triple-j-auto-investment-main/supabase/functions/_shared/twilio.ts
    triple-j-auto-investment-main/supabase/functions/_shared/resend.ts
  </files>
  <action>
These are Deno/Edge Function files. Use `Deno.env.get()` for secrets, standard `fetch()` for HTTP calls. No npm imports needed for these helpers.

**twilio.ts:**
Create and export `sendSms(to: string, body: string)` function that:
- Reads `TWILIO_ACCOUNT_SID`, `TWILIO_AUTH_TOKEN`, `TWILIO_PHONE_NUMBER` from `Deno.env.get()`
- POSTs to `https://api.twilio.com/2010-04-01/Accounts/${accountSid}/Messages.json`
- Uses Basic auth: `Authorization: Basic ${btoa(accountSid + ':' + authToken)}`
- Body is `application/x-www-form-urlencoded` with URLSearchParams: To, From, Body
- Returns `{ success: boolean; sid?: string; error?: string }`
- Logs errors to console for debugging

**resend.ts:**
Create and export `sendEmail(params: { to: string; subject: string; html: string; from?: string })` function that:
- Reads `RESEND_API_KEY` from `Deno.env.get()`
- POSTs to `https://api.resend.com/emails`
- Uses Bearer auth: `Authorization: Bearer ${apiKey}`
- Body is JSON with from (default: `Triple J Auto Investment <notifications@triplejautoinvestment.com>`), to, subject, html
- Returns `{ success: boolean; id?: string; error?: string }`
- Logs errors to console

Both files should have explicit TypeScript return types and handle network errors gracefully (try/catch around fetch).
  </action>
  <verify>
    - `supabase/functions/_shared/twilio.ts` exists and exports sendSms
    - `supabase/functions/_shared/resend.ts` exists and exports sendEmail
    - Both use Deno.env.get() for secrets (not hardcoded)
    - Both return typed result objects with success/error
  </verify>
  <done>Twilio SMS helper and Resend email helper exist as shared Edge Function modules with proper auth, error handling, and typed returns.</done>
</task>

<task type="auto">
  <name>Task 2: Create email templates and queue processor</name>
  <files>
    triple-j-auto-investment-main/supabase/functions/_shared/email-templates/status-update.tsx
    triple-j-auto-investment-main/supabase/functions/_shared/email-templates/rejection-notice.tsx
    triple-j-auto-investment-main/supabase/functions/process-notification-queue/index.ts
  </files>
  <action>
**Email templates:**

Since React Email requires JSX config in Deno which adds complexity, use a simpler approach: **plain TypeScript functions that return HTML strings**. This avoids needing deno.json JSX configuration and React Email npm imports while still producing rich HTML emails.

**status-update.tsx** (rename to .ts since no JSX needed):
Actually keep the .tsx extension but use template literals for HTML. Export `renderStatusUpdateEmail(params)` that returns an HTML string with:
- Inline CSS (email clients strip `<style>` tags)
- Header with "Triple J Auto Investment" brand (gold #C9A84C on dark #1a1a1a)
- Vehicle info: year, make, model
- Mini progress visualization: 6 cells in a table row, completed stages filled gold, current stage outlined, future stages gray. Use inline styles on `<td>` elements. Stage labels below each cell.
- Current stage description text
- "View Full Status" button linking to tracking URL (gold button)
- Contact info footer: Triple J Auto Investment, Texas Dealer License: P171632, 8774 Almeda Genoa Road, Houston, TX 77075, (832) 400-9760
- Unsubscribe link at bottom: `{baseUrl}/functions/v1/unsubscribe?reg={registrationId}&token={accessToken}`
- Note in footer: "You'll still receive verification codes when logging in."

Function signature:
```typescript
export function renderStatusUpdateEmail(params: {
  customerName: string;
  vehicleYear: number;
  vehicleMake: string;
  vehicleModel: string;
  currentStage: string;
  stageLabel: string;
  stageDescription: string;
  stageOrder: number;
  trackingUrl: string;
  unsubscribeUrl: string;
}): string
```

**rejection-notice.tsx** (same .ts approach):
Export `renderRejectionEmail(params)` that returns HTML string with:
- Same brand header
- "Attention Required" banner in red
- Vehicle info
- Explanation: "Your registration was returned by the DMV for corrections. Our team at Triple J is addressing this."
- Rejection notes (if provided)
- "What happens next" section: "Our team will correct the submission and resubmit. You'll receive another update when we do."
- Contact section: "Questions? Call (832) 400-9760"
- "View Full Status" button
- Same footer with unsubscribe

Function signature:
```typescript
export function renderRejectionEmail(params: {
  customerName: string;
  vehicleYear: number;
  vehicleMake: string;
  vehicleModel: string;
  rejectionNotes?: string;
  trackingUrl: string;
  unsubscribeUrl: string;
}): string
```

**process-notification-queue/index.ts:**
Main Edge Function invoked every minute by pg_cron. Structure:

```typescript
import { createClient } from 'npm:@supabase/supabase-js@2';
import { sendSms } from '../_shared/twilio.ts';
import { sendEmail } from '../_shared/resend.ts';
import { renderStatusUpdateEmail } from '../_shared/email-templates/status-update.tsx';
import { renderRejectionEmail } from '../_shared/email-templates/rejection-notice.tsx';
```

Use `Deno.serve(async (req) => { ... })` pattern.

Logic:
1. Create Supabase client with `SUPABASE_URL` and `SUPABASE_SERVICE_ROLE_KEY` env vars
2. Query notification_queue: `sent = false AND send_after <= NOW() AND notify_customer = true`
3. Join with registrations to get customer info: `.select('*, registrations(*)')`
4. For each queue item:
   a. Check registration's `notification_pref`. If 'none', mark as sent with note 'skipped_preference_none', continue.
   b. Determine stage label from a STAGE_LABELS map (hardcode the 7 stage key -> label mappings to avoid importing frontend types).
   c. Build tracking URL: `{BASE_URL}/track/{orderId}-{accessToken}`
   d. Build unsubscribe URL: `{BASE_URL}/functions/v1/unsubscribe?reg={registrationId}&token={accessToken}`
   e. Determine if rejection: `new_stage === 'rejected'`
   f. **Send SMS** if pref is 'sms' or 'both' AND customer_phone exists:
      - Format per CONTEXT.md: `Hi {name}, your {year} {make} {model} registration is now at {stageLabel}. View details: {trackingUrl}\nReply STOP to unsubscribe`
      - For rejection: `Hi {name}, your {year} {make} {model} registration was returned by DMV for corrections. Our team is addressing this. View details: {trackingUrl}\nQuestions? Call (832) 400-9760\nReply STOP to unsubscribe`
      - If SMS fails, log error but continue to try email (auto-fallback per CONTEXT.md)
   g. **Send email** if pref is 'email' or 'both' AND customer_email exists:
      - Use rejection template if new_stage is 'rejected', otherwise status-update template
      - Subject: "Registration Update - {stageLabel}" or "Attention Required - Registration Returned"
   h. **Log to registration_notifications**: Insert one row per channel attempted (SMS and/or email), with old_stage, new_stage, subject, template_used, provider_message_id, delivered status, delivery_error
   i. **Mark queue item as sent**: UPDATE sent = true, sent_at = NOW()
   j. If both SMS and email fail, mark sent = true but store error (don't retry forever -- admin can see failures in notification history)
5. Return JSON response: `{ processed: N, errors: M }`

Read `BASE_URL` from `Deno.env.get('PUBLIC_SITE_URL')` or fall back to `Deno.env.get('SUPABASE_URL')?.replace('.supabase.co', '.vercel.app')` or hardcode a fallback. Store as Edge Function secret.

Define STAGE_LABELS inline:
```typescript
const STAGE_LABELS: Record<string, string> = {
  sale_complete: 'Sale Complete',
  documents_collected: 'Documents Collected',
  submitted_to_dmv: 'Submitted to DMV',
  dmv_processing: 'DMV Processing',
  sticker_ready: 'Sticker Ready',
  sticker_delivered: 'Sticker Delivered',
  rejected: 'Rejected',
};

const STAGE_DESCRIPTIONS: Record<string, string> = {
  sale_complete: 'Vehicle sold, plates assigned from dealer inventory.',
  documents_collected: 'All paperwork received (title, 130-U, insurance, inspection).',
  submitted_to_dmv: 'Packet uploaded to webDEALER.',
  dmv_processing: 'Awaiting DMV review.',
  sticker_ready: 'Registration approved, sticker available for pickup/delivery.',
  sticker_delivered: 'Customer received their sticker.',
  rejected: 'DMV rejected submission. Review notes and resubmit.',
};

const STAGE_ORDER: Record<string, number> = {
  sale_complete: 1, documents_collected: 2, submitted_to_dmv: 3,
  dmv_processing: 4, sticker_ready: 5, sticker_delivered: 6, rejected: 0,
};
```

Add proper error handling with try/catch around the entire handler and per-item processing.
  </action>
  <verify>
    - `supabase/functions/_shared/email-templates/status-update.tsx` exists and exports renderStatusUpdateEmail
    - `supabase/functions/_shared/email-templates/rejection-notice.tsx` exists and exports renderRejectionEmail
    - `supabase/functions/process-notification-queue/index.ts` exists with Deno.serve
    - Queue processor imports twilio.ts and resend.ts
    - Queue processor queries notification_queue with correct filters
    - Queue processor checks notification_pref before sending
    - Queue processor logs to registration_notifications
    - Queue processor marks items as sent after processing
    - SMS templates include STOP keyword
    - Email templates include unsubscribe URL
  </verify>
  <done>Email templates produce rich HTML with progress visualization and unsubscribe links. Queue processor fetches ready items, respects preferences, sends via Twilio/Resend, logs audit trail, and marks items sent.</done>
</task>

<task type="auto">
  <name>Task 3: Create unsubscribe Edge Function</name>
  <files>
    triple-j-auto-investment-main/supabase/functions/unsubscribe/index.ts
  </files>
  <action>
Create a simple Edge Function that handles one-click email unsubscribe.

**URL format:** `GET /functions/v1/unsubscribe?reg={registrationId}&token={accessToken}`

Logic:
1. Parse `reg` (registration ID) and `token` (access token) from URL query params
2. Create Supabase client with service role key (admin access needed to update)
3. Verify the registration exists and token matches: `SELECT id FROM registrations WHERE id = reg AND access_token = token`
4. If not found, return a simple HTML page: "Invalid or expired link."
5. If found, update `notification_pref` to 'none': `UPDATE registrations SET notification_pref = 'none' WHERE id = reg`
6. Return a simple HTML page: "You have been unsubscribed from Triple J Auto Investment registration notifications. You will no longer receive SMS or email updates for this registration. If you change your mind, you can update your preferences from your tracking page."

The HTML response should be minimal but styled (inline CSS) -- dark background matching the brand, white text, gold accent. Include a link back to the tracking page.

Handle errors gracefully -- if database update fails, show "Something went wrong. Please try again or call (832) 400-9760."
  </action>
  <verify>
    - `supabase/functions/unsubscribe/index.ts` exists with Deno.serve
    - Function validates reg and token params
    - Function updates notification_pref to 'none'
    - Function returns HTML response (not JSON)
    - Error states handled gracefully
  </verify>
  <done>Unsubscribe Edge Function validates token, updates preference to 'none', and returns a branded HTML confirmation page.</done>
</task>

</tasks>

<verification>
- All 6 files exist under supabase/functions/
- Edge Functions use Deno.env.get() for all secrets (no hardcoded keys)
- Queue processor handles all notification_pref values: sms, email, both, none
- SMS fallback to email on failure (per CONTEXT.md)
- Rejection uses distinct template with extra context (per CONTEXT.md)
- STOP keyword in every SMS, unsubscribe link in every email
- Notification audit trail logged to registration_notifications for every send attempt
- `npm run build` still passes (Edge Functions are outside the Vite build)
</verification>

<success_criteria>
1. Twilio helper sends SMS via REST API with Basic auth
2. Resend helper sends email via REST API with Bearer auth
3. Email templates produce rich HTML with inline CSS, progress visualization, unsubscribe link
4. Rejection template has distinct "Attention Required" design with DMV correction explanation
5. Queue processor fetches ready items, checks preferences, sends via both channels, logs results
6. Unsubscribe handler validates token and updates notification_pref to 'none'
7. All Edge Functions are deployable via `supabase functions deploy`
</success_criteria>

<output>
After completion, create `.planning/phases/04-customer-portal-notifications-login/04-02-SUMMARY.md`
</output>
