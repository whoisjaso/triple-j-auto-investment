---
phase: 04-customer-portal-notifications-login
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/04_notification_system.sql
  - supabase/migrations/README.md
autonomous: true

must_haves:
  truths:
    - "notification_queue table exists with partial unique constraint for debounce"
    - "queue_status_notification trigger fires BEFORE UPDATE on registrations when current_stage changes"
    - "notification_pref column on registrations defaults to 'both' with CHECK constraint"
    - "pending_notify_customer column on registrations allows admin opt-out per status change"
    - "registration_notifications table has extended columns for richer audit trail"
    - "Authenticated customers can SELECT registrations matching their phone via RLS"
    - "pg_cron schedule entry exists to invoke process-notification-queue every minute"
  artifacts:
    - path: "supabase/migrations/04_notification_system.sql"
      provides: "Notification queue, preferences, debounce trigger, phone-auth RLS, pg_cron schedule"
      contains: "notification_queue"
    - path: "supabase/migrations/README.md"
      provides: "Migration documentation for migration 04"
      contains: "04_notification_system"
  key_links:
    - from: "registrations.current_stage UPDATE"
      to: "notification_queue INSERT/UPSERT"
      via: "queue_status_notification() BEFORE UPDATE trigger"
      pattern: "queue_status_notification"
    - from: "notification_queue.send_after"
      to: "process-notification-queue Edge Function"
      via: "pg_cron every-minute schedule using pg_net"
      pattern: "cron.schedule"
---

<objective>
Create the database migration for Phase 4 notification infrastructure: debounce queue table, notification preferences, admin notify flag, extended notification audit columns, phone-auth RLS policy, and pg_cron schedule.

Purpose: All server-side notification logic depends on these tables, triggers, and policies existing. This is the foundation for SMS/email delivery, debounce, preference management, and customer phone login.

Output: `supabase/migrations/04_notification_system.sql` ready to apply, plus updated README.md documenting the migration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-customer-portal-notifications-login/04-CONTEXT.md
@.planning/phases/04-customer-portal-notifications-login/04-RESEARCH.md

Key existing files:
@triple-j-auto-investment-main/supabase/registration_ledger.sql (registration_notifications table already exists here)
@triple-j-auto-investment-main/supabase/migrations/02_registration_schema_update.sql (audit trigger pattern)
@triple-j-auto-investment-main/supabase/migrations/03_customer_portal_access.sql (token access pattern)
@triple-j-auto-investment-main/supabase/migrations/README.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create notification system migration SQL</name>
  <files>triple-j-auto-investment-main/supabase/migrations/04_notification_system.sql</files>
  <action>
Create `04_notification_system.sql` with the following 7 sections. Follow the style of existing migrations (02, 03) with clear section headers using `-- ================================================================`.

**Section 1: notification_queue table (debounce mechanism)**
```sql
CREATE TABLE IF NOT EXISTS public.notification_queue (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  registration_id UUID NOT NULL REFERENCES public.registrations(id) ON DELETE CASCADE,
  old_stage VARCHAR(50),
  new_stage VARCHAR(50) NOT NULL,
  send_after TIMESTAMPTZ NOT NULL DEFAULT (NOW() + INTERVAL '5 minutes'),
  sent BOOLEAN DEFAULT FALSE,
  sent_at TIMESTAMPTZ,
  error TEXT,
  notify_customer BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```
Add a **partial unique index** (NOT a table constraint -- PostgreSQL does not support WHERE on UNIQUE constraints inline):
```sql
CREATE UNIQUE INDEX IF NOT EXISTS uq_pending_notification
ON public.notification_queue (registration_id) WHERE (sent = false);
```
Add a ready-items index:
```sql
CREATE INDEX IF NOT EXISTS idx_notification_queue_ready
ON public.notification_queue(send_after) WHERE sent = false;
```
Enable RLS on notification_queue. Admin-only full access. No public access.

**Section 2: Extend registration_notifications table**
The table already exists from registration_ledger.sql. ALTER TABLE to add:
- `old_stage VARCHAR(50)`
- `new_stage VARCHAR(50)`
- `subject TEXT`
- `template_used VARCHAR(100)`
- `provider_message_id TEXT` (Twilio SID or Resend ID)
Use `ADD COLUMN IF NOT EXISTS` for each.

**Section 3: Notification preferences on registrations**
```sql
ALTER TABLE public.registrations
ADD COLUMN IF NOT EXISTS notification_pref VARCHAR(10) DEFAULT 'both'
  CHECK (notification_pref IN ('sms', 'email', 'both', 'none'));
```

**Section 4: Pending notify flag on registrations**
```sql
ALTER TABLE public.registrations
ADD COLUMN IF NOT EXISTS pending_notify_customer BOOLEAN;
```

**Section 5: Debounce trigger function and trigger**
Create `queue_status_notification()` as a BEFORE UPDATE trigger on registrations. Logic:
- Only fires when `OLD.current_stage IS DISTINCT FROM NEW.current_stage`
- INSERT into notification_queue with ON CONFLICT on the partial unique index `uq_pending_notification` DO UPDATE: set new_stage, notify_customer, send_after to NOW() + 5 minutes, updated_at to NOW()
- Clear `NEW.pending_notify_customer := NULL` after capturing value
- RETURN NEW (required for BEFORE trigger)

Create trigger:
```sql
CREATE TRIGGER queue_notification_on_status_change
BEFORE UPDATE ON public.registrations
FOR EACH ROW EXECUTE FUNCTION queue_status_notification();
```

IMPORTANT: This trigger must fire BEFORE the existing `update_registrations_updated_at` trigger. Since both are BEFORE UPDATE triggers, PostgreSQL fires them in alphabetical order by trigger name. "queue_notification..." comes before "update_registrations..." alphabetically, so naming is correct.

**Section 6: RLS policy for phone-authenticated customers**
Add a SELECT policy on registrations for authenticated users matching by phone:
```sql
CREATE POLICY "Customers can view own registrations by phone"
ON public.registrations
FOR SELECT TO authenticated
USING (
  customer_phone IS NOT NULL
  AND customer_phone = (
    SELECT phone FROM auth.users WHERE id = auth.uid()
  )
);
```
Note: Use `auth.users` table directly (not jwt claim) because Supabase phone auth stores the phone in the users table. The `auth.jwt()->>'phone'` approach requires the phone claim to be in the JWT, which Supabase does include for phone-authenticated users, but querying auth.users is more reliable. Actually, for Supabase phone auth, use:
```sql
USING (
  customer_phone IS NOT NULL
  AND customer_phone = (auth.jwt()->>'phone')
);
```
This is the standard Supabase pattern -- the JWT `phone` claim is populated for phone-authenticated users.

Also add admin policy for notification_queue:
```sql
CREATE POLICY "Admins can manage notification_queue"
ON public.notification_queue
FOR ALL USING (
  auth.uid() IN (SELECT id FROM public.profiles WHERE is_admin = true)
);
```

**Section 7: pg_cron schedule for queue processing**
Use pg_cron + pg_net to invoke the Edge Function every minute. This requires both extensions to be enabled in Supabase dashboard.
```sql
-- NOTE: pg_cron and pg_net extensions must be enabled in Supabase Dashboard -> Extensions
-- This schedule invokes the process-notification-queue Edge Function every minute.
-- The Edge Function URL and service_role_key are stored in Supabase Vault.
SELECT cron.schedule(
  'process-notification-queue',
  '* * * * *',
  $$
  SELECT net.http_post(
    url := current_setting('app.settings.supabase_url') || '/functions/v1/process-notification-queue',
    headers := jsonb_build_object(
      'Authorization', 'Bearer ' || current_setting('app.settings.service_role_key'),
      'Content-Type', 'application/json'
    ),
    body := '{}'::jsonb
  );
  $$
);
```

Add a comment noting the user must configure `app.settings.supabase_url` and `app.settings.service_role_key` as custom Postgres configs OR use Vault secrets. Provide both approaches in comments so the user can pick.

End with a success notice:
```sql
DO $$ BEGIN
  RAISE NOTICE 'Migration 04: Notification system created successfully!';
  RAISE NOTICE 'Tables: notification_queue';
  RAISE NOTICE 'Columns added: notification_pref, pending_notify_customer, + 5 on registration_notifications';
  RAISE NOTICE 'Trigger: queue_notification_on_status_change';
  RAISE NOTICE 'Cron: process-notification-queue (every minute)';
  RAISE NOTICE 'IMPORTANT: Enable pg_cron and pg_net extensions in Supabase Dashboard';
END $$;
```
  </action>
  <verify>
    - File exists at `triple-j-auto-investment-main/supabase/migrations/04_notification_system.sql`
    - File contains CREATE TABLE notification_queue
    - File contains CREATE UNIQUE INDEX uq_pending_notification with WHERE clause
    - File contains ALTER TABLE registration_notifications ADD COLUMN (5 columns)
    - File contains ALTER TABLE registrations ADD COLUMN notification_pref
    - File contains ALTER TABLE registrations ADD COLUMN pending_notify_customer
    - File contains CREATE OR REPLACE FUNCTION queue_status_notification()
    - File contains CREATE TRIGGER queue_notification_on_status_change
    - File contains CREATE POLICY for phone-authenticated customers
    - File contains cron.schedule for process-notification-queue
    - No syntax errors in SQL (review for balanced parens, semicolons, proper quoting)
  </verify>
  <done>Migration file has all 7 sections: queue table, notification_notifications extensions, notification_pref column, pending_notify_customer column, debounce trigger, phone-auth RLS, pg_cron schedule.</done>
</task>

<task type="auto">
  <name>Task 2: Update migrations README</name>
  <files>triple-j-auto-investment-main/supabase/migrations/README.md</files>
  <action>
Read the existing README.md and append documentation for migration 04 following the same format used for migrations 02 and 03.

Include:
- **Migration 04: Notification System** header
- Purpose: Notification queue with debounce, preferences, admin notify control, phone-auth RLS, cron schedule
- Prerequisites: pg_cron and pg_net extensions must be enabled in Supabase Dashboard
- Tables created: notification_queue
- Columns added to registrations: notification_pref (default 'both'), pending_notify_customer
- Columns added to registration_notifications: old_stage, new_stage, subject, template_used, provider_message_id
- Triggers: queue_notification_on_status_change (BEFORE UPDATE on registrations)
- RLS policies: phone-authenticated customer SELECT, admin notification_queue access
- Cron job: process-notification-queue (every minute via pg_net)
- Breaking changes: None (additive migration)
- Configuration required: Supabase URL and service_role_key must be accessible to pg_cron (via app.settings or Vault)
- Rollback: DROP trigger, DROP function, DROP TABLE notification_queue, ALTER TABLE DROP COLUMN for each added column
  </action>
  <verify>
    - README.md contains "Migration 04" section
    - README.md lists pg_cron and pg_net as prerequisites
    - README.md documents rollback steps
  </verify>
  <done>README.md documents migration 04 with purpose, prerequisites, schema changes, configuration requirements, and rollback instructions.</done>
</task>

</tasks>

<verification>
- Migration SQL file is syntactically valid (balanced parens, proper semicolons, correct ON CONFLICT syntax)
- Partial unique index uses CREATE UNIQUE INDEX with WHERE clause (not inline CONSTRAINT)
- Debounce trigger is BEFORE UPDATE (not AFTER) so it can modify NEW.pending_notify_customer
- RLS policy for phone auth uses auth.jwt()->>'phone' for JWT-based matching
- pg_cron schedule correctly calls Edge Function via pg_net
- README documents all changes and rollback steps
</verification>

<success_criteria>
1. `04_notification_system.sql` exists with all 7 sections
2. notification_queue table has partial unique index for debounce
3. queue_status_notification trigger captures stage changes and upserts queue
4. notification_pref column defaults to 'both' with CHECK constraint
5. Phone-authenticated RLS policy enables customer login feature
6. pg_cron schedule configured for every-minute queue processing
7. README.md updated with migration 04 documentation
</success_criteria>

<output>
After completion, create `.planning/phases/04-customer-portal-notifications-login/04-01-SUMMARY.md`
</output>
