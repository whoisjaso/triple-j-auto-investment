---
phase: 03-customer-portal-status-tracker
plan: 03
type: execute
wave: 2
depends_on: [03-01, 03-02]
files_modified:
  - pages/CustomerStatusTracker.tsx
  - App.tsx
  - pages/admin/Registrations.tsx
autonomous: false

must_haves:
  truths:
    - "Customer opens /track/{orderId}-{token} and sees their registration stage"
    - "Arc fills and car drives simultaneously on page load"
    - "Invalid/expired links show helpful error (not broken page)"
    - "Admin can copy tracking link for any registration"
    - "Page loads in under 3 seconds"
    - "Mobile layout is usable at 360px width"
  artifacts:
    - path: "pages/CustomerStatusTracker.tsx"
      provides: "Customer-facing status tracker page"
      min_lines: 150
    - path: "App.tsx"
      provides: "Route for /track/:accessKey"
      contains: "CustomerStatusTracker"
  key_links:
    - from: "pages/CustomerStatusTracker.tsx"
      to: "services/registrationService.ts"
      via: "getRegistrationByAccessKey call"
      pattern: "getRegistrationByAccessKey"
    - from: "pages/CustomerStatusTracker.tsx"
      to: "components/tracking"
      via: "Component imports"
      pattern: "from.*components/tracking"
    - from: "App.tsx"
      to: "pages/CustomerStatusTracker.tsx"
      via: "Route element"
      pattern: "Route.*CustomerStatusTracker"
---

<objective>
Create the customer-facing status tracker page with animated visualizations and secure link access.

Purpose: Deliver the core customer experience - a beautiful, informative status page accessible via unique link. This is the primary deliverable of Phase 3.

Output: New CustomerStatusTracker page, routing integration, admin link display, and human verification of the complete flow.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-customer-portal-status-tracker/03-CONTEXT.md
@.planning/phases/03-customer-portal-status-tracker/03-RESEARCH.md
@.planning/phases/03-customer-portal-status-tracker/03-01-SUMMARY.md
@.planning/phases/03-customer-portal-status-tracker/03-02-SUMMARY.md
@triple-j-auto-investment-main/pages/RegistrationTracker.tsx
@triple-j-auto-investment-main/App.tsx
@triple-j-auto-investment-main/pages/admin/Registrations.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CustomerStatusTracker page</name>
  <files>
    pages/CustomerStatusTracker.tsx
  </files>
  <action>
Create `pages/CustomerStatusTracker.tsx` with:

**Imports:**
```typescript
import React, { useState, useEffect } from 'react';
import { useParams } from 'react-router-dom';
import { Share2, Car } from 'lucide-react';
import { motion } from 'framer-motion';
import {
  ProgressArc,
  ProgressRoad,
  StageInfo,
  LoadingCrest,
  ErrorState
} from '../components/tracking';
import {
  parseAccessKey,
  getRegistrationByAccessKey
} from '../services/registrationService';
import { Registration, REGISTRATION_STAGES } from '../types';
```

**Component structure:**
```typescript
const CustomerStatusTracker: React.FC = () => {
  const { accessKey } = useParams<{ accessKey: string }>();
  const [registration, setRegistration] = useState<Registration | null>(null);
  const [loading, setLoading] = useState(true);
  const [errorType, setErrorType] = useState<'expired' | 'invalid' | 'not-found' | null>(null);
  const [selectedStage, setSelectedStage] = useState<number | null>(null);

  useEffect(() => {
    const fetchRegistration = async () => {
      if (!accessKey) {
        setErrorType('invalid');
        setLoading(false);
        return;
      }

      const parsed = parseAccessKey(accessKey);
      if (!parsed) {
        setErrorType('invalid');
        setLoading(false);
        return;
      }

      const result = await getRegistrationByAccessKey(parsed.orderId, parsed.token);

      if (!result) {
        // Could be expired or not found - check which
        // For now, treat as invalid (service returns null for both)
        setErrorType('not-found');
        setLoading(false);
        return;
      }

      setRegistration(result);
      setLoading(false);
    };

    fetchRegistration();
  }, [accessKey]);

  // Calculate progress (1-6 stages, rejected = stage before rejection)
  const getProgress = (): { stageNumber: number; progress: number } => {
    if (!registration) return { stageNumber: 1, progress: 0 };

    const stage = registration.currentStage;
    if (stage === 'rejected') {
      // Show progress at dmv_processing level (stage 4)
      return { stageNumber: 4, progress: 4 / 6 };
    }

    const stageOrder: Record<string, number> = {
      sale_complete: 1,
      documents_collected: 2,
      submitted_to_dmv: 3,
      dmv_processing: 4,
      sticker_ready: 5,
      sticker_delivered: 6
    };

    const num = stageOrder[stage] || 1;
    return { stageNumber: num, progress: num / 6 };
  };

  // Share button handler
  const handleShare = async () => {
    if (navigator.share) {
      try {
        await navigator.share({
          title: 'Registration Status - Triple J Auto Investment',
          url: window.location.href
        });
        // Haptic feedback on mobile
        if (navigator.vibrate) navigator.vibrate(50);
      } catch {
        // User cancelled or error
      }
    } else {
      // Fallback: copy to clipboard
      await navigator.clipboard.writeText(window.location.href);
      // Could show toast here
    }
  };

  // Handle stage tap on mobile (for arc)
  const handleStageClick = (stage: number) => {
    setSelectedStage(stage === selectedStage ? null : stage);
    if (navigator.vibrate) navigator.vibrate(25);
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-gradient-to-b from-white to-amber-50/30">
        <LoadingCrest />
      </div>
    );
  }

  if (errorType) {
    return (
      <div className="min-h-screen bg-gradient-to-b from-white to-amber-50/30 pt-24 px-4">
        <ErrorState type={errorType} />
      </div>
    );
  }

  const { stageNumber, progress } = getProgress();
  const isRejected = registration?.currentStage === 'rejected';

  return (
    <div className="min-h-screen bg-gradient-to-b from-white to-amber-50/30">
      {/* Header */}
      <header className="pt-8 pb-4 text-center">
        <h1 className="text-gray-800 text-xl font-display tracking-wide">
          Triple J Auto Investment
        </h1>
        <p className="text-gray-500 text-sm mt-1">Registration Status</p>
      </header>

      {/* Vehicle info */}
      <div className="text-center mb-6">
        <div className="inline-flex items-center gap-2 text-gray-600 text-sm">
          <Car size={16} />
          <span>
            {registration?.vehicleYear} {registration?.vehicleMake} {registration?.vehicleModel}
          </span>
        </div>
        <p className="text-gray-400 text-xs mt-1">
          Order: {registration?.orderId}
        </p>
      </div>

      {/* Progress Arc */}
      <ProgressArc
        progress={progress}
        stageNumber={stageNumber}
        totalStages={6}
        onStageClick={handleStageClick}
      />

      {/* Progress Road (dominant element per CONTEXT.md) */}
      <div className="px-4 mt-4">
        <ProgressRoad
          progress={progress}
          vehicleType={registration?.vehicleBodyType}
        />
      </div>

      {/* Stage Info */}
      <div className="px-4">
        <StageInfo
          currentStage={registration?.currentStage || 'sale_complete'}
          isRejected={isRejected}
          milestones={{
            saleDate: registration?.saleDate,
            submissionDate: registration?.submissionDate,
            approvalDate: registration?.approvalDate,
            deliveryDate: registration?.deliveryDate
          }}
          rejectionNotes={registration?.rejectionNotes}
        />
      </div>

      {/* Share button (mobile only) */}
      <div className="fixed bottom-6 right-6 md:hidden">
        <button
          onClick={handleShare}
          className="w-12 h-12 bg-tj-gold rounded-full flex items-center justify-center shadow-lg hover:bg-amber-500 transition-colors"
          aria-label="Share tracking link"
        >
          <Share2 size={20} className="text-white" />
        </button>
      </div>

      {/* Footer with contact */}
      <footer className="mt-12 pb-8 text-center">
        <p className="text-gray-400 text-xs">
          Questions? Call{' '}
          <a href="tel:+17135550192" className="text-tj-gold hover:underline">
            (713) 555-0192
          </a>
        </p>
      </footer>
    </div>
  );
};

export default CustomerStatusTracker;
```

Key implementation notes:
- White to light gold gradient background per CONTEXT.md
- Road is larger/more prominent than arc (via container sizing)
- Share button only on mobile
- Haptic feedback on interactions
- Clean, no-container design per CONTEXT.md
  </action>
  <verify>
Run `npm run build` - verify no TypeScript errors.
Check file exists: `ls pages/CustomerStatusTracker.tsx`
  </verify>
  <done>
CustomerStatusTracker page renders arc, road, stage info with animations. Error states handled. Share functionality works.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add routing and admin link display</name>
  <files>
    App.tsx
    pages/admin/Registrations.tsx
  </files>
  <action>
**In App.tsx:**

1. Add import at top with other page imports:
   ```typescript
   import CustomerStatusTracker from './pages/CustomerStatusTracker';
   ```

2. Add route (near the existing `/track` routes):
   ```typescript
   {/* Customer tracking - token-based access */}
   <Route path="/track/:accessKey" element={<CustomerStatusTracker />} />

   {/* Legacy order ID lookup - keep for admin testing */}
   <Route path="/track" element={<RegistrationTracker />} />
   ```

   Note: More specific route (`:accessKey` with longer format) should work because React Router matches by specificity, but verify the order doesn't conflict.

**In pages/admin/Registrations.tsx:**

1. Add import for getTrackingLink:
   ```typescript
   import { getTrackingLink } from '../../services/registrationService';
   ```

2. Add import for copy icon:
   ```typescript
   import { Copy, Check } from 'lucide-react';
   ```

3. Add state for copy feedback:
   ```typescript
   const [copiedId, setCopiedId] = useState<string | null>(null);
   ```

4. Add copy handler:
   ```typescript
   const handleCopyLink = async (registration: Registration) => {
     const link = getTrackingLink(registration);
     const fullUrl = `${window.location.origin}${link}`;
     await navigator.clipboard.writeText(fullUrl);
     setCopiedId(registration.id);
     setTimeout(() => setCopiedId(null), 2000);
   };
   ```

5. In the registration card/row, add a "Copy Link" button near the order ID:
   ```typescript
   <button
     onClick={() => handleCopyLink(registration)}
     className="ml-2 p-1 text-gray-400 hover:text-tj-gold transition-colors"
     title="Copy customer tracking link"
   >
     {copiedId === registration.id ? (
       <Check size={14} className="text-green-400" />
     ) : (
       <Copy size={14} />
     )}
   </button>
   ```

   Place this next to where the order ID is displayed so admin can easily share the link with customers.
  </action>
  <verify>
Run `npm run build` - verify no TypeScript errors.
Check route added: `grep -n "CustomerStatusTracker" App.tsx`
Check copy function added: `grep -n "handleCopyLink\|getTrackingLink" pages/admin/Registrations.tsx`
  </verify>
  <done>
Route `/track/:accessKey` maps to CustomerStatusTracker. Admin can copy tracking link for any registration with visual feedback.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete customer status tracker with animated visualizations, token-based access, and admin link sharing.
  </what-built>
  <how-to-verify>
**Setup:**
1. Run the dev server: `npm run dev`
2. Apply database migration if not already applied (check Supabase dashboard for access_token column)

**Test 1: Admin link copy**
1. Go to admin dashboard -> Registrations
2. Find any registration
3. Click the copy icon next to the order ID
4. Verify clipboard contains URL like `/track/TJ-2026-0001-a1b2c3...`

**Test 2: Customer tracker - valid link**
1. Paste the copied URL into a new browser tab (or incognito)
2. Verify:
   - Loading shows pulsing gold logo
   - Arc fills to current stage position (2.5s animation)
   - Car drives along road simultaneously
   - Stage info shows current stage description
   - Milestone dates display for completed stages
   - Vehicle info (year, make, model) shows correctly
   - Share button appears on mobile viewport (resize to test)

**Test 3: Customer tracker - invalid link**
1. Navigate to `/track/invalid-link-format`
2. Verify: "Invalid Link" error with contact info displays

**Test 4: Mobile experience**
1. Resize browser to 360px width or use mobile device
2. Verify:
   - Road runs vertically (top to bottom)
   - Arc still centered and visible
   - Stage info readable without horizontal scroll
   - Share button visible in bottom-right

**Test 5: Performance**
1. Open DevTools Network tab
2. Refresh customer tracker page
3. Verify page loads in under 3 seconds

**If rejected state:** Create or update a registration to "rejected" stage and verify red warning banner appears above the progress visualization.
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
- [ ] CustomerStatusTracker.tsx exists with ~200+ lines
- [ ] Route `/track/:accessKey` works in App.tsx
- [ ] Admin can copy tracking link for registrations
- [ ] Arc animation plays on page load
- [ ] Road animation plays simultaneously
- [ ] Mobile vertical road layout works
- [ ] Error states show helpful messages
- [ ] Page loads in under 3 seconds
- [ ] Human verification checkpoint passed
</verification>

<success_criteria>
1. Customer opens unique link and sees their registration stage (PORT-02, PORT-01)
2. Progress bar visually shows completed vs pending stages with animations (PORT-04)
3. Each stage displays clear description (PORT-07)
4. Page is mobile-responsive and loads in under 3 seconds
5. Invalid/expired links show helpful error message
6. Admin can share tracking links with customers
</success_criteria>

<output>
After completion, create `.planning/phases/03-customer-portal-status-tracker/03-03-SUMMARY.md`
</output>
