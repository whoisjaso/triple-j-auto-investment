---
phase: 08-rental-insurance-verification
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - triple-j-auto-investment-main/components/admin/InsuranceVerification.tsx
  - triple-j-auto-investment-main/components/admin/RentalBookingModal.tsx
  - triple-j-auto-investment-main/pages/admin/Rentals.tsx
autonomous: true
user_setup:
  - service: supabase-storage
    why: "Insurance card image upload"
    dashboard_config:
      - task: "Create Supabase Storage bucket 'insurance-cards'"
        location: "Supabase Dashboard -> Storage -> New bucket (public)"

must_haves:
  truths:
    - "Admin can enter insurance details (company, policy, dates, coverage amounts) during booking creation in the Agreement section of RentalBookingModal"
    - "Admin can view and manage insurance verification inside BookingDetail expansion on Active Rentals tab"
    - "Insurance status badge (green verified, red failed, amber overridden, gray pending) appears on each booking row in Active Rentals"
    - "Stats bar shows 'Unverified' count alongside existing active/overdue/fleet stats"
    - "Admin can verify, reject, or override insurance with notes (following RegistrationChecker override pattern)"
    - "Admin can upload insurance card image from InsuranceVerification component"
    - "System auto-flags: expired policy, below Texas 30/60/25 minimums, missing required fields"
    - "Returning customer's insurance pre-fills from their last booking"
  artifacts:
    - path: "triple-j-auto-investment-main/components/admin/InsuranceVerification.tsx"
      provides: "Inline insurance verification panel for BookingDetail"
      min_lines: 200
    - path: "triple-j-auto-investment-main/components/admin/RentalBookingModal.tsx"
      provides: "Insurance capture subsection in Agreement tab"
      contains: "insurance"
    - path: "triple-j-auto-investment-main/pages/admin/Rentals.tsx"
      provides: "Insurance badges on booking rows, stats bar unverified count, InsuranceVerification in BookingDetail"
      contains: "InsuranceVerification"
  key_links:
    - from: "components/admin/InsuranceVerification.tsx"
      to: "services/insuranceService.ts"
      via: "import and function calls"
      pattern: "import.*from.*insuranceService"
    - from: "components/admin/RentalBookingModal.tsx"
      to: "services/insuranceService.ts"
      via: "createInsurance call after booking creation"
      pattern: "createInsurance"
    - from: "pages/admin/Rentals.tsx"
      to: "components/admin/InsuranceVerification.tsx"
      via: "component render inside BookingDetail"
      pattern: "<InsuranceVerification"
---

<objective>
Build the insurance verification UI: capture form in booking modal, verification panel in booking detail, status badges, and stats bar integration.

Purpose: This is the primary user-facing work for Phase 8. Admin needs to capture insurance during booking creation, verify it from the active rentals view, and see at a glance which bookings lack verified insurance.

Output: New InsuranceVerification.tsx component, modified RentalBookingModal.tsx with insurance section, modified Rentals.tsx with badges and stats.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-rental-insurance-verification/08-CONTEXT.md
@.planning/phases/08-rental-insurance-verification/08-RESEARCH.md
@.planning/phases/08-rental-insurance-verification/08-01-SUMMARY.md

# Source files to modify
@triple-j-auto-investment-main/components/admin/RentalBookingModal.tsx
@triple-j-auto-investment-main/pages/admin/Rentals.tsx

# Pattern references
@triple-j-auto-investment-main/components/admin/RegistrationChecker.tsx
@triple-j-auto-investment-main/types.ts
@triple-j-auto-investment-main/services/insuranceService.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: InsuranceVerification Component</name>
  <files>triple-j-auto-investment-main/components/admin/InsuranceVerification.tsx</files>
  <action>
Create a new component that renders INLINE inside BookingDetail (same pattern as RegistrationChecker rendering inside Registrations.tsx expanded row). This is NOT a modal -- it's a panel within the BookingDetail expansion.

**Props interface:**
```typescript
interface InsuranceVerificationProps {
  booking: RentalBooking;
  onRefresh: () => Promise<void>;
}
```

**Component sections:**

1. **Insurance Info Display / Edit Form**
   - If no insurance record exists yet: show "Add Insurance" form with all fields.
   - If insurance record exists: show read-only display with "Edit" button to toggle edit mode.
   - Fields: Insurance Type toggle (Customer Provided / Dealer Coverage), Company, Policy Number, Effective Date, Expiration Date, Bodily Injury Per Person, Bodily Injury Per Accident, Property Damage.
   - When insurance_type = 'dealer_coverage': show Dealer Coverage Daily Rate and Total instead of company/policy fields. Calculate total = dailyRate * rental days.
   - Pre-fill from customer's last insurance when creating new (call getCustomerLastInsurance). Show a small gray note: "Pre-filled from last booking. Please verify." when pre-filled.

2. **System Verification Flags**
   - Call validateInsuranceCoverage(insurance, booking.endDate) to get flags.
   - Display each flag as a row: green check or red X icon + label.
   - Flags: "Required fields complete", "Coverage meets Texas 30/60/25 minimum", "Policy not expired", "No expiry during rental", "Insurance card uploaded".
   - Flag rows use the same visual pattern as RegistrationChecker sections (green bg-green-500/20 for pass, red bg-red-500/20 for fail).

3. **Admin Verification Actions**
   - Show current verification_status as a colored badge (same colors from RESEARCH.md: pending=gray, verified=green, failed=red, overridden=amber).
   - Three action buttons depending on current status:
     - If pending or failed: "Verify" (green) and "Reject" (red) buttons.
     - If pending and any flags are red: "Override and Verify" (amber) button that opens a notes input (same pattern as RegistrationChecker amber override button).
     - If verified: "Revoke Verification" button (reverts to pending).
     - If overridden: show "Overridden by [name] on [date]" with notes.
   - All actions require a notes input (Reject and Override require non-empty notes).
   - Call verifyInsurance, failInsurance, or overrideInsurance from insuranceService.

4. **Insurance Card Upload**
   - File input (accept="image/*,.pdf") with a styled upload button.
   - If card_image_url exists: show thumbnail/preview with a "View Full" link (opens in new tab) and "Replace" button.
   - Upload calls uploadInsuranceCard from insuranceService.
   - Show upload progress or spinner during upload.

**Styling:**
- Use the project's luxury dark theme (bg-black, border-tj-gold/20, text-white).
- Section headers: text-[10px] uppercase tracking-widest text-gray-500 (matches existing pattern).
- Compact layout since it renders inside an already-expanded BookingDetail row.
- Use Shield icon from lucide-react for the component header.

**State management:**
- Local state for insurance data, edit mode, loading states.
- useEffect on mount: call getInsuranceForBooking(booking.id). If result exists, set insurance state.
- After any mutation (create, update, verify, upload), call onRefresh to update parent and re-fetch.
- After creating/updating insurance for a customer-provided type, call updateCustomerInsuranceCache to cache for future pre-fill.

Do NOT modify the SectionKey type or SECTIONS array in RentalBookingModal (per established pattern from Phase 7).
  </action>
  <verify>
1. File exists at components/admin/InsuranceVerification.tsx
2. Component renders insurance info, flags, admin actions, and card upload sections
3. Uses validateInsuranceCoverage for auto-flag computation
4. Override pattern matches RegistrationChecker (amber button, notes required)
5. Handles both customer_provided and dealer_coverage insurance types
6. Pre-fill logic calls getCustomerLastInsurance
  </verify>
  <done>
InsuranceVerification.tsx created as a self-contained inline panel component. Displays insurance details, system verification flags (5 checks), admin verify/reject/override actions with notes, and insurance card upload. Follows RegistrationChecker override pattern. Handles both insurance types with appropriate field visibility.
  </done>
</task>

<task type="auto">
  <name>Task 2: RentalBookingModal Insurance Section + Rentals.tsx Integration</name>
  <files>
    triple-j-auto-investment-main/components/admin/RentalBookingModal.tsx
    triple-j-auto-investment-main/pages/admin/Rentals.tsx
  </files>
  <action>
**RentalBookingModal.tsx changes:**

Add an insurance capture subsection inside the 'terms' (Agreement) section, BELOW the existing geographic restrictions block. Do NOT add a 5th section or modify SectionKey/SECTIONS (per RESEARCH.md Pitfall 3).

Insurance subsection contents:
- Section header: "Insurance Information" with Shield icon.
- Insurance type toggle: two buttons -- "Customer Insurance" and "Dealer Coverage" (like the PaymentMethod toggle buttons).
- If customer_provided: fields for Company, Policy Number, Effective Date, Expiration Date, Bodily Injury Per Person ($), Bodily Injury Per Accident ($), Property Damage ($). Use number inputs for dollar amounts with placeholder showing Texas minimum (e.g., "Min: $30,000").
- If dealer_coverage: fields for Daily Rate (auto-calculates total from rental dates). Show "Dealer provides coverage at $X/day. Total: $Y for Z days."
- Small helper text below the section: "Texas requires minimum 30/60/25 liability coverage."
- Pre-fill logic: When a customer is selected (customerId changes), call getCustomerLastInsurance. If data found, pre-fill the insurance fields and show a subtle note "Pre-filled from previous rental."

Store insurance form data in local state (NOT in the booking creation payload). After booking is successfully created (the existing onSubmit success path), call createInsurance with the booking ID and insurance form data. If insurance creation fails, the booking still exists -- show a warning toast but don't fail the booking.

Also after successful insurance creation for customer_provided type, call updateCustomerInsuranceCache to persist for future pre-fill.

In the Review section: add an insurance summary card showing the entered insurance info. If any auto-computed flags fail (run validateInsuranceCoverage), show an amber warning: "Insurance issues detected. You can still create the booking and verify later." This is the soft-block behavior per CONTEXT.md.

**Rentals.tsx changes:**

1. **Import InsuranceVerification component** at the top of the file.

2. **Import insurance types and service functions:**
   - Import `RentalInsurance`, `InsuranceVerificationStatus`, `INSURANCE_STATUS_LABELS` from types.
   - Import `getInsuranceForBooking` from insuranceService (only if needed for batch loading; otherwise badges can use the booking.insurance join).

3. **Stats bar update:**
   Add an "Unverified" stat to the existing stats computation in the `useMemo`. Count bookings where status is 'active' or 'reserved' that don't have insurance with verification_status='verified' or 'overridden'. Display it after the overdueCount stat, styled with a Shield icon and amber color if count > 0.

   To get insurance data for stats: When loading bookings, the insurance data needs to be available. Add insurance to the booking query join. In the existing booking fetch (wherever getAllBookings or similar is called), add a `.select('*, rental_insurance(*)')` pattern OR do a separate batch fetch of insurance records for active bookings. The simpler approach: fetch insurance status for all active/reserved bookings in the stats useMemo via a separate state variable `insuranceMap: Record<string, InsuranceVerificationStatus>` loaded once when bookings load.

   Actually, the cleanest approach following existing patterns: add `insurance` to the RentalBooking select join in the store/rental module or wherever bookings are fetched. If this requires modifying `transformBooking` in rentalService.ts, do it -- add a line to parse nested rental_insurance if present, similar to how rental_customers and rental_payments are already joined. This avoids N+1 queries.

   **If modifying rentalService.ts transformBooking:** Add `insurance: data.rental_insurance ? transformInsurance(data.rental_insurance) : undefined` to the transformer. Import transformInsurance from insuranceService.ts. Update the getAllBookings select string to include `rental_insurance(*)`.

4. **Insurance badge on booking rows in Active Rentals tab:**
   On each booking row (the clickable row that expands to BookingDetail), add a small badge next to the existing status badge:
   - No insurance record: gray "No Insurance" badge.
   - pending: gray "Ins: Pending" badge.
   - verified: green "Ins: Verified" badge with Shield check icon.
   - failed: red "Ins: Failed" badge.
   - overridden: amber "Ins: Override" badge.
   Keep badges small (text-[10px]) to not crowd the row. Use the INSURANCE_STATUS_COLORS pattern from RESEARCH.md.

5. **InsuranceVerification in BookingDetail:**
   Inside the BookingDetail component, add a new section (collapsible, like the existing payment or condition report sections) titled "Insurance Verification" with a Shield icon. Render `<InsuranceVerification booking={booking} onRefresh={onRefresh} />`.

   Place this section ABOVE the payment section in the BookingDetail layout, since insurance should be verified before money changes hands.

6. **BookingDetailProps does NOT change** -- InsuranceVerification gets booking from the existing prop.

**Critical: Do NOT break the existing 2060-line Rentals.tsx.** Test the build after changes. The insurance additions should be additive -- new sections, new stats, new badges -- not restructuring existing code. Read the full file before making changes.

**Critical: Do NOT break the existing 1207-line RentalBookingModal.tsx.** The insurance subsection goes inside the existing terms section render block. Read the full file before making changes.
  </action>
  <verify>
1. `npm run build` or `npx vite build` succeeds without new errors
2. RentalBookingModal has insurance fields in the terms/Agreement section
3. RentalBookingModal review section shows insurance summary with warnings
4. Rentals.tsx stats bar shows Unverified count
5. Rentals.tsx Active Rentals rows show insurance status badges
6. Rentals.tsx BookingDetail contains InsuranceVerification component
7. SectionKey type and SECTIONS array are unchanged in RentalBookingModal
8. Insurance creation happens AFTER booking creation (not blocking the booking)
  </verify>
  <done>
RentalBookingModal extended with insurance capture subsection in Agreement tab (customer provided and dealer coverage types, pre-fill from customer history, soft-block warnings in review). Rentals.tsx extended with insurance status badges on booking rows, unverified count in stats bar, and InsuranceVerification panel in BookingDetail. Build passes.
  </done>
</task>

</tasks>

<verification>
1. Build compiles without new errors
2. InsuranceVerification component renders inline in BookingDetail (not as modal)
3. Insurance capture is inside Agreement section (not a new tab/section)
4. Status badges visible on Active Rentals booking rows
5. Stats bar shows Unverified count
6. Override pattern matches RegistrationChecker (amber button, notes, logged)
7. Soft block behavior: booking creation succeeds even with insurance warnings
8. Insurance card upload works (file input, display thumbnail)
</verification>

<success_criteria>
- RINS-01: Insurance info captured (company, policy, dates, coverage) in booking modal and editable in BookingDetail
- RINS-02: Insurance card upload available in InsuranceVerification component
- RINS-03: Coverage verification flags auto-computed against Texas 30/60/25 minimums, displayed with pass/fail indicators
- Insurance status visible at all levels: badge on row, full panel in BookingDetail, count in stats bar
- Dual verification: system flags + admin final call with override option
</success_criteria>

<output>
After completion, create `.planning/phases/08-rental-insurance-verification/08-02-SUMMARY.md`
</output>
