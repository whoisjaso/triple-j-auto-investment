---
phase: 06-rental-management-core
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - triple-j-auto-investment-main/supabase/migrations/06_rental_schema.sql
autonomous: true

must_haves:
  truths:
    - "Rental tables exist with proper constraints and relationships"
    - "Double-booking is prevented at the database level via EXCLUDE constraint"
    - "Booking IDs are human-readable (TJ-R-YYYY-NNNN)"
    - "Vehicle listing_type column allows sale_only, rental_only, or both"
  artifacts:
    - path: "triple-j-auto-investment-main/supabase/migrations/06_rental_schema.sql"
      provides: "Complete rental database schema"
      contains: "CREATE EXTENSION IF NOT EXISTS btree_gist"
  key_links:
    - from: "rental_bookings"
      to: "vehicles"
      via: "vehicle_id FK"
      pattern: "REFERENCES public\\.vehicles"
    - from: "rental_bookings"
      to: "rental_customers"
      via: "customer_id FK"
      pattern: "REFERENCES public\\.rental_customers"
    - from: "rental_payments"
      to: "rental_bookings"
      via: "booking_id FK"
      pattern: "REFERENCES public\\.rental_bookings"
---

<objective>
Create the complete database schema for the rental management system.

Purpose: All rental features (bookings, agreements, payments, condition reports) depend on having proper tables with constraints. The database-level double-booking prevention is a Phase 6 success criterion -- it must be an EXCLUDE constraint, not application-level logic.

Output: A single SQL migration file containing all rental tables, extensions, functions, triggers, RLS policies, and indexes.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-rental-management-core/06-CONTEXT.md
@.planning/phases/06-rental-management-core/06-RESEARCH.md
@triple-j-auto-investment-main/supabase/schema.sql
@triple-j-auto-investment-main/supabase/migrations/02_registration_schema_update.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create rental database migration SQL</name>
  <files>triple-j-auto-investment-main/supabase/migrations/06_rental_schema.sql</files>
  <action>
Create a comprehensive SQL migration file with the following sections, in order:

1. **Enable btree_gist extension** (required for EXCLUDE constraint):
   ```sql
   CREATE EXTENSION IF NOT EXISTS btree_gist;
   ```

2. **Extend vehicles table** with rental fields:
   - `listing_type TEXT DEFAULT 'sale_only' CHECK (listing_type IN ('sale_only', 'rental_only', 'both'))`
   - `daily_rate DECIMAL(10, 2)` -- nullable, only needed for rental vehicles
   - `weekly_rate DECIMAL(10, 2)` -- nullable
   - `min_rental_days INTEGER DEFAULT 1`
   - `max_rental_days INTEGER DEFAULT 30`
   - Use `ADD COLUMN IF NOT EXISTS` for idempotency

3. **Create rental_customers table**:
   - UUID primary key
   - Required: full_name, phone, drivers_license_number, address
   - Optional: email, emergency_contact_name, emergency_contact_phone, employer_name, employer_phone, notes
   - Timestamps: created_at, updated_at

4. **Create rental_bookings table** (core entity):
   - UUID primary key
   - booking_id VARCHAR(20) UNIQUE NOT NULL -- human-readable TJ-R-YYYY-NNNN
   - FKs: vehicle_id -> vehicles, customer_id -> rental_customers
   - Dates: start_date DATE, end_date DATE, actual_return_date DATE (nullable)
   - Rates: daily_rate, weekly_rate (nullable), total_cost -- all DECIMAL(10,2)
   - Status: CHECK (status IN ('reserved', 'active', 'returned', 'cancelled', 'overdue'))
   - Agreement fields: agreement_signed BOOLEAN, agreement_pdf_url TEXT, signature_data TEXT
   - Authorized drivers: JSONB array
   - Geographic: out_of_state_permitted BOOLEAN, permitted_states JSONB
   - Mileage: mileage_out INTEGER, mileage_in INTEGER, mileage_limit INTEGER
   - Late fees: late_fee_override DECIMAL(10,2) nullable, late_fee_notes TEXT
   - Admin notes TEXT
   - Timestamps
   - **EXCLUDE USING gist** constraint for double-booking prevention:
     ```sql
     CONSTRAINT prevent_double_booking
       EXCLUDE USING gist (
         vehicle_id WITH =,
         daterange(start_date, end_date, '[)') WITH &&
       ) WHERE (status NOT IN ('cancelled', 'returned'))
     ```

5. **Create rental_payments table**:
   - UUID primary key
   - booking_id FK -> rental_bookings ON DELETE CASCADE
   - amount DECIMAL(10,2), payment_method CHECK ('cash','card','zelle','cashapp')
   - payment_date DATE DEFAULT CURRENT_DATE
   - notes, recorded_by TEXT
   - created_at

6. **Create rental_condition_reports table**:
   - UUID primary key
   - booking_id FK -> rental_bookings ON DELETE CASCADE
   - report_type CHECK ('checkout', 'return')
   - checklist_items JSONB (array of {category, item, condition, notes})
   - fuel_level CHECK ('empty','1/4','1/2','3/4','full')
   - mileage INTEGER NOT NULL
   - photo_urls JSONB (array of Supabase Storage URLs)
   - completed_by TEXT, completed_at TIMESTAMPTZ
   - created_at

7. **Create generate_rental_booking_id() function**:
   - Format: TJ-R-YYYY-NNNN (e.g., TJ-R-2026-0001)
   - Sequential per year, zero-padded to 4 digits
   - Query MAX from existing booking_ids for current year

8. **Create trigger** to auto-populate booking_id on INSERT:
   - BEFORE INSERT trigger calls generate_rental_booking_id()
   - Only sets booking_id if NEW.booking_id IS NULL

9. **Create updated_at triggers** for rental_customers and rental_bookings tables (same pattern as vehicles table)

10. **Create indexes**:
    - rental_bookings: vehicle_id, customer_id, status, start_date, end_date
    - rental_payments: booking_id
    - rental_condition_reports: booking_id
    - vehicles: listing_type

11. **Create RLS policies**:
    - All rental tables: Enable RLS
    - Admin policies (using is_admin from profiles): Full CRUD on all rental tables
    - Public/anon: No access to rental tables (admin-only feature)
    - Follow the same RLS pattern as registration tables in 02_registration_schema_update.sql

Include comments for each section. Use IF NOT EXISTS / IF EXISTS guards for idempotency.

DO NOT modify the existing vehicles.status CHECK constraint -- listing_type is a separate column.
  </action>
  <verify>
  Open the SQL file and verify:
  1. `btree_gist` extension is enabled BEFORE the EXCLUDE constraint
  2. All 4 new tables created (rental_customers, rental_bookings, rental_payments, rental_condition_reports)
  3. vehicles ALTER TABLE adds 5 columns with IF NOT EXISTS
  4. EXCLUDE USING gist constraint exists on rental_bookings
  5. generate_rental_booking_id() function and trigger exist
  6. RLS policies exist for all tables
  7. No modifications to vehicles.status CHECK constraint
  </verify>
  <done>
  A complete, idempotent SQL migration file exists at supabase/migrations/06_rental_schema.sql covering all rental tables, the EXCLUDE double-booking constraint, booking ID generation, RLS policies, and indexes.
  </done>
</task>

</tasks>

<verification>
- SQL file is syntactically valid (no obvious syntax errors on review)
- btree_gist extension precedes EXCLUDE constraint
- All foreign keys reference correct tables
- DATE type used for start_date/end_date (not TIMESTAMPTZ) per research pitfall #4
- RLS enabled on all new tables
- No collision with existing vehicles.status enum
</verification>

<success_criteria>
- Migration file covers all 5 new database objects (4 tables + vehicles ALTER)
- Double-booking prevented by EXCLUDE USING gist constraint
- Booking IDs auto-generated as TJ-R-YYYY-NNNN
- RLS policies restrict rental tables to admin users
</success_criteria>

<output>
After completion, create `.planning/phases/06-rental-management-core/06-01-SUMMARY.md`
</output>
