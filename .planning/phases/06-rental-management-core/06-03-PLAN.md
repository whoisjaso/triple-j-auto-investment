---
phase: 06-rental-management-core
plan: 03
type: execute
wave: 3
depends_on: ["06-02"]
files_modified:
  - triple-j-auto-investment-main/pages/admin/Rentals.tsx
  - triple-j-auto-investment-main/components/admin/RentalCalendar.tsx
  - triple-j-auto-investment-main/App.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can navigate to /admin/rentals from the header"
    - "Calendar shows all bookings for the visible month with color-coded status"
    - "Active rentals tab shows who has each vehicle and when it's due back"
    - "Overdue rentals are highlighted in red on both calendar and active list"
    - "Admin can mark vehicles as sale-only, rental-only, or both from the rentals page"
  artifacts:
    - path: "triple-j-auto-investment-main/pages/admin/Rentals.tsx"
      provides: "Main rental management page with tabs"
      min_lines: 200
    - path: "triple-j-auto-investment-main/components/admin/RentalCalendar.tsx"
      provides: "Monthly grid calendar for booking visualization"
      min_lines: 150
    - path: "triple-j-auto-investment-main/App.tsx"
      provides: "Route for /admin/rentals"
      contains: "admin/rentals"
  key_links:
    - from: "triple-j-auto-investment-main/pages/admin/Rentals.tsx"
      to: "triple-j-auto-investment-main/services/rentalService.ts"
      via: "service imports for data fetching"
      pattern: "from.*services/rentalService"
    - from: "triple-j-auto-investment-main/pages/admin/Rentals.tsx"
      to: "triple-j-auto-investment-main/context/Store.tsx"
      via: "useStore for bookings state"
      pattern: "useStore"
    - from: "triple-j-auto-investment-main/App.tsx"
      to: "triple-j-auto-investment-main/pages/admin/Rentals.tsx"
      via: "lazy loaded route"
      pattern: "import.*admin/Rentals"
---

<objective>
Create the main Rentals admin page with calendar view, active rentals list, and vehicle classification controls.

Purpose: This is the primary admin interface for rental management. It provides the calendar visualization (RENT-02), active rental tracking (RENT-04), and vehicle listing type controls (RENT-01). Other plans add booking creation, agreements, and payments as modals launched from this page.

Output: Rentals.tsx page with tab navigation (Calendar / Active / Fleet), RentalCalendar.tsx component, and App.tsx route wiring.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-rental-management-core/06-CONTEXT.md
@.planning/phases/06-rental-management-core/06-RESEARCH.md
@.planning/phases/06-rental-management-core/06-01-SUMMARY.md
@.planning/phases/06-rental-management-core/06-02-SUMMARY.md
@triple-j-auto-investment-main/pages/admin/Dashboard.tsx
@triple-j-auto-investment-main/pages/admin/Registrations.tsx
@triple-j-auto-investment-main/App.tsx
@triple-j-auto-investment-main/types.ts
@triple-j-auto-investment-main/services/rentalService.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RentalCalendar component</name>
  <files>triple-j-auto-investment-main/components/admin/RentalCalendar.tsx</files>
  <action>
Create a custom monthly calendar grid component. NO third-party calendar libraries. Build with Tailwind CSS `grid-cols-7`.

**Props:**
```typescript
interface RentalCalendarProps {
  bookings: RentalBooking[];
  onDateClick?: (date: string) => void;
  onBookingClick?: (booking: RentalBooking) => void;
}
```

**State:**
- `currentYear` and `currentMonth` (0-indexed) -- default to current date
- Navigate with prev/next month buttons

**Calendar math:**
- `getDaysInMonth(year, month)`: `new Date(year, month + 1, 0).getDate()`
- `getFirstDayOfWeek(year, month)`: `new Date(year, month, 1).getDay()` (0=Sunday)
- Generate array of day numbers, prefixed with empty cells for the offset

**Rendering:**
1. **Header**: Month/Year display with prev (<) and next (>) navigation arrows. "Today" button to jump back.
2. **Day labels row**: Sun Mon Tue Wed Thu Fri Sat
3. **Grid** (`grid grid-cols-7 gap-px bg-white/10`):
   - Each cell: date number at top, then booking bars below
   - Empty cells (before first day, after last day) render as darker background
   - Today's date: highlighted border (tj-gold)
4. **Booking bars**: For each day, find bookings that overlap (booking.startDate <= thisDate AND booking.endDate > thisDate). Render as colored horizontal bars:
   - `reserved`: blue (`bg-blue-500/80`)
   - `active`: green (`bg-emerald-500/80`)
   - `overdue`: red (`bg-red-500/80`) -- also add pulsing animation
   - `returned`: gray (`bg-gray-500/50`)
   - `cancelled`: hidden (don't render)
   - Show vehicle make/model on the bar (truncated), customer name on hover (title attribute)
   - Bar spans the full cell width. If booking starts on this day, add left rounded corner. If booking ends on this day, add right rounded corner.
   - Clicking a booking bar calls `onBookingClick`
5. **Cell click**: Clicking a day cell calls `onDateClick` with the date string (YYYY-MM-DD)

**Styling**: Dark theme matching existing admin pages. Use bg-black/40 for cells, white text, tj-gold accents. Max 4-5 booking bars visible per cell, with a "+N more" indicator if overflow.

**Data fetching**: The parent (Rentals.tsx) passes bookings. The calendar component itself uses `useMemo` to build a `Map<string, RentalBooking[]>` keyed by date string for O(1) lookup per cell.

**Important pitfall from research**: Bookings spanning month boundaries must still appear. The parent queries with `getBookingsForMonth` which uses `start_date <= month_end AND end_date >= month_start`. The calendar should render the bars for all visible days including overflow into adjacent months if showing those cells.
  </action>
  <verify>Verify the file exists, imports RentalBooking from types, uses grid-cols-7, handles month navigation, and color-codes booking status.</verify>
  <done>RentalCalendar.tsx renders a monthly grid with booking bars, month navigation, status-based coloring, and click handlers.</done>
</task>

<task type="auto">
  <name>Task 2: Create Rentals page and wire routing</name>
  <files>
    triple-j-auto-investment-main/pages/admin/Rentals.tsx
    triple-j-auto-investment-main/App.tsx
  </files>
  <action>
**A. Create `pages/admin/Rentals.tsx`:**

Follow the exact same structural pattern as Dashboard.tsx and Registrations.tsx.

1. **AdminHeader**: Copy the AdminHeader component from Dashboard.tsx (yes, duplicate it -- per research guidance on pitfall #7). Add "Rentals" to navItems:
   ```typescript
   const navItems = [
     { path: '/admin/dashboard', label: 'Dashboard', icon: LayoutDashboard },
     { path: '/admin/inventory', label: 'Inventory', icon: Car },
     { path: '/admin/registrations', label: 'Registrations', icon: ClipboardCheck },
     { path: '/admin/rentals', label: 'Rentals', icon: Key },
   ];
   ```
   Use `Key` from lucide-react for the Rentals icon.

2. **Stats Bar** at top (same style as Registrations.tsx stats bar):
   - Total Bookings (count all non-cancelled)
   - Active (status = 'active')
   - Overdue (status = 'overdue')
   - Fleet Size (vehicles with listing_type IN rental_only, both)
   Show overdue count with red badge/highlight.

3. **Tab Navigation**: Three tabs styled like segmented control:
   - **Calendar** (default) -- shows RentalCalendar
   - **Active Rentals** -- shows list of active + overdue bookings
   - **Fleet** -- shows vehicles available for rent with listing_type controls

4. **Calendar Tab**:
   - Render `<RentalCalendar>` component
   - Pass bookings from store state (or fetch via getBookingsForMonth on month change)
   - "New Booking" button (top right, tj-gold) -- for now just sets a `showBookingModal` state to true (the modal comes in Plan 04)
   - When a date is clicked, open booking modal with that date pre-filled
   - When a booking bar is clicked, show booking detail (expand inline or modal -- use inline expansion for now, detail modal comes later)

5. **Active Rentals Tab**:
   - Table/card list of all bookings with status 'active' or 'overdue'
   - Columns: Booking ID, Vehicle (year make model), Customer Name, Start Date, End Date, Days Remaining / Days Overdue, Late Fee (calculated), Status badge
   - Overdue rows: red background tint, "OVERDUE" badge in red
   - Active rows: green status badge
   - Late fee column: show calculated amount using `calculateLateFee` from rentalService. If waived, show "Waived" in gray.
   - Actions column: "Return" button (calls returnBooking from service), "View" button
   - Sort by: overdue first, then by end_date ascending (soonest due back on top)

6. **Fleet Tab**:
   - List all vehicles from useStore(), each with a listing_type selector
   - Show: Vehicle image thumbnail, Year Make Model, VIN, Current Status, Listing Type dropdown
   - Listing type dropdown: Sale Only / Rental Only / Both (calls updateVehicleListingType on change)
   - If listing_type is 'rental_only' or 'both', show Daily Rate and Weekly Rate input fields (inline editable, save on blur via updateVehicleRentalRates)
   - If vehicle has active booking, show "Currently Rented" badge with customer name and return date
   - Filter: "All" / "Rental Fleet Only" toggle (default: Rental Fleet Only when on Fleet tab)

7. **State management**:
   - Use `useStore()` for bookings and vehicles
   - Use `useState` for active tab, loading states, modal visibility
   - Call `refreshBookings()` after any mutation (create, cancel, return)

8. **Placeholder hooks for modals** (created in Plans 04-05):
   - `showBookingModal` / `setShowBookingModal` state
   - `showAgreementModal` / `setShowAgreementModal` state
   - `selectedBooking` / `setSelectedBooking` state
   - Render placeholder comments where modals will be inserted: `{/* RentalBookingModal will be added by Plan 04 */}`

**B. Update App.tsx:**

1. Add lazy import:
   ```typescript
   const AdminRentals = lazyWithErrorHandling(() => import('./pages/admin/Rentals'), 'Admin Rentals');
   ```

2. Add route inside ProtectedRoute section (after the registrations route):
   ```typescript
   <Route path="/admin/rentals" element={<ProtectedRoute><AdminRentals /></ProtectedRoute>} />
   ```

3. Add "Rentals" nav link to BOTH the desktop and mobile navigation sections in the Navbar component. Add it after the Registrations link. Use the Key icon from lucide-react. The link path is "/admin/rentals".

4. Import `Key` from lucide-react at the top of App.tsx.

**Important**: Also update the AdminHeader in Dashboard.tsx and Inventory.tsx (and Registrations.tsx if it has its own) to add the Rentals nav item. Each admin page has its own AdminHeader with navItems -- add the Rentals entry to ALL of them so navigation is consistent.
  </action>
  <verify>
  Run `npx tsc --noEmit` to verify the build passes. Check that:
  1. App.tsx has the /admin/rentals route
  2. Rentals.tsx has AdminHeader with Rentals in navItems
  3. All other admin pages' AdminHeader navItems arrays include Rentals
  4. RentalCalendar is imported and rendered in the Calendar tab
  </verify>
  <done>
  Rentals.tsx exists with Calendar/Active Rentals/Fleet tabs. Calendar shows monthly grid with booking bars. Active Rentals shows current renters with overdue highlighting. Fleet tab has listing_type controls. Route is wired in App.tsx. All AdminHeaders updated with Rentals nav item. Build passes.
  </done>
</task>

</tasks>

<verification>
- Navigate to /admin/rentals route exists in App.tsx
- Calendar renders grid-cols-7 with booking status colors
- Active Rentals tab shows overdue bookings with red highlighting
- Fleet tab allows changing vehicle listing_type
- All admin pages' AdminHeader navItems include Rentals link
- Build passes with `npx tsc --noEmit`
</verification>

<success_criteria>
- RENT-01 (dual inventory): Fleet tab allows marking vehicles as sale-only/rental-only/both
- RENT-02 (availability calendar): Calendar tab shows monthly grid with color-coded bookings
- RENT-04 (rental tracking): Active Rentals tab shows who has what car and when it's due back
- Overdue rentals surfaced via red highlighting on calendar and active rentals list
- Admin can navigate to Rentals from any admin page
</success_criteria>

<output>
After completion, create `.planning/phases/06-rental-management-core/06-03-SUMMARY.md`
</output>
