---
phase: 06-rental-management-core
plan: 06
type: execute
wave: 4
depends_on: ["06-03", "06-04", "06-05"]
files_modified:
  - triple-j-auto-investment-main/pages/admin/Rentals.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can record payments with mixed methods (cash, card, Zelle, CashApp)"
    - "Each booking shows running balance (total cost vs payments made vs remaining)"
    - "Customer running total across all rentals is visible"
    - "Late fees auto-calculated from daily rate and days overdue"
    - "Admin can override or waive late fees"
    - "All modals (booking, agreement, condition report) are integrated into Rentals page"
  artifacts:
    - path: "triple-j-auto-investment-main/pages/admin/Rentals.tsx"
      provides: "Complete rental management page with all modals integrated"
      contains: "RentalBookingModal"
  key_links:
    - from: "triple-j-auto-investment-main/pages/admin/Rentals.tsx"
      to: "triple-j-auto-investment-main/components/admin/RentalBookingModal.tsx"
      via: "modal rendering"
      pattern: "RentalBookingModal"
    - from: "triple-j-auto-investment-main/pages/admin/Rentals.tsx"
      to: "triple-j-auto-investment-main/components/admin/RentalAgreementModal.tsx"
      via: "modal rendering"
      pattern: "RentalAgreementModal"
    - from: "triple-j-auto-investment-main/pages/admin/Rentals.tsx"
      to: "triple-j-auto-investment-main/components/admin/RentalConditionReport.tsx"
      via: "inline rendering"
      pattern: "RentalConditionReport"
---

<objective>
Integrate all rental components into the Rentals page: payment tracking, late fee management, and full modal wiring.

Purpose: This final plan connects all the pieces built in Plans 03-05. It adds payment recording (RENT-06), late fee management, and wires the booking modal, agreement modal, and condition report into the Rentals page. After this plan, the full rental management workflow is operational end-to-end.

Output: Updated Rentals.tsx with payment recording, late fee management, booking detail view, and all modals integrated.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-rental-management-core/06-CONTEXT.md
@.planning/phases/06-rental-management-core/06-RESEARCH.md
@.planning/phases/06-rental-management-core/06-03-SUMMARY.md
@.planning/phases/06-rental-management-core/06-04-SUMMARY.md
@.planning/phases/06-rental-management-core/06-05-SUMMARY.md
@triple-j-auto-investment-main/pages/admin/Rentals.tsx
@triple-j-auto-investment-main/components/admin/RentalBookingModal.tsx
@triple-j-auto-investment-main/components/admin/RentalAgreementModal.tsx
@triple-j-auto-investment-main/components/admin/RentalConditionReport.tsx
@triple-j-auto-investment-main/components/admin/SignatureCapture.tsx
@triple-j-auto-investment-main/services/rentalService.ts
@triple-j-auto-investment-main/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add booking detail view with payments and late fees</name>
  <files>triple-j-auto-investment-main/pages/admin/Rentals.tsx</files>
  <action>
Update Rentals.tsx to add a booking detail/expansion view and payment recording capabilities.

**A. Booking Detail Expansion (inline, not modal):**

When admin clicks a booking (from Active Rentals tab, or from calendar booking bar click), expand an inline detail section below the row (same pattern as RegistrationChecker expanding inside Registrations.tsx).

The expanded detail view shows:

1. **Booking Header**:
   - Booking ID (TJ-R-YYYY-NNNN), Status badge (colored)
   - Customer name, phone, DL# (linked to customer info)
   - Vehicle: year make model with image thumbnail

2. **Dates & Cost**:
   - Start date, End date, Actual return date (if returned)
   - Duration (days)
   - Daily rate, Weekly rate
   - Total cost
   - Late fee (auto-calculated using calculateLateFee from rentalService)
   - Grand total (total cost + late fee)

3. **Late Fee Management** (only shown if booking is overdue or returned late):
   - Calculated late fee display: "X days overdue x $Y/day = $Z"
   - "Override" button: opens an inline form with amount input + notes field
   - "Waive" button: sets override to 0 with "Waived by admin" note
   - Once overridden: show "Overridden: $X" with notes, and a "Reset to auto-calculate" option
   - Late fee overrides are saved via updateBooking (late_fee_override, late_fee_notes fields)

4. **Payments Section**:
   - Table of existing payments: Date, Amount, Method (with PAYMENT_METHOD_LABELS), Recorded By, Notes
   - **Balance summary bar**:
     - Total Cost: $X
     - Late Fees: $Y (or "Waived")
     - Payments: $Z
     - **Remaining: $W** (Total + Late Fees - Payments) -- highlighted in red if > 0, green if 0
   - **Record Payment form** (inline, below the table):
     - Amount input (pre-fill with remaining balance)
     - Payment method: 4 toggle buttons (Cash, Card, Zelle, CashApp) using PAYMENT_METHOD_LABELS
     - Notes: optional text input
     - "Record Payment" button
     - On submit: call createPayment from rentalService, refresh bookings
   - "Delete" button per payment row (with confirmation): calls deletePayment

5. **Customer Balance** (small section):
   - "Customer total across all rentals": Sum of all bookings for this customer
   - "Total paid across all rentals": Sum of all payments for this customer's bookings
   - "Outstanding balance": Difference
   - This requires fetching all bookings for the customer -- use a derived calculation from the bookings state (filter by customer_id)

6. **Actions bar** (bottom of expanded detail):
   - "Generate Agreement" button -> opens RentalAgreementModal (pass booking, customer, vehicle)
   - "Checkout Report" button -> expands RentalConditionReport (reportType: 'checkout')
   - "Return Report" button -> expands RentalConditionReport (reportType: 'return')
   - "Cancel Booking" button (red, with confirmation dialog) -> calls cancelBooking
   - "Process Return" button (shown only for active/overdue bookings):
     - Opens a small inline form: actual return date (default today), mileage in (number input)
     - "Confirm Return" button -> calls returnBooking from rentalService
     - Prompts to complete return condition report if not yet done

**B. Wire all modals:**

Replace the placeholder comments from Plan 03 with actual modal rendering:

1. Import RentalBookingModal, RentalAgreementModal, RentalConditionReport, SignatureCapture
2. Render `<RentalBookingModal>` at the bottom of the component, controlled by showBookingModal state
3. Render `<RentalAgreementModal>` controlled by showAgreementModal state
4. Pass appropriate callbacks:
   - `onBookingCreated`: call refreshBookings
   - `onAgreementSigned`: call refreshBookings (to update agreement_signed status)
   - `onComplete` for condition reports: show success toast/message, refresh

**C. Enhance Calendar tab:**

When clicking a booking bar on the calendar, set selectedBooking and switch to Active Rentals tab (or scroll to that booking's expanded detail). This connects the calendar visualization to the detail view.

**D. Enhance Active Rentals tab:**

- Add "Expand" toggle per row (chevron icon) to show/hide the detail section
- Default: all collapsed. Clicking expands one at a time (accordion behavior, or allow multiple).
- Show booking ID, vehicle, customer, dates, status, late fee in the collapsed row
- Expanded row shows the full detail view from section A above

**E. Overdue badge in Dashboard integration** (CONTEXT.md: "dashboard alert badge"):
This is just a count in the stats bar. The stats bar already shows Overdue count from Plan 03. Ensure the overdue count uses a red badge with the number, not just text. If overdue > 0, pulse the badge.

**F. Refresh pattern:**
After any mutation (create booking, record payment, cancel, return), call refreshBookings from useStore. This triggers re-render of all tabs.
  </action>
  <verify>
  Run `npx tsc --noEmit` to verify build passes. Visually confirm:
  1. RentalBookingModal is imported and rendered
  2. RentalAgreementModal is imported and rendered
  3. RentalConditionReport is imported and rendered
  4. Payment recording form exists with amount, method toggle, notes
  5. Late fee management section with override/waive exists
  6. Balance summary shows total - payments = remaining
  7. Customer running total section exists
  </verify>
  <done>
  Rentals.tsx is the complete rental management hub with:
  - Booking detail expansion with full info
  - Payment recording with mixed methods and running balance
  - Late fee auto-calculation with admin override/waive
  - Customer total across all rentals
  - All modals wired (booking creation, agreement generation, condition reports)
  - Process return flow with mileage capture
  - Build passes
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
  Complete rental management system:
  - Database schema with double-booking prevention
  - Service layer with full CRUD
  - Calendar view with color-coded bookings
  - Active rentals tracking with overdue highlighting
  - Fleet management with listing_type controls
  - Booking creation with customer profiles
  - Rental agreement PDF with digital signature
  - Vehicle condition reports with photo upload
  - Payment tracking with balance calculation
  - Late fee management with override/waive
  </what-built>
  <how-to-verify>
  1. Navigate to /admin/rentals -- verify page loads with Calendar/Active Rentals/Fleet tabs
  2. Fleet tab: Change a vehicle's listing type to "both" -- verify dropdown saves
  3. Set daily rate on a rental vehicle -- verify inline editing works
  4. Calendar tab: Click "New Booking" -- verify modal opens with customer/vehicle/date sections
  5. Active Rentals tab: Verify table renders (may be empty if no bookings exist yet)
  6. Check that all admin pages (Dashboard, Inventory, Registrations, Rentals) show "Rentals" in the navigation header
  7. Run `npx tsc --noEmit` from triple-j-auto-investment-main/ -- verify build passes

  NOTE: Full end-to-end testing (create booking, generate agreement, record payment) requires the Supabase migration (06_rental_schema.sql) to be applied. Verify the SQL file exists and appears syntactically correct.
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
- All 6 PLAN.md files' components are integrated into a working Rentals page
- Payment recording creates entries in rental_payments via rentalService
- Late fees calculated client-side, overrides saved to booking record
- Balance = totalCost + lateFee - sum(payments)
- Customer running total aggregated from all their bookings
- All 3 modals (booking, agreement, condition report) launch from detail view
- Return flow captures actual return date and mileage
- Build passes with `npx tsc --noEmit`
</verification>

<success_criteria>
- RENT-06 (deposits and payments): Payments tracked per booking with running balance, mixed payment methods supported
- RENT-01 through RENT-04: All requirements have corresponding UI integrated
- Late fees auto-calculated with admin override capability
- End-to-end workflow possible: Fleet setup -> Create Booking -> Checkout Report -> Agreement -> Record Payments -> Process Return -> Return Report
- Human verification confirms UI loads and navigation works
</success_criteria>

<output>
After completion, create `.planning/phases/06-rental-management-core/06-06-SUMMARY.md`
</output>
