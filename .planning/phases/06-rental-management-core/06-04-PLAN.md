---
phase: 06-rental-management-core
plan: 04
type: execute
wave: 3
depends_on: ["06-02"]
files_modified:
  - triple-j-auto-investment-main/components/admin/RentalBookingModal.tsx
  - triple-j-auto-investment-main/components/admin/RentalConditionReport.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can create a new booking with full customer profile and vehicle selection"
    - "Booking modal prevents selecting unavailable vehicles for the chosen date range"
    - "Condition report captures walk-around checklist with per-item condition ratings"
    - "Condition report supports photo upload for pre-existing damage documentation"
    - "Customer search finds existing customers to avoid duplicate entry"
  artifacts:
    - path: "triple-j-auto-investment-main/components/admin/RentalBookingModal.tsx"
      provides: "Full booking creation/edit modal"
      min_lines: 300
    - path: "triple-j-auto-investment-main/components/admin/RentalConditionReport.tsx"
      provides: "Vehicle condition checklist with photo upload"
      min_lines: 200
  key_links:
    - from: "triple-j-auto-investment-main/components/admin/RentalBookingModal.tsx"
      to: "triple-j-auto-investment-main/services/rentalService.ts"
      via: "createBooking, createCustomer, getAvailableVehicles"
      pattern: "from.*services/rentalService"
    - from: "triple-j-auto-investment-main/components/admin/RentalConditionReport.tsx"
      to: "triple-j-auto-investment-main/services/rentalService.ts"
      via: "createConditionReport"
      pattern: "from.*services/rentalService"
---

<objective>
Create the booking creation modal and vehicle condition report component.

Purpose: The booking modal is how admin creates new rentals, capturing full customer profiles (RENT-04 customer tracking) and preventing double-bookings at the UI level. The condition report provides walk-around documentation at checkout and return, protecting the dealer in damage disputes.

Output: RentalBookingModal.tsx for booking creation/editing, RentalConditionReport.tsx for vehicle condition documentation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-rental-management-core/06-CONTEXT.md
@.planning/phases/06-rental-management-core/06-RESEARCH.md
@.planning/phases/06-rental-management-core/06-02-SUMMARY.md
@triple-j-auto-investment-main/components/admin/BillOfSaleModal.tsx
@triple-j-auto-investment-main/types.ts
@triple-j-auto-investment-main/services/rentalService.ts
@triple-j-auto-investment-main/hooks/useScrollLock.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RentalBookingModal</name>
  <files>triple-j-auto-investment-main/components/admin/RentalBookingModal.tsx</files>
  <action>
Create a full-page portal modal following the BillOfSaleModal pattern (createPortal, AnimatePresence, useScrollLock).

**Props:**
```typescript
interface RentalBookingModalProps {
  isOpen: boolean;
  onClose: () => void;
  onBookingCreated: () => void;  // callback to refresh parent
  vehicles: Vehicle[];
  preSelectedDate?: string;      // YYYY-MM-DD from calendar click
  editBooking?: RentalBooking;   // null for new, populated for edit
}
```

**Layout**: Two-panel layout on desktop (form left, summary right), stacked on mobile.

**Multi-step form** with 4 sections (use tab/section navigation, not separate pages):

**Section 1: Customer Information**
- Search bar at top: type to search existing customers by name/phone/DL (calls searchCustomers from rentalService)
- If match found: show selectable results, clicking one auto-fills all fields
- "New Customer" button to clear and start fresh
- Fields (all in a clean form grid):
  - Full Name (required)
  - Phone (required)
  - Email (optional)
  - Driver's License Number (required)
  - Full Address (required) -- use AddressInput component if available, otherwise plain text input
  - Emergency Contact Name + Phone (optional, side by side)
  - Employer Name + Phone (optional, side by side)
  - Notes (optional textarea)

**Section 2: Vehicle & Dates**
- Date range: Start Date and End Date inputs (type="date")
  - If preSelectedDate provided, default start_date to that date
  - End date defaults to start + 3 days
  - Validate: end > start, duration within min/max rental days for selected vehicle
- Vehicle selector: Show only vehicles available for the selected date range
  - Fetch available vehicles via `getAvailableVehicles(startDate, endDate)` when dates change
  - Show each vehicle as a card: image, year make model, VIN, daily rate, weekly rate
  - Clicking selects it (highlight with tj-gold border)
  - If no vehicle pre-selected and only one available, auto-select it
- Rate display: Show daily rate and weekly rate from selected vehicle
- Total cost: Auto-calculated using `calculateBookingTotal` from rentalService
- Mileage out: number input (current vehicle mileage, pre-filled from vehicle.mileage if available)
- Mileage limit: optional number input

**Section 3: Agreement Terms**
- Authorized drivers: Dynamic list -- add/remove names (store as string array)
  - "Add Driver" button, each driver is a text input with remove (X) button
  - Primary renter always listed first (from customer name)
- Geographic restrictions:
  - "Out of state permitted" checkbox (default unchecked)
  - If checked, show "Permitted states" multi-select or comma-separated text input
- Admin notes: textarea

**Section 4: Review & Create**
- Summary card showing all entered info:
  - Customer name, phone, DL#
  - Vehicle year make model, VIN
  - Dates, duration, rates, total cost
  - Authorized drivers list
  - Geographic restrictions
- "Create Booking" button (tj-gold, prominent)
- On submit:
  1. Create customer first (if new) via createCustomer
  2. Create booking via createBooking (pass customer_id, vehicle_id, all fields)
  3. If DB EXCLUDE constraint error (double-booking): show error message "This vehicle is already booked for those dates"
  4. On success: call onBookingCreated, close modal
  5. Show loading spinner during creation

**Error handling**: Display Supabase errors in a red banner at top of form. Double-booking constraint violation should show a user-friendly message, not raw SQL error.

**Styling**: Dark admin theme. bg-black/95 backdrop, white text, tj-gold accents. Match BillOfSaleModal aesthetic.

**Edit mode**: If `editBooking` is provided, pre-fill all fields. Change button text to "Update Booking". Call updateBooking instead of createBooking on submit.
  </action>
  <verify>Verify the file exists, imports from rentalService, uses createPortal pattern, has all 4 form sections, and handles both create and edit modes.</verify>
  <done>RentalBookingModal.tsx provides full booking creation with customer search, vehicle availability filtering, rate calculation, authorized drivers, geographic restrictions, and error handling for double-booking constraint violations.</done>
</task>

<task type="auto">
  <name>Task 2: Create RentalConditionReport</name>
  <files>triple-j-auto-investment-main/components/admin/RentalConditionReport.tsx</files>
  <action>
Create a condition report component for vehicle checkout and return inspections.

**Props:**
```typescript
interface RentalConditionReportProps {
  bookingId: string;
  reportType: 'checkout' | 'return';
  vehicleName: string;  // "2024 Toyota Camry" for display
  onComplete: () => void;
  existingReport?: RentalConditionReport;  // for viewing completed reports
}
```

**Layout**: Single panel with collapsible sections by category.

**Sections (using CONDITION_CHECKLIST_TEMPLATE from types.ts):**

1. **Odometer & Fuel**:
   - Mileage input (number, required)
   - Fuel level: 5 radio buttons styled as horizontal pill selector (E, 1/4, 1/2, 3/4, F)

2. **Exterior Checklist** (13 items):
   - Each item row: Item name, 3 condition buttons (Good/Fair/Damaged) styled as toggle group
   - Good = green tint, Fair = amber tint, Damaged = red tint
   - Notes field appears when Fair or Damaged is selected (text input, inline)

3. **Interior Checklist** (8 items):
   - Same layout as Exterior

4. **Mechanical/Functional** (6 items):
   - Same layout as above

5. **Photos**:
   - Upload area: drag-and-drop zone + "Choose Files" button
   - Accept image/jpeg, image/png only
   - Max file size: 2MB per image
   - Use the existing `resizeImage` pattern from admin/Inventory.tsx to compress images before upload (800x600, JPEG 0.5 quality)
   - Upload to Supabase Storage bucket 'rental-photos' (path: `condition-reports/{bookingId}/{reportType}/{filename}`)
   - Show thumbnails of uploaded photos in a grid
   - Each thumbnail has a remove (X) button
   - Upload in parallel with Promise.all, show progress per photo
   - If Supabase Storage is not configured, gracefully degrade: show a message "Photo upload not available - configure Supabase Storage" and allow completing the report without photos

6. **Summary & Submit**:
   - Count of items by condition: X Good, Y Fair, Z Damaged
   - If any Damaged items: show amber warning "X damaged items noted"
   - "Complete Report" button
   - On submit: call createConditionReport with all data, then call onComplete

**View mode**: If `existingReport` is provided, render in read-only mode:
- All condition toggles disabled
- Notes visible but not editable
- Photos displayed but no upload zone
- No submit button

**Styling**: Same dark admin theme. Use borders to separate categories. Condition buttons should have clear visual differentiation (green/amber/red).

**State**: Initialize checklist_items from CONDITION_CHECKLIST_TEMPLATE. Track each item's condition and notes in local state. Use a `Map<string, ConditionChecklistItem>` keyed by `category-item` for quick lookups.
  </action>
  <verify>Verify the file exists, imports CONDITION_CHECKLIST_TEMPLATE from types.ts, has all 3 checklist categories (exterior/interior/mechanical), handles photo upload, and has both edit and view modes.</verify>
  <done>RentalConditionReport.tsx renders a complete walk-around checklist with per-item condition ratings, notes on damage, photo upload to Supabase Storage, and read-only view mode for completed reports.</done>
</task>

</tasks>

<verification>
- RentalBookingModal uses createPortal + AnimatePresence (BillOfSaleModal pattern)
- Customer search calls searchCustomers from rentalService
- Vehicle availability filtered by getAvailableVehicles for selected dates
- Total cost auto-calculated using calculateBookingTotal
- Double-booking constraint violation shows user-friendly error
- Condition report covers all 27 checklist items across 3 categories
- Photo upload uses resize before upload pattern
- Build passes with `npx tsc --noEmit`
</verification>

<success_criteria>
- Admin can create bookings with full customer profiles (RENT-04)
- Available vehicles filtered by date range (RENT-02 support)
- Condition report captures detailed vehicle state at checkout/return
- Photo documentation available for damage disputes
- Both components follow existing admin modal/component patterns
</success_criteria>

<output>
After completion, create `.planning/phases/06-rental-management-core/06-04-SUMMARY.md`
</output>
