---
phase: 06-rental-management-core
plan: 05
type: execute
wave: 3
depends_on: ["06-02"]
files_modified:
  - triple-j-auto-investment-main/components/admin/SignatureCapture.tsx
  - triple-j-auto-investment-main/components/admin/RentalAgreementModal.tsx
  - triple-j-auto-investment-main/services/pdfService.ts
autonomous: true

user_setup:
  - service: react-signature-canvas
    why: "Digital signature capture on rental agreements"
    env_vars: []
    dashboard_config: []

must_haves:
  truths:
    - "Rental agreement auto-populates from vehicle and customer data"
    - "Agreement contains comprehensive legal clauses protecting the dealer"
    - "Agreement PDF can be generated and downloaded"
    - "Digital signature can be captured and embedded in the PDF"
    - "Agreement follows same branded styling as existing Bill of Sale PDF"
  artifacts:
    - path: "triple-j-auto-investment-main/components/admin/SignatureCapture.tsx"
      provides: "Reusable signature pad component"
      contains: "SignatureCanvas"
    - path: "triple-j-auto-investment-main/components/admin/RentalAgreementModal.tsx"
      provides: "Agreement review and signature modal"
      min_lines: 200
    - path: "triple-j-auto-investment-main/services/pdfService.ts"
      provides: "generateRentalAgreementPDF function"
      contains: "generateRentalAgreementPDF"
  key_links:
    - from: "triple-j-auto-investment-main/components/admin/RentalAgreementModal.tsx"
      to: "triple-j-auto-investment-main/services/pdfService.ts"
      via: "generateRentalAgreementPDF call"
      pattern: "generateRentalAgreementPDF"
    - from: "triple-j-auto-investment-main/services/pdfService.ts"
      to: "jspdf"
      via: "jsPDF instance"
      pattern: "new jsPDF"
    - from: "triple-j-auto-investment-main/components/admin/SignatureCapture.tsx"
      to: "react-signature-canvas"
      via: "SignatureCanvas component"
      pattern: "react-signature-canvas"
---

<objective>
Create the rental agreement system: signature capture, agreement modal, and PDF generation.

Purpose: RENT-03 requires auto-populated rental agreements following the Bill of Sale flow. The CONTEXT.md emphasizes "a cohesive in-depth rental agreement" with comprehensive legal clauses. This plan creates the full agreement pipeline from data entry through PDF output.

Output: SignatureCapture.tsx component, RentalAgreementModal.tsx for agreement review, and generateRentalAgreementPDF added to pdfService.ts.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-rental-management-core/06-CONTEXT.md
@.planning/phases/06-rental-management-core/06-RESEARCH.md
@.planning/phases/06-rental-management-core/06-02-SUMMARY.md
@triple-j-auto-investment-main/services/pdfService.ts
@triple-j-auto-investment-main/components/admin/BillOfSaleModal.tsx
@triple-j-auto-investment-main/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-signature-canvas and create SignatureCapture component</name>
  <files>triple-j-auto-investment-main/components/admin/SignatureCapture.tsx</files>
  <action>
**A. Install dependency:**
Run from the `triple-j-auto-investment-main` directory:
```bash
npm install react-signature-canvas
npm install --save-dev @types/react-signature-canvas
```

**B. Create `SignatureCapture.tsx`:**

A reusable signature pad component.

```typescript
interface SignatureCaptureProps {
  onSave: (dataUrl: string) => void;
  onClear?: () => void;
  savedSignature?: string;  // base64 data URL for pre-loaded signature
  disabled?: boolean;
}
```

**Implementation:**
1. Use `react-signature-canvas` `SignatureCanvas` component
2. Ref: `useRef<SignatureCanvas>(null)`
3. Canvas props: responsive width (use parent container width), height 200px
4. White background for the signing area (so signature shows clearly in PDF)
5. Pen color: black, min/max width for natural feel

**UI elements:**
- Signature canvas area with subtle border and "Sign here" placeholder text (shown when empty)
- "Clear" button (calls sigRef.current.clear() and onClear callback)
- "Accept Signature" button (extracts base64 via sigRef.current.toDataURL('image/png'), calls onSave)
- If `savedSignature` provided: render as an `<img>` tag instead of the canvas, with "Re-sign" button that switches back to canvas mode
- If `disabled`: show saved signature as image, no buttons

**Styling:** Dark theme wrapper, white canvas area for contrast. Buttons styled consistently with admin UI (tj-gold for accept, gray for clear).

**Mobile support:** The signature_pad library (wrapped by react-signature-canvas) handles touch events natively. Ensure the canvas has `touch-action: none` CSS to prevent scroll interference on mobile.
  </action>
  <verify>Verify react-signature-canvas is in package.json dependencies. Verify SignatureCapture.tsx imports SignatureCanvas, has onSave callback, and handles clear/accept/re-sign flows.</verify>
  <done>SignatureCapture.tsx provides a reusable digital signature pad with accept/clear/re-sign functionality, base64 PNG output, and mobile touch support.</done>
</task>

<task type="auto">
  <name>Task 2: Create RentalAgreementModal and PDF generator</name>
  <files>
    triple-j-auto-investment-main/components/admin/RentalAgreementModal.tsx
    triple-j-auto-investment-main/services/pdfService.ts
  </files>
  <action>
**A. Add `generateRentalAgreementPDF` to `pdfService.ts`:**

Add a new export function at the end of the file (after existing generators). Reuse the existing helper functions: `loadLogoAsBase64`, `drawSecurityBackground`, `drawHeader`, `drawSection`, `drawDataBox`, `drawFooter`, `formatCurrency`, and brand constants (C_DARK, C_GOLD, etc.).

**Function signature:**
```typescript
export interface RentalAgreementData {
  // Booking info
  bookingId: string;
  startDate: string;
  endDate: string;
  dailyRate: number;
  weeklyRate?: number;
  totalCost: number;
  mileageOut?: number;
  mileageLimit?: number;

  // Vehicle info
  vehicleYear: number;
  vehicleMake: string;
  vehicleModel: string;
  vehicleVin: string;
  vehicleMileage: number;
  vehicleColor?: string;

  // Customer info
  customerName: string;
  customerPhone: string;
  customerEmail?: string;
  customerAddress: string;
  customerDl: string;

  // Agreement terms
  authorizedDrivers: string[];
  outOfStatePermitted: boolean;
  permittedStates: string[];

  // Signature
  signatureDataUrl?: string;
  signatureDate?: string;
}

export async function generateRentalAgreementPDF(data: RentalAgreementData): Promise<jsPDF>
```

**PDF content structure** (multi-page document using jsPDF):

Page 1 - **Agreement Header & Parties:**
- Triple J branded header (reuse drawHeader)
- Security background (reuse drawSecurityBackground)
- Title: "VEHICLE RENTAL AGREEMENT"
- Agreement number (booking_id)
- Date of agreement
- LESSOR section: Triple J Auto Investment, dealer info
- LESSEE section: Customer name, address, phone, email, DL#
- VEHICLE section: Year, Make, Model, VIN, Color, Mileage at checkout

Page 1-2 - **Rental Terms:**
- Rental period: start date to end date
- Daily rate, weekly rate (if applicable), total cost
- Mileage limit (if set): "X miles included, $0.25/mile overage"
- Authorized drivers list
- Late return penalty: daily rate per day

Page 2-3 - **Legal Clauses** (each as a numbered section using drawSection):

1. **USE OF VEHICLE**: Vehicle shall be used only for personal transportation. Prohibited uses: commercial purposes, racing, towing, transporting hazardous materials, off-road driving, any illegal activity.

2. **GEOGRAPHIC RESTRICTIONS**: Vehicle must remain within the State of Texas at all times unless written permission has been granted. If out-of-state permitted, list approved states. Violation voids insurance coverage.

3. **AUTHORIZED DRIVERS**: Only drivers listed on this agreement may operate the vehicle. All authorized drivers must possess a valid driver's license. Lessee is responsible for actions of all authorized drivers.

4. **INSURANCE REQUIREMENTS**: Lessee must maintain valid auto insurance meeting Texas minimum requirements ($30,000/$60,000/$25,000) throughout the rental period. Lessee's insurance is primary coverage.

5. **LIABILITY AND DAMAGE**: Lessee is responsible for all damage to the vehicle during the rental period, regardless of fault. Lessee is liable for loss of use during repair. Deductible amounts are Lessee's responsibility.

6. **ACCIDENT PROCEDURES**: In case of accident: (a) Call 911 if injuries, (b) Do not admit fault, (c) Exchange information with other parties, (d) File police report, (e) Notify Triple J Auto Investment immediately at [phone].

7. **MAINTENANCE AND CARE**: Lessee must maintain proper fluid levels, tire pressure, and report any mechanical issues immediately. Do not modify the vehicle in any way.

8. **RETURN CONDITIONS**: Vehicle must be returned by the agreed end date at the agreed time. Vehicle must be returned with the same fuel level as at checkout. Late returns are charged at the daily rate plus any applicable penalties.

9. **LATE FEES AND PENALTIES**: Returns after the agreed end date incur a late fee of [daily_rate] per day. If vehicle is not returned within 48 hours of the end date without contact, the vehicle will be reported as stolen.

10. **VEHICLE CONDITION**: Lessee acknowledges receiving the vehicle in good condition as documented in the Vehicle Condition Report completed at checkout. Lessee is responsible for returning the vehicle in the same condition, minus normal wear and tear.

11. **INDEMNIFICATION**: Lessee agrees to indemnify and hold harmless Triple J Auto Investment from any claims, damages, losses, or expenses arising from Lessee's use of the vehicle.

12. **TERMINATION**: Lessor may terminate this agreement immediately if Lessee violates any terms. Upon termination, Lessee must return the vehicle immediately.

13. **GOVERNING LAW**: This agreement is governed by the laws of the State of Texas. Any disputes shall be resolved in Harris County, Texas.

14. **ENTIRE AGREEMENT**: This document constitutes the entire agreement. No verbal agreements or modifications are binding unless in writing and signed by both parties.

Page 3-4 - **Signature Block:**
- "By signing below, I acknowledge that I have read, understand, and agree to all terms and conditions of this Vehicle Rental Agreement."
- Lessee signature line (embed signature image if signatureDataUrl provided via doc.addImage)
- Lessee printed name and date
- Lessor signature line (blank for dealer to sign)
- Lessor printed name and date

**Formatting details:**
- Use existing font sizes and spacing from pdfService.ts for consistency
- drawSection for each numbered clause with the section title in gold
- drawDataBox for the vehicle and customer info blocks
- Footer on each page with page number
- If content overflows a page, call doc.addPage() and continue. Track Y position carefully.

**B. Create `RentalAgreementModal.tsx`:**

Portal modal following BillOfSaleModal pattern.

**Props:**
```typescript
interface RentalAgreementModalProps {
  isOpen: boolean;
  onClose: () => void;
  booking: RentalBooking;
  customer: RentalCustomer;
  vehicle: Vehicle;
  onAgreementSigned: (signatureData: string) => void;
}
```

**Layout**: Two-panel (form/signature left, preview right) on desktop.

**Left panel - Agreement Form:**
1. **Summary section** (read-only, auto-populated from props):
   - Agreement #: booking.bookingId
   - Customer: name, phone, DL#, address
   - Vehicle: year make model, VIN
   - Dates: start to end
   - Rates: daily, weekly, total
   - Authorized drivers list
   - Geographic restrictions

2. **Signature section**:
   - Render `<SignatureCapture>` component
   - "Sign & Complete" button (disabled until signature captured)
   - "Print for Manual Signature" button (generates PDF without signature for printing)
   - Checkbox: "I confirm the customer has reviewed all terms and conditions"

**Right panel - Live PDF Preview:**
- Generate PDF on mount using generateRentalAgreementPDF
- Convert to blob URL: `doc.output('bloburl')`
- Render in an `<iframe>` for preview
- Regenerate preview when signature is captured (shows signature embedded)

**Actions:**
- "Print for Manual Signature": Generate PDF without signature, open in new tab for printing. Then admin checks a "Signed manually" checkbox to confirm.
- "Sign Digitally": Capture signature via SignatureCapture, embed in PDF, save
- On completion:
  1. Generate final PDF with signature
  2. Upload PDF blob to Supabase Storage (bucket: 'rental-agreements', path: `{bookingId}/agreement.pdf`)
  3. Update booking: agreement_signed = true, agreement_pdf_url = storage URL, signature_data = base64
  4. Call onAgreementSigned callback
  5. If Supabase Storage upload fails, still save the signature_data to the booking so it's not lost. Show warning that PDF storage failed.

**Styling**: Dark theme, matching BillOfSaleModal. Preview panel has white background for PDF readability.
  </action>
  <verify>
  Run `npx tsc --noEmit` to verify build passes. Check that:
  1. pdfService.ts exports generateRentalAgreementPDF
  2. RentalAgreementModal.tsx imports SignatureCapture and generateRentalAgreementPDF
  3. PDF function reuses existing drawHeader, drawSection, drawDataBox helpers
  4. Agreement contains all 14 legal clause sections
  </verify>
  <done>
  SignatureCapture provides digital signature capture. RentalAgreementModal shows agreement summary with live PDF preview, supports both digital and manual signing flows. generateRentalAgreementPDF produces a comprehensive multi-page branded agreement with all legal clauses. Build passes.
  </done>
</task>

</tasks>

<verification>
- react-signature-canvas installed and in package.json
- SignatureCapture outputs base64 PNG via toDataURL
- Agreement PDF reuses existing pdfService.ts primitives (drawHeader, drawSection, etc.)
- PDF contains all 14 legal clauses from CONTEXT.md requirements
- RentalAgreementModal supports both digital and print-for-manual-signature flows
- PDF preview renders in iframe
- Build passes with `npx tsc --noEmit`
</verification>

<success_criteria>
- RENT-03 (auto-populated agreements): Agreement auto-fills from booking, customer, and vehicle data
- Agreement is comprehensive with all dealer-protection clauses per CONTEXT.md
- Digital signature capture works on desktop and mobile
- PDF matches existing branded styling (Gold header, security background)
- Manual signing flow available as fallback
</success_criteria>

<output>
After completion, create `.planning/phases/06-rental-management-core/06-05-SUMMARY.md`
</output>
