---
phase: 07-plate-tracking
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - triple-j-auto-investment-main/pages/admin/Plates.tsx
  - triple-j-auto-investment-main/components/admin/PlateAssignmentHistory.tsx
  - triple-j-auto-investment-main/App.tsx
  - triple-j-auto-investment-main/pages/admin/Dashboard.tsx
  - triple-j-auto-investment-main/pages/admin/Inventory.tsx
  - triple-j-auto-investment-main/pages/admin/Rentals.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can navigate to /admin/plates from the nav bar on any admin page"
    - "Admin can see all plates currently out with customer name, phone, vehicle, return date, and days remaining/overdue"
    - "Admin can see the full plate inventory with type, status, and expiration info"
    - "Admin can add a new plate (dealer, buyer's tag, or permanent) with all fields"
    - "Admin can edit plate details (notes, expiration, status)"
    - "Admin can view assignment history for any plate showing who had it and when"
    - "Buyer's tag countdown shows yellow at 14 days, red at 7 days, pulsing red when expired"
    - "Overdue plates are sorted to the top of the plates-out panel"
  artifacts:
    - path: "triple-j-auto-investment-main/pages/admin/Plates.tsx"
      provides: "Dedicated plate management page with split-view dashboard"
      min_lines: 400
    - path: "triple-j-auto-investment-main/components/admin/PlateAssignmentHistory.tsx"
      provides: "Reusable assignment history timeline component"
      min_lines: 60
    - path: "triple-j-auto-investment-main/App.tsx"
      provides: "Route registration for /admin/plates"
      contains: "admin/plates"
  key_links:
    - from: "pages/admin/Plates.tsx"
      to: "services/plateService.ts"
      via: "import and function calls"
      pattern: "import.*from.*plateService"
    - from: "pages/admin/Plates.tsx"
      to: "types.ts"
      via: "type imports"
      pattern: "import.*Plate.*PlateType.*from.*types"
    - from: "App.tsx"
      to: "pages/admin/Plates.tsx"
      via: "lazy import and Route"
      pattern: "admin/plates"
    - from: "pages/admin/Dashboard.tsx"
      to: "/admin/plates"
      via: "navItems array entry"
      pattern: "admin/plates.*Plates"
---

<objective>
Create the dedicated Plates admin page with split-view dashboard, plate CRUD UI, assignment history component, and wire up routing and navigation across all admin pages.

Purpose: This is the primary management interface for plate tracking -- the "where are my plates RIGHT NOW" command center the dealer checks every morning. The split-view shows plates currently out (urgent/actionable) on the left and full plate inventory on the right.

Output: Plates.tsx admin page, PlateAssignmentHistory.tsx component, App.tsx route, and navItems updates in Dashboard.tsx, Inventory.tsx, and Rentals.tsx.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-plate-tracking/07-CONTEXT.md
@.planning/phases/07-plate-tracking/07-RESEARCH.md
@.planning/phases/07-plate-tracking/07-01-SUMMARY.md

Key reference files for patterns:
@triple-j-auto-investment-main/pages/admin/Rentals.tsx (AdminHeader pattern, tab navigation, luxury dark styling)
@triple-j-auto-investment-main/pages/admin/Dashboard.tsx (navItems array)
@triple-j-auto-investment-main/pages/admin/Inventory.tsx (navItems array)
@triple-j-auto-investment-main/components/admin/RentalConditionReport.tsx (form/modal pattern)
@triple-j-auto-investment-main/App.tsx (route registration, lazy loading)
@triple-j-auto-investment-main/types.ts (Plate, PlateAssignment types from 07-01)
@triple-j-auto-investment-main/services/plateService.ts (service functions from 07-01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Plates Admin Page with Split-View Dashboard</name>
  <files>
    triple-j-auto-investment-main/pages/admin/Plates.tsx
    triple-j-auto-investment-main/components/admin/PlateAssignmentHistory.tsx
  </files>
  <action>
**A. Create PlateAssignmentHistory.tsx** -- a reusable component showing the assignment log for a single plate:

Props: `{ plateId: string; isOpen: boolean }`. Fetches `getPlateHistory(plateId)` on mount when isOpen is true.

Display as a vertical timeline (consistent with audit history pattern from Registrations.tsx). Each entry shows:
- Assignment type badge (rental/sale/inventory) with color coding
- Customer name and phone (if present)
- Vehicle info (if joined)
- Assigned date -> Returned date (or "Currently Out")
- Return confirmed status (green check or red "Not confirmed")
- Notes (if any)

Use Tailwind: `border-l-2 border-tj-gold/30` for timeline line, `pl-4` for content. Most recent assignments first.

**B. Create Plates.tsx** -- the full dedicated plate management page:

**AdminHeader:** Duplicate the AdminHeader pattern from Rentals.tsx exactly (same styling, logo, nav, logout, mobile menu). Add `{ path: '/admin/plates', label: 'Plates', icon: CreditCard }` to the navItems array (use CreditCard from lucide-react). The Plates page's own AdminHeader should highlight '/admin/plates' as active.

**Stats Bar:** Below header, show summary stats in a horizontal bar (same styling as Rentals.tsx stats):
- Total Plates: count of all plates
- Out Now: count of plates with status = 'assigned' (red pulse badge if any overdue)
- Available: count of available plates
- Active Alerts: count of unresolved alerts (red if > 0)
- Expiring Soon: count of buyer's tags within 14 days of expiration

**Split View Layout:**
```
<div className="grid grid-cols-1 lg:grid-cols-5 gap-6">
  <div className="lg:col-span-3"> {/* Plates Out Panel */} </div>
  <div className="lg:col-span-2"> {/* Plate Inventory Panel */} </div>
</div>
```

**Left Panel - Plates Currently Out (3/5 width on desktop):**
- Header: "Plates Out" with count badge
- Each plate-out card shows:
  - Plate number (large, bold) + type badge (dealer=blue, buyer_tag=amber, permanent=gray)
  - Customer name + clickable phone (tel: link)
  - Vehicle: year make model
  - Assigned: date
  - Expected return: date
  - Days remaining (green) or Days overdue (red with pulse animation)
  - For buyer's tags: expiration countdown with severity colors (ok=green, warning=amber, urgent=red, expired=red+pulse)
  - Notes (if any, truncated with expand)
  - Quick actions: "Mark Returned" button, "View History" toggle
- Sorting: Overdue first (sorted by most overdue), then by expected return date ascending
- Empty state: "All plates accounted for" with green check icon

**Right Panel - Plate Inventory (2/5 width on desktop):**
- Header: "All Plates" with "Add Plate" button (Plus icon)
- Filter row: type filter (All/Dealer/Buyer's Tag/Permanent), status filter (All/Available/Assigned/Expired/Lost)
- Table/list of all plates:
  - Plate number
  - Type badge
  - Status badge (available=green, assigned=amber, expired=red, lost=gray)
  - Expiration date (if applicable) with countdown severity
  - Current vehicle (if assigned)
  - Actions: Edit, View History, Delete (only if no active assignments)
- "Add Plate" inline form or modal (Claude's discretion on format):
  - Plate number (text input, required)
  - Type (select: dealer/buyer_tag/permanent)
  - Expiration date (required if buyer_tag, auto-suggest sale_date + 60 days for buyer_tag)
  - Notes (textarea)
  - Photo upload (file input, calls uploadPlatePhoto)

**Edit Plate:** Inline edit or small modal for updating plate details (notes, expiration, status, photo). Reuse the add form pattern.

**View History:** When "View History" is clicked on any plate, expand the PlateAssignmentHistory component below the plate card/row. Follow the accordion single-expand pattern from BookingDetail (only one history expanded at a time).

**Mark Returned (from Plates-Out panel):** When clicked, call `returnPlateAssignment(assignmentId, true)`, then refresh the plates list. Show a brief success toast.

**Responsive behavior:** On mobile (< lg), stack vertically -- Plates Out panel on top, then Inventory below. This follows priority: "where are my plates" is the first thing checked.

**Loading state:** Use `useState<boolean>(true)` for initial load, show a centered loader. On error, show the luxury dark error card pattern.

**Data fetching:** On mount, call `getAllPlates()` and `getActiveAlerts()`. Derive platesOut from plates where status = 'assigned'. Use `useMemo` for derived calculations (counts, filtering, sorting).

**Styling:** Follow the luxury dark theme established in Rentals.tsx -- black background, tj-gold accents, white/gray text, border-tj-gold/20 borders, uppercase tracking-widest for labels.
  </action>
  <verify>
1. `npx tsc --noEmit` from triple-j-auto-investment-main -- no new type errors
2. Plates.tsx imports from plateService.ts and types.ts
3. PlateAssignmentHistory.tsx accepts plateId prop and calls getPlateHistory
4. AdminHeader in Plates.tsx has 5 navItems (Dashboard, Inventory, Registrations, Rentals, Plates)
  </verify>
  <done>
Plates.tsx exists as a full admin page with split-view layout (plates out left, inventory right), stats bar, plate CRUD forms, filter controls, mark-returned action, and luxury dark styling. PlateAssignmentHistory.tsx renders assignment timeline for any plate.
  </done>
</task>

<task type="auto">
  <name>Task 2: Routing, Navigation, and Cross-Page Updates</name>
  <files>
    triple-j-auto-investment-main/App.tsx
    triple-j-auto-investment-main/pages/admin/Dashboard.tsx
    triple-j-auto-investment-main/pages/admin/Inventory.tsx
    triple-j-auto-investment-main/pages/admin/Rentals.tsx
  </files>
  <action>
**A. App.tsx:**
1. Add lazy import at the top with the other admin pages:
   ```typescript
   const AdminPlates = lazyWithErrorHandling(() => import('./pages/admin/Plates'), 'Admin Plates');
   ```
2. Add route inside the admin routes section (after the Rentals route):
   ```typescript
   <Route path="/admin/plates" element={<ProtectedRoute><AdminPlates /></ProtectedRoute>} />
   ```
3. Add `CreditCard` to the lucide-react import at the top of App.tsx (for the Navbar, if a Plates link is desired in the admin section of the nav -- but this is optional since AdminHeader handles admin nav). The CreditCard import is primarily for consistency.

**B. Dashboard.tsx, Inventory.tsx, Rentals.tsx -- Add Plates nav item:**
For each of these three files, find the `navItems` array and add one entry:
```typescript
{ path: '/admin/plates', label: 'Plates', icon: CreditCard },
```
Place it after the Rentals entry (last in the array).

Also add `CreditCard` to each file's lucide-react import statement. Check the existing import line and append CreditCard to it.

Do NOT modify Registrations.tsx -- it does not have the AdminHeader/navItems pattern (confirmed during analysis).

**Important:** Do not change any other code in these files. Only add the navItem entry and the CreditCard import. The existing AdminHeader rendering code already maps over navItems dynamically, so adding the entry is sufficient.
  </action>
  <verify>
1. Grep App.tsx for "admin/plates" -- should find the lazy import and Route
2. Grep Dashboard.tsx for "admin/plates" -- should find navItems entry
3. Grep Inventory.tsx for "admin/plates" -- should find navItems entry
4. Grep Rentals.tsx for "admin/plates" -- should find navItems entry
5. `npx tsc --noEmit` -- no new type errors
6. `npm run build` -- build completes successfully (lazy import resolves)
  </verify>
  <done>
/admin/plates route is registered in App.tsx with lazy loading and ProtectedRoute. All three admin pages with AdminHeader (Dashboard, Inventory, Rentals) include "Plates" in their navItems array with CreditCard icon. The Plates page is discoverable from any admin page.
  </done>
</task>

</tasks>

<verification>
1. Navigate to /admin/plates -- page loads with split-view dashboard
2. Plates nav item appears in AdminHeader on Dashboard, Inventory, Rentals, and Plates pages
3. Add Plate form works (creates plate via plateService)
4. Edit plate updates fields
5. Plates-Out panel shows assigned plates with customer info and countdown
6. Mark Returned button closes assignment and updates plate status
7. Assignment history timeline shows for any plate
8. Build completes without errors
</verification>

<success_criteria>
- /admin/plates route works with ProtectedRoute guard
- Plates.tsx has split-view with plates-out (3/5) and inventory (2/5) panels
- PlateAssignmentHistory.tsx renders timeline for any plate
- All 4 admin pages show "Plates" in nav (Dashboard, Inventory, Rentals, Plates)
- Buyer's tag countdown uses 4-tier severity colors
- Overdue plates sort to top
- Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/07-plate-tracking/07-02-SUMMARY.md`
</output>
