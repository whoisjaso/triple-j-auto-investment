---
phase: 07-plate-tracking
plan: 04
type: execute
wave: 3
depends_on: ["07-02", "07-03"]
files_modified:
  - triple-j-auto-investment-main/supabase/functions/check-plate-alerts/index.ts
  - triple-j-auto-investment-main/supabase/functions/_shared/email-templates/plate-alert.tsx
  - triple-j-auto-investment-main/supabase/migrations/07_plate_tracking.sql
autonomous: true
user_setup:
  - service: supabase
    why: "pg_cron schedule for alert checker"
    env_vars:
      - name: ADMIN_PHONE
        source: "Dealer's phone number in E.164 format (e.g. +17135551234)"
      - name: ADMIN_EMAIL
        source: "Dealer's email address for alert notifications"
    dashboard_config:
      - task: "Add ADMIN_PHONE and ADMIN_EMAIL as Edge Function secrets"
        location: "Supabase Dashboard -> Edge Functions -> check-plate-alerts -> Environment Variables"

must_haves:
  truths:
    - "Edge Function detects overdue rental returns (plate still out past return date)"
    - "Edge Function detects expiring buyer's tags (warning at 14 days, urgent at 7 days)"
    - "Edge Function detects unaccounted plates (assigned but no active booking or registration)"
    - "Admin receives ONE batched SMS/email summary, not per-plate spam"
    - "Alert deduplication prevents re-sending for the same condition within 24 hours"
    - "Resolved conditions are automatically marked resolved in plate_alerts table"
  artifacts:
    - path: "triple-j-auto-investment-main/supabase/functions/check-plate-alerts/index.ts"
      provides: "Cron-triggered Edge Function that detects alert conditions and sends notifications"
      min_lines: 100
    - path: "triple-j-auto-investment-main/supabase/functions/_shared/email-templates/plate-alert.tsx"
      provides: "HTML email template for batched plate alerts"
      min_lines: 30
  key_links:
    - from: "supabase/functions/check-plate-alerts/index.ts"
      to: "supabase/functions/_shared/twilio.ts"
      via: "sendSms import for admin SMS"
      pattern: "import.*sendSms.*from.*twilio"
    - from: "supabase/functions/check-plate-alerts/index.ts"
      to: "supabase/functions/_shared/resend.ts"
      via: "sendEmail import for admin email"
      pattern: "import.*sendEmail.*from.*resend"
    - from: "supabase/functions/check-plate-alerts/index.ts"
      to: "public.plate_alerts"
      via: "upsert for deduplication"
      pattern: "plate_alerts"
---

<objective>
Create the plate alert Edge Function that detects overdue rentals, expiring buyer's tags, and unaccounted plates, then sends a batched summary notification to the admin via SMS and email.

Purpose: This is the proactive safety net (PLAT-05). The dealer gets notified about plate problems even when they haven't opened the dashboard. Alerts are batched to avoid notification spam and deduplicated to prevent re-alerting for the same ongoing condition.

Output: check-plate-alerts Edge Function, plate-alert email template, and pg_cron schedule SQL appended to the migration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-plate-tracking/07-CONTEXT.md
@.planning/phases/07-plate-tracking/07-RESEARCH.md
@.planning/phases/07-plate-tracking/07-01-SUMMARY.md

Key reference files for patterns:
@triple-j-auto-investment-main/supabase/functions/process-notification-queue/index.ts (Edge Function pattern)
@triple-j-auto-investment-main/supabase/functions/_shared/twilio.ts (SMS helper)
@triple-j-auto-investment-main/supabase/functions/_shared/resend.ts (Email helper)
@triple-j-auto-investment-main/supabase/functions/_shared/email-templates/status-update.tsx (Email template pattern)
@triple-j-auto-investment-main/supabase/migrations/04_notification_system.sql (pg_cron schedule pattern)
@triple-j-auto-investment-main/supabase/migrations/07_plate_tracking.sql (plate_alerts table from 07-01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Alert Edge Function and Email Template</name>
  <files>
    triple-j-auto-investment-main/supabase/functions/check-plate-alerts/index.ts
    triple-j-auto-investment-main/supabase/functions/_shared/email-templates/plate-alert.tsx
  </files>
  <action>
**A. Create plate-alert email template** (plate-alert.tsx):

Follow the template literal HTML pattern from status-update.tsx (NOT React Email JSX -- per decision from Phase 4). Create a function that accepts an array of alert items and returns an HTML string.

```typescript
// _shared/email-templates/plate-alert.tsx
// Template literal HTML (not React Email JSX) per Phase 4 decision

interface PlateAlertItem {
  plateNumber: string;
  alertType: 'overdue_rental' | 'expiring_buyer_tag' | 'unaccounted';
  severity: 'warning' | 'urgent';
  customerName?: string;
  customerPhone?: string;
  vehicleInfo?: string;
  daysOverdue?: number;
  daysUntilExpiry?: number;
}

export function buildPlateAlertEmail(alerts: PlateAlertItem[]): string {
  // Return HTML string with:
  // - Triple J branding header (gold on dark, same as status-update.tsx)
  // - "Plate Alert Summary" title
  // - Alert count badge
  // - Grouped sections: Overdue Rentals, Expiring Tags, Unaccounted Plates
  // - Each alert: plate number, customer, vehicle, urgency indicator
  // - Footer with "View Plates Dashboard" link (placeholder URL)
  // Use inline CSS for email client compatibility
}

export function buildPlateAlertSms(alerts: PlateAlertItem[]): string {
  // Concise SMS summary, e.g.:
  // "Triple J Plate Alert: 2 overdue, 1 expiring tag. Check dashboard."
  // Keep under 160 chars when possible
}
```

**B. Create check-plate-alerts Edge Function** (check-plate-alerts/index.ts):

Follow the pattern from process-notification-queue/index.ts exactly (Deno.serve, createClient, environment variables).

```typescript
import { createClient } from 'npm:@supabase/supabase-js@2';
import { sendSms } from '../_shared/twilio.ts';
import { sendEmail } from '../_shared/resend.ts';
import { buildPlateAlertEmail, buildPlateAlertSms } from '../_shared/email-templates/plate-alert.tsx';
```

**Function logic (step by step):**

1. **Initialize Supabase client** with service role key (same pattern as process-notification-queue).

2. **Detect overdue rentals:**
   Query plate_assignments WHERE returned_at IS NULL AND expected_return_date < CURRENT_DATE. Join plates for plate_number. Join rental_bookings for status confirmation (status IN ('active', 'overdue')). Each result is a potential alert with alert_type = 'overdue_rental'.

3. **Detect expiring buyer's tags:**
   Query plates WHERE plate_type = 'buyer_tag' AND status != 'expired'. Calculate days until expiration_date. If <= 14 days: severity = 'warning'. If <= 7 days: severity = 'urgent'. If <= 0: severity = 'urgent' (expired). Each qualifying plate is a potential alert with alert_type = 'expiring_buyer_tag'.

4. **Detect unaccounted plates:**
   Query plates WHERE status = 'assigned'. For each, check plate_assignments WHERE plate_id = X AND returned_at IS NULL. If the linked booking_id has status 'returned' or 'cancelled', or the assignment has no booking_id and no registration_id, the plate is unaccounted. Alert_type = 'unaccounted'.

5. **Upsert into plate_alerts:**
   For each detected condition, UPSERT into plate_alerts ON CONFLICT (plate_id, alert_type) WHERE (resolved_at IS NULL):
   - If new: INSERT with first_detected_at = NOW()
   - If exists: DO NOTHING (condition already tracked)

6. **Auto-resolve cleared conditions:**
   Query plate_alerts WHERE resolved_at IS NULL. For each active alert, check if the condition still exists. If NOT (e.g., plate was returned, tag was renewed), UPDATE SET resolved_at = NOW().

7. **Find alerts needing notification:**
   Query plate_alerts WHERE resolved_at IS NULL AND (last_notified_at IS NULL OR last_notified_at < NOW() - INTERVAL '24 hours'). This implements:
   - First detection: immediate notification (last_notified_at IS NULL)
   - Ongoing conditions: daily re-notification (24-hour cooldown)

8. **Batch and send notifications:**
   If there are alerts to notify about:
   - Build alert items array for the email/SMS templates
   - Read ADMIN_PHONE and ADMIN_EMAIL from Deno.env.get()
   - Send ONE SMS with summary (buildPlateAlertSms)
   - Send ONE email with full details (buildPlateAlertEmail)
   - If either fails, log error but continue (don't fail the whole function)
   - UPDATE plate_alerts SET last_notified_at = NOW() for all notified alerts

9. **Return response:**
   Return JSON with counts: { detected: N, notified: M, resolved: R }

**Error handling:**
- Wrap each detection query in try/catch -- one failing shouldn't prevent others
- If Supabase client creation fails, return 500
- Log all operations with console.log for debugging (same pattern as process-notification-queue)

**Environment variables needed:**
- SUPABASE_URL (standard, already available)
- SUPABASE_SERVICE_ROLE_KEY (standard, already available)
- ADMIN_PHONE (new -- dealer's phone for SMS alerts)
- ADMIN_EMAIL (new -- dealer's email for email alerts)
- TWILIO_ACCOUNT_SID, TWILIO_AUTH_TOKEN, TWILIO_PHONE_NUMBER (already configured from Phase 4)
- RESEND_API_KEY (already configured from Phase 4)
  </action>
  <verify>
1. check-plate-alerts/index.ts exists and imports from _shared/twilio.ts and _shared/resend.ts
2. plate-alert.tsx exists and exports buildPlateAlertEmail and buildPlateAlertSms
3. Edge Function handles all 3 alert types: overdue_rental, expiring_buyer_tag, unaccounted
4. Deduplication logic: upserts into plate_alerts, checks last_notified_at for 24h cooldown
5. Auto-resolve logic: marks resolved_at when condition clears
6. Batching: sends ONE SMS and ONE email regardless of alert count
  </verify>
  <done>
check-plate-alerts Edge Function detects all 3 alert conditions, upserts into plate_alerts for deduplication, auto-resolves cleared conditions, and sends batched SMS + email to admin with 24-hour re-notification cooldown. Email template follows the branded HTML pattern from Phase 4.
  </done>
</task>

<task type="auto">
  <name>Task 2: pg_cron Schedule for Alert Checker</name>
  <files>triple-j-auto-investment-main/supabase/migrations/07_plate_tracking.sql</files>
  <action>
Append to the existing 07_plate_tracking.sql migration file (created in Plan 01) the pg_cron schedule for the check-plate-alerts Edge Function.

Follow the exact pattern from 04_notification_system.sql for the pg_cron + pg_net setup.

Add at the END of 07_plate_tracking.sql:

```sql
-- ================================================================
-- 8. PLATE ALERT CRON SCHEDULE
-- ================================================================
-- Runs every 30 minutes to check for overdue, expiring, and unaccounted plates
-- Uses pg_cron + pg_net to invoke the Edge Function
-- Requires: pg_cron and pg_net extensions enabled in Supabase Dashboard

-- Schedule the alert checker (every 30 minutes)
-- NOTE: This requires pg_cron extension enabled. Run in Supabase SQL editor.
-- The schedule calls the check-plate-alerts Edge Function via pg_net.
-- Adjust the URL to match your Supabase project.

-- Example (uncomment and adjust for your project):
-- SELECT cron.schedule(
--   'check-plate-alerts',
--   '*/30 * * * *',  -- every 30 minutes
--   $$
--   SELECT net.http_post(
--     url := current_setting('app.settings.supabase_url') || '/functions/v1/check-plate-alerts',
--     headers := jsonb_build_object(
--       'Authorization', 'Bearer ' || current_setting('app.settings.service_role_key'),
--       'Content-Type', 'application/json'
--     ),
--     body := '{}'::jsonb
--   );
--   $$
-- );
```

**Important:** Keep the cron schedule commented out (same approach as Phase 4). It needs to be uncommented and run manually after:
1. pg_cron and pg_net extensions are enabled
2. app.settings.supabase_url and app.settings.service_role_key are configured
3. The Edge Function is deployed

Add a comment block explaining the prerequisites (same as the Phase 4 migration does).

Also add a TODO entry note in the SQL comments:
```sql
-- TODO: After deploying the Edge Function, uncomment and run:
-- 1. Enable pg_cron and pg_net extensions in Supabase Dashboard
-- 2. Set app.settings: ALTER DATABASE postgres SET app.settings.supabase_url = 'https://YOUR_PROJECT.supabase.co';
-- 3. Deploy: supabase functions deploy check-plate-alerts
-- 4. Run this schedule in Supabase SQL editor
```
  </action>
  <verify>
1. The pg_cron schedule SQL is at the end of 07_plate_tracking.sql
2. Schedule is commented out (safe to run migration without pg_cron enabled)
3. Uses the same app.settings pattern as 04_notification_system.sql
4. Comments explain prerequisites and deployment steps
  </verify>
  <done>
07_plate_tracking.sql includes commented pg_cron schedule for check-plate-alerts Edge Function running every 30 minutes. Prerequisites documented. Safe to apply migration without pg_cron enabled.
  </done>
</task>

</tasks>

<verification>
1. check-plate-alerts/index.ts exists and is a valid Deno Edge Function
2. Email template produces branded HTML with alert sections
3. SMS template produces concise summary under 160 chars
4. Alert deduplication prevents re-sending within 24 hours
5. Auto-resolve clears conditions that are no longer true
6. pg_cron schedule is commented and documented in migration
7. All 3 alert types handled: overdue_rental, expiring_buyer_tag, unaccounted
</verification>

<success_criteria>
- Edge Function file exists at supabase/functions/check-plate-alerts/index.ts
- Email template exists at _shared/email-templates/plate-alert.tsx
- Function detects all 3 alert conditions from the plate_alerts CHECK constraint
- Batched notification: 1 SMS + 1 email per run (not per alert)
- Deduplication via plate_alerts table upsert + 24h cooldown
- Auto-resolve updates resolved_at for cleared conditions
- pg_cron SQL appended to migration file, commented out with prerequisites
</success_criteria>

<output>
After completion, create `.planning/phases/07-plate-tracking/07-04-SUMMARY.md`
</output>
