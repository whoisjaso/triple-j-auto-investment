---
phase: 07-plate-tracking
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - triple-j-auto-investment-main/components/admin/RentalBookingModal.tsx
  - triple-j-auto-investment-main/pages/admin/Rentals.tsx
autonomous: true

must_haves:
  truths:
    - "When creating a rental booking, admin must select an available dealer plate before completing the booking"
    - "After booking is created, the selected plate is assigned to that booking automatically"
    - "When processing a rental return, admin sees a 'Plate Returned' checkbox (default checked)"
    - "If plate is confirmed returned, the assignment is closed and plate status flips to available"
    - "If plate is NOT confirmed returned, the assignment stays open and plate is flagged for follow-up"
    - "Rentals page has a 'Plates' tab showing a summary of plates currently out"
  artifacts:
    - path: "triple-j-auto-investment-main/components/admin/RentalBookingModal.tsx"
      provides: "Plate selection subsection in vehicle section"
      contains: "selectedPlateId"
    - path: "triple-j-auto-investment-main/pages/admin/Rentals.tsx"
      provides: "Plates tab in tab navigation, plate return confirmation in BookingDetail"
      contains: "plates"
  key_links:
    - from: "components/admin/RentalBookingModal.tsx"
      to: "services/plateService.ts"
      via: "getAvailableDealerPlates and assignPlateToBooking imports"
      pattern: "import.*getAvailableDealerPlates.*assignPlateToBooking.*from.*plateService"
    - from: "pages/admin/Rentals.tsx"
      to: "services/plateService.ts"
      via: "returnPlateAssignment and getPlatesOut imports"
      pattern: "import.*from.*plateService"
---

<objective>
Integrate plate tracking into the existing rental workflow: add plate selection during booking creation, plate return confirmation during rental return, and a "Plates" summary tab in the Rentals page.

Purpose: Plates become part of the rental lifecycle. Every rental booking gets a plate assigned, and every return confirms the plate came back. The Plates tab gives a quick glance at plate status without leaving the Rentals page.

Output: Modified RentalBookingModal.tsx with plate selection, modified Rentals.tsx with plate return confirmation in BookingDetail and a new Plates tab.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-plate-tracking/07-CONTEXT.md
@.planning/phases/07-plate-tracking/07-RESEARCH.md
@.planning/phases/07-plate-tracking/07-01-SUMMARY.md

Key reference files:
@triple-j-auto-investment-main/components/admin/RentalBookingModal.tsx (existing 1120-line modal to modify)
@triple-j-auto-investment-main/pages/admin/Rentals.tsx (existing 1885-line page to modify)
@triple-j-auto-investment-main/services/plateService.ts (service functions from 07-01)
@triple-j-auto-investment-main/services/rentalService.ts (returnBooking function signature)
@triple-j-auto-investment-main/types.ts (Plate, PlateAssignment types from 07-01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Plate Selection in RentalBookingModal</name>
  <files>triple-j-auto-investment-main/components/admin/RentalBookingModal.tsx</files>
  <action>
Modify the existing RentalBookingModal to add a plate selection subsection within the 'vehicle' section. Do NOT change the SectionKey type or SECTIONS array -- plate selection is an inline subsection of the existing 'vehicle' section, shown after vehicle selection.

**1. Add imports at the top:**
```typescript
import { getAvailableDealerPlates, assignPlateToBooking } from '../../services/plateService';
import { Plate } from '../../types';
```

**2. Add state variables** (after the existing vehicle state variables around line 90-100):
```typescript
const [availablePlates, setAvailablePlates] = useState<Plate[]>([]);
const [selectedPlateId, setSelectedPlateId] = useState('');
const [loadingPlates, setLoadingPlates] = useState(false);
```

**3. Add useEffect to fetch available plates when a vehicle is selected:**
```typescript
useEffect(() => {
  if (!selectedVehicleId) {
    setAvailablePlates([]);
    setSelectedPlateId('');
    return;
  }
  setLoadingPlates(true);
  getAvailableDealerPlates().then(plates => {
    setAvailablePlates(plates);
    setLoadingPlates(false);
    // Auto-select if only one available
    if (plates.length === 1) setSelectedPlateId(plates[0].id);
  }).catch(() => setLoadingPlates(false));
}, [selectedVehicleId]);
```

**4. Add plate selection UI** in the 'vehicle' section render, AFTER the vehicle grid and date pickers, BEFORE the section ends. Insert a new subsection:
```
{selectedVehicleId && !isEditMode && (
  <div className="mt-6 border-t border-gray-800 pt-4">
    <label className="block text-[10px] uppercase tracking-widest text-gray-400 mb-2">
      Assign Dealer Plate *
    </label>
    {loadingPlates ? (
      <div className="text-gray-500 text-sm">Loading available plates...</div>
    ) : availablePlates.length === 0 ? (
      <div className="text-amber-400 text-sm flex items-center gap-2">
        <AlertTriangle size={14} />
        No dealer plates available. Create plates in the Plates page first.
      </div>
    ) : (
      <div className="grid grid-cols-2 sm:grid-cols-3 gap-2">
        {availablePlates.map(plate => (
          <button
            key={plate.id}
            type="button"
            onClick={() => setSelectedPlateId(plate.id)}
            className={`p-3 border text-left text-sm transition-all ${
              selectedPlateId === plate.id
                ? 'border-tj-gold bg-tj-gold/10 text-white'
                : 'border-gray-700 hover:border-gray-500 text-gray-300'
            }`}
          >
            <span className="font-bold">{plate.plateNumber}</span>
            {plate.expirationDate && (
              <span className="block text-[10px] text-gray-500 mt-1">
                Exp: {new Date(plate.expirationDate).toLocaleDateString()}
              </span>
            )}
          </button>
        ))}
      </div>
    )}
  </div>
)}
```

Only show plate selection for NEW bookings (not edit mode), since plates are assigned at creation time.

**5. Update form validation:**
Find the `isVehicleValid` const (around line 400) and add plate requirement for new bookings:
```typescript
const isVehicleValid = !!(selectedVehicleId && startDate && endDate && !dateError && (isEditMode || selectedPlateId));
```

**6. Update handleSubmit to assign plate after booking creation:**
In the handleSubmit function, after the `createBooking` call succeeds (around line 372-377), add plate assignment:
```typescript
// After: const result = await createBooking(bookingData);
if (!result) { ... return; }

// Assign plate to the new booking
if (selectedPlateId && result.id) {
  try {
    await assignPlateToBooking(
      selectedPlateId,
      result.id,
      selectedVehicleId,
      customerName.trim(),
      customerPhone.trim(),
      endDate
    );
  } catch (plateErr) {
    console.error('Plate assignment failed:', plateErr);
    // Booking was created successfully, warn about plate assignment failure
    // Don't block the booking creation -- graceful degradation per research
    setSuccessMessage('Booking created, but plate assignment failed. Please assign the plate manually from the Plates page.');
    setTimeout(() => { onBookingCreated(); handleClose(); }, 2000);
    return;
  }
}
```

This follows the research guidance on graceful degradation: if booking succeeds but plate assignment fails, the booking still exists and admin can manually assign later.

**7. Reset plate state on close:**
In the existing state reset logic (if there's a handleClose or effect that resets state), add:
```typescript
setAvailablePlates([]);
setSelectedPlateId('');
```

**Important:** Do NOT restructure the existing modal sections. Do NOT change the tab navigation. Only add the plate selection inline within the 'vehicle' section rendering. Keep all existing functionality unchanged.
  </action>
  <verify>
1. Grep RentalBookingModal.tsx for "selectedPlateId" -- should find state, UI, and submit logic
2. Grep for "assignPlateToBooking" -- should find the import and the call in handleSubmit
3. Grep for "getAvailableDealerPlates" -- should find the import and the useEffect call
4. `npx tsc --noEmit` -- no new type errors
  </verify>
  <done>
RentalBookingModal shows available dealer plates after vehicle selection, requires plate selection for new bookings, and calls assignPlateToBooking after successful booking creation with graceful degradation if plate assignment fails.
  </done>
</task>

<task type="auto">
  <name>Task 2: Return Plate Confirmation and Plates Tab in Rentals Page</name>
  <files>triple-j-auto-investment-main/pages/admin/Rentals.tsx</files>
  <action>
Modify the existing Rentals.tsx to add: (A) plate return confirmation in the BookingDetail return flow, and (B) a "Plates" summary tab.

**A. Plate Return Confirmation in BookingDetail:**

1. Add imports at the top of Rentals.tsx:
```typescript
import {
  getPlatesOut,
  returnPlateAssignment,
  getAvailableDealerPlates,
} from '../../services/plateService';
import { Plate, PlateAssignment, PLATE_TYPE_LABELS } from '../../types';
```

2. In the BookingDetail component, add state for plate return:
```typescript
const [plateReturned, setPlateReturned] = useState(true);
const [bookingPlateAssignment, setBookingPlateAssignment] = useState<PlateAssignment | null>(null);
```

3. Add a useEffect in BookingDetail to find the plate assignment for this booking:
```typescript
useEffect(() => {
  // Find plate assignment linked to this booking from the platesOut data
  // or fetch it directly. Since we need it per-booking, pass platesOut down
  // or fetch from plateService.
  // Simplest: accept an optional platesOut prop from the parent, or
  // do a lightweight query. Let's use the parent's platesOut data.
}, [booking.id]);
```

Actually, a cleaner approach: the parent AdminRentals component fetches platesOut and passes relevant plate info to BookingDetail.

4. In the AdminRentals component (the main page component), add state:
```typescript
const [platesOut, setPlatesOut] = useState<Plate[]>([]);
```
Fetch on mount: `getPlatesOut().then(setPlatesOut).catch(console.error);`
Also refresh platesOut when bookings are refreshed.

5. Add `platesOut` to BookingDetailProps interface and pass it in the render.

6. In BookingDetail, derive the booking's plate assignment:
```typescript
const bookingPlate = useMemo(() => {
  return platesOut.find(p =>
    p.currentAssignment?.bookingId === booking.id
  ) || null;
}, [platesOut, booking.id]);
```

7. In the return flow UI (after the returnMileage input, before the "Process Return" button), add:
```typescript
{bookingPlate && (
  <div className="mt-4 border-t border-gray-800 pt-4">
    <div className="flex items-center gap-3 mb-2">
      <span className="text-[10px] uppercase tracking-widest text-gray-400">
        Dealer Plate: <span className="text-white font-bold">{bookingPlate.plateNumber}</span>
      </span>
    </div>
    <div className="flex items-center gap-3">
      <input
        type="checkbox"
        checked={plateReturned}
        onChange={e => setPlateReturned(e.target.checked)}
        className="w-4 h-4 accent-tj-gold"
        id={`plate-returned-${booking.id}`}
      />
      <label htmlFor={`plate-returned-${booking.id}`} className="text-sm text-gray-300">
        Dealer plate physically returned
      </label>
    </div>
    {!plateReturned && (
      <p className="text-xs text-red-400 flex items-center gap-1 mt-2">
        <AlertTriangle size={12} />
        Plate will be flagged for follow-up
      </p>
    )}
  </div>
)}
```

8. In the `handleProcessReturn` function, after the successful `returnBooking()` call, add plate return logic:
```typescript
// After: const success = await returnBooking(booking.id, returnDate, parseInt(returnMileage, 10));
if (success && bookingPlate?.currentAssignment) {
  try {
    await returnPlateAssignment(
      bookingPlate.currentAssignment.id,
      plateReturned
    );
  } catch (plateErr) {
    console.error('Plate return failed:', plateErr);
    // Don't fail the booking return -- plate can be handled from Plates page
  }
}
```

**B. "Plates" Summary Tab:**

1. Update the RentalTab type:
```typescript
type RentalTab = 'calendar' | 'active' | 'fleet' | 'plates';
```

2. Add the Plates tab button to the tab navigation array (around line 1393):
```typescript
{ key: 'plates' as RentalTab, label: 'Plates', icon: CreditCard },
```
Add `CreditCard` to the lucide-react import at the top.

3. Add the Plates tab content (after the Fleet tab section, before the closing divs):
```typescript
{activeTab === 'plates' && (
  <div>
    <div className="flex items-center justify-between mb-4">
      <h3 className="text-xs uppercase tracking-widest text-gray-400">
        Plates Currently Out ({platesOut.length})
      </h3>
      <Link
        to="/admin/plates"
        className="text-[10px] uppercase tracking-widest text-tj-gold hover:text-white transition-colors flex items-center gap-1"
      >
        Full Plate Management <ExternalLink size={10} />
      </Link>
    </div>

    {platesOut.length === 0 ? (
      <div className="text-center py-12 text-gray-500">
        <CheckCircle size={32} className="mx-auto mb-3 text-green-500/50" />
        <p>All plates accounted for</p>
      </div>
    ) : (
      <div className="space-y-3">
        {platesOut
          .sort((a, b) => {
            // Overdue first
            const aOverdue = a.currentAssignment?.expectedReturnDate
              ? new Date(a.currentAssignment.expectedReturnDate) < new Date() ? 1 : 0
              : 0;
            const bOverdue = b.currentAssignment?.expectedReturnDate
              ? new Date(b.currentAssignment.expectedReturnDate) < new Date() ? 1 : 0
              : 0;
            return bOverdue - aOverdue;
          })
          .map(plate => {
            const assignment = plate.currentAssignment;
            const isOverdue = assignment?.expectedReturnDate
              ? new Date(assignment.expectedReturnDate) < new Date()
              : false;
            const daysRemaining = assignment?.expectedReturnDate
              ? Math.ceil((new Date(assignment.expectedReturnDate).getTime() - new Date().getTime()) / (1000 * 60 * 60 * 24))
              : null;

            return (
              <div
                key={plate.id}
                className={`p-4 border ${
                  isOverdue ? 'border-red-500/50 bg-red-500/5' : 'border-gray-800'
                }`}
              >
                <div className="flex items-center justify-between">
                  <div>
                    <span className="font-bold text-white">{plate.plateNumber}</span>
                    <span className="ml-2 text-[10px] px-2 py-0.5 bg-blue-500/20 text-blue-400 uppercase">
                      {PLATE_TYPE_LABELS[plate.plateType]}
                    </span>
                  </div>
                  {daysRemaining !== null && (
                    <span className={`text-sm font-bold ${
                      isOverdue ? 'text-red-400 animate-pulse' : 'text-green-400'
                    }`}>
                      {isOverdue
                        ? `${Math.abs(daysRemaining)} days overdue`
                        : `${daysRemaining} days left`}
                    </span>
                  )}
                </div>
                {assignment && (
                  <div className="mt-2 text-sm text-gray-400 flex flex-wrap gap-x-4 gap-y-1">
                    <span>{assignment.customerName}</span>
                    <span>{assignment.customerPhone}</span>
                    {assignment.expectedReturnDate && (
                      <span>Return: {new Date(assignment.expectedReturnDate).toLocaleDateString()}</span>
                    )}
                  </div>
                )}
              </div>
            );
          })
        }
      </div>
    )}
  </div>
)}
```

Add `Link` to the react-router-dom imports if not already present (it likely is).

**Important guidance:**
- Do NOT restructure or reformat existing code. Only add the new sections.
- Keep the existing BookingDetail structure intact. Add plate return fields in the return flow section only.
- The Plates tab is a lightweight summary -- full management is on the dedicated /admin/plates page.
- Import `AlertTriangle` from lucide-react if not already imported (check existing imports).
  </action>
  <verify>
1. Grep Rentals.tsx for "plateReturned" -- should find state and checkbox
2. Grep Rentals.tsx for "returnPlateAssignment" -- should find the import and call in handleProcessReturn
3. Grep Rentals.tsx for "'plates'" -- should find the RentalTab type and tab content
4. Grep Rentals.tsx for "getPlatesOut" -- should find import and fetch call
5. `npx tsc --noEmit` -- no new type errors
6. `npm run build` -- build succeeds
  </verify>
  <done>
RentalBookingModal requires plate selection for new bookings and assigns plate after booking creation. Rentals.tsx BookingDetail shows "Plate Returned" checkbox during return flow and calls returnPlateAssignment. Rentals.tsx has a 4th "Plates" tab showing a summary of plates currently out with overdue-first sorting and a link to the full Plates page.
  </done>
</task>

</tasks>

<verification>
1. Create a booking in RentalBookingModal -- plate selection appears after vehicle is chosen
2. Plate is required (form won't submit without one)
3. Process a return in BookingDetail -- "Plate Returned" checkbox appears
4. Plates tab in Rentals shows current plates-out summary
5. Link from Plates tab leads to /admin/plates
6. Build passes without errors
</verification>

<success_criteria>
- RentalBookingModal shows available dealer plates after vehicle selection
- Plate selection is required for new bookings (not edit mode)
- Plate is assigned via assignPlateToBooking after successful booking creation
- BookingDetail return flow includes "Plate Returned" checkbox
- returnPlateAssignment is called with correct confirmation flag during return
- Rentals.tsx has 4 tabs: Calendar, Active Rentals, Fleet, Plates
- Plates tab shows plates-out summary with overdue indicators
- Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/07-plate-tracking/07-03-SUMMARY.md`
</output>
