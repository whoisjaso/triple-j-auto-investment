---
phase: 01-reliability-stability
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - triple-j-auto-investment-main/lib/store/vehicles.ts
  - triple-j-auto-investment-main/lib/store/types.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Vehicle CRUD operations work identically to before"
    - "useStore() returns same interface - consumers unchanged"
    - "loadVehicles, addVehicle, updateVehicle, removeVehicle all function correctly"
  artifacts:
    - path: "triple-j-auto-investment-main/lib/store/vehicles.ts"
      provides: "Vehicle CRUD operations extracted from Store.tsx"
      exports: ["loadVehicles", "addVehicle", "updateVehicle", "removeVehicle"]
    - path: "triple-j-auto-investment-main/lib/store/types.ts"
      provides: "Store module internal types"
      exports: ["VehicleState", "VehicleActions"]
  key_links:
    - from: "lib/store/vehicles.ts"
      to: "supabase/config"
      via: "import supabase"
      pattern: "from.*supabase/config"
---

<objective>
Extract vehicle CRUD operations from Store.tsx into lib/store/vehicles.ts module.

Purpose: First step in decomposing 893-line Store.tsx monolith. Vehicle operations are the largest chunk (~280 lines) and cleanly separable.

Output: New lib/store/vehicles.ts containing loadVehicles, addVehicle, updateVehicle, removeVehicle functions that Store.tsx will import.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@triple-j-auto-investment-main/context/Store.tsx
@triple-j-auto-investment-main/lib/auth.ts
@triple-j-auto-investment-main/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create lib/store/types.ts with internal types</name>
  <files>triple-j-auto-investment-main/lib/store/types.ts</files>
  <action>
Create `lib/store/types.ts` with internal types for the store modules:

```typescript
import { Vehicle, VehicleStatus } from '../../types';

// State shape for vehicle data
export interface VehicleState {
  vehicles: Vehicle[];
  isLoading: boolean;
  connectionError: string | null;
}

// Setters passed to vehicle operations
export interface VehicleSetters {
  setVehicles: React.Dispatch<React.SetStateAction<Vehicle[]>>;
  setIsLoading: React.Dispatch<React.SetStateAction<boolean>>;
  setConnectionError: React.Dispatch<React.SetStateAction<string | null>>;
}

// Re-export for convenience
export { Vehicle, VehicleStatus };
```

This defines the contract between Store.tsx and the extracted modules. Store.tsx passes setters, modules use them.
  </action>
  <verify>File exists and exports VehicleState, VehicleSetters types</verify>
  <done>lib/store/types.ts exists with VehicleState and VehicleSetters interfaces</done>
</task>

<task type="auto">
  <name>Task 2: Extract vehicle operations to lib/store/vehicles.ts</name>
  <files>triple-j-auto-investment-main/lib/store/vehicles.ts</files>
  <action>
Create `lib/store/vehicles.ts` by extracting from Store.tsx lines 240-597 (loadVehicles through removeVehicle).

**Structure:**

```typescript
import { supabase } from '../../supabase/config';
import { Vehicle, VehicleStatus } from '../../types';
import { VehicleSetters } from './types';

// Fallback data (moved from Store.tsx lines 34-123)
export const FALLBACK_VEHICLES: Vehicle[] = [
  // Copy FALLBACK_ASSETS array here exactly
];

// Load vehicles from Supabase (Store.tsx lines 240-331)
export async function loadVehicles(
  setters: VehicleSetters,
  currentVehicles: Vehicle[]
): Promise<void> {
  // Copy loadVehicles implementation
  // Replace direct state calls with setters.setVehicles, etc.
}

// Add vehicle to Supabase (Store.tsx lines 379-458)
export async function addVehicle(
  vehicle: Vehicle,
  loadVehiclesFn: () => Promise<void>
): Promise<void> {
  // Copy addVehicle implementation
  // Keep session verification logic
  // Call loadVehiclesFn() at end instead of internal loadVehicles
}

// Update vehicle in Supabase (Store.tsx lines 460-560)
export async function updateVehicle(
  id: string,
  updatedVehicle: Partial<Vehicle>,
  user: { email: string; isAdmin: boolean } | null,
  loadVehiclesFn: () => Promise<void>
): Promise<void> {
  // Copy updateVehicle implementation
  // Keep ALL session verification and RLS error handling
}

// Delete vehicle from Supabase (Store.tsx lines 562-596)
export async function removeVehicle(
  id: string,
  loadVehiclesFn: () => Promise<void>
): Promise<void> {
  // Copy removeVehicle implementation
}
```

**CRITICAL rules:**
1. Copy code EXACTLY - do not refactor or "improve"
2. Keep all console.log statements
3. Keep all alert() calls for error handling
4. Keep all session verification logic
5. Parameters replace internal state access

**Why this works:** Store.tsx will create wrapper functions that call these with the right setters/callbacks. The interface doesn't change.
  </action>
  <verify>
Run: `npx tsc --noEmit`
Check file contains: loadVehicles, addVehicle, updateVehicle, removeVehicle exports
  </verify>
  <done>lib/store/vehicles.ts exports all four vehicle CRUD functions plus FALLBACK_VEHICLES</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit` passes
2. Exports present: Both files export their expected items
3. No UI files modified: App.tsx, pages/*.tsx unchanged
</verification>

<success_criteria>
- lib/store/vehicles.ts exists with ~280 lines of vehicle CRUD logic
- lib/store/types.ts exists with VehicleState, VehicleSetters interfaces
- TypeScript compilation passes
- NO changes to Store.tsx yet (that's Plan 04)
</success_criteria>

<output>
After completion, create `.planning/phases/01-reliability-stability/01-03-SUMMARY.md`
</output>
