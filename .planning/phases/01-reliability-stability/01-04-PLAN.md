---
phase: 01-reliability-stability
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - triple-j-auto-investment-main/lib/store/sheets.ts
  - triple-j-auto-investment-main/lib/store/leads.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Google Sheets sync works identically to before"
    - "Lead management (loadLeads, addLead) works identically"
    - "useStore() returns same interface - consumers unchanged"
  artifacts:
    - path: "triple-j-auto-investment-main/lib/store/sheets.ts"
      provides: "Google Sheets sync extracted from Store.tsx"
      exports: ["syncWithGoogleSheets", "parseCSVLine", "generateOpulentCaption", "GOOGLE_SHEET_URL"]
    - path: "triple-j-auto-investment-main/lib/store/leads.ts"
      provides: "Lead management extracted from Store.tsx"
      exports: ["loadLeads", "addLead"]
  key_links:
    - from: "lib/store/sheets.ts"
      to: "supabase/config"
      via: "import supabase"
      pattern: "from.*supabase/config"
    - from: "lib/store/leads.ts"
      to: "services/emailService"
      via: "import sendLeadNotification"
      pattern: "from.*emailService"
---

<objective>
Extract Google Sheets sync and lead management from Store.tsx into separate modules.

Purpose: Second extraction step. Sheets sync (~180 lines) and leads (~60 lines) are independent concerns that can be extracted in parallel with vehicles.

Output: lib/store/sheets.ts and lib/store/leads.ts modules that Store.tsx will import.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@triple-j-auto-investment-main/context/Store.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract Google Sheets sync to lib/store/sheets.ts</name>
  <files>triple-j-auto-investment-main/lib/store/sheets.ts</files>
  <action>
Create `lib/store/sheets.ts` by extracting from Store.tsx:
- Line 9: GOOGLE_SHEET_URL constant
- Lines 126-138: generateOpulentCaption function
- Lines 605-616: parseCSVLine function
- Lines 619-796: syncWithGoogleSheets function

**Structure:**

```typescript
import { supabase } from '../../supabase/config';
import { Vehicle, VehicleStatus } from '../../types';

// Configuration (Store.tsx line 9)
export const GOOGLE_SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRHeta2U3ATyxE4hlQC3-kVCV8Iu-hnJYQIij68ptCBZYVw4C4vxIiu2fli5ltWXdsb7uVKxXco9WE3/pub?output=csv";

// Caption generator (Store.tsx lines 126-138)
export function generateOpulentCaption(
  make: string,
  model: string,
  year: number,
  mileage: number,
  price: number
): string {
  // Copy implementation exactly
}

// CSV parser (Store.tsx lines 605-616)
export function parseCSVLine(str: string): string[] {
  // Copy implementation exactly
}

// Sync interface - what Store.tsx passes in
export interface SyncDependencies {
  isSyncingRef: React.MutableRefObject<boolean>;
  vehicles: Vehicle[];
  setLastSync: React.Dispatch<React.SetStateAction<Date | null>>;
  setVehicles: React.Dispatch<React.SetStateAction<Vehicle[]>>;
  loadVehiclesFn: () => Promise<void>;
  fallbackVehicles: Vehicle[];
}

// Main sync function (Store.tsx lines 619-796)
export async function syncWithGoogleSheets(
  deps: SyncDependencies,
  silent: boolean = false
): Promise<string> {
  // Copy implementation exactly
  // Replace direct state calls with deps.setVehicles, etc.
  // Replace loadVehicles() call with deps.loadVehiclesFn()
  // Replace FALLBACK_ASSETS with deps.fallbackVehicles
}
```

**CRITICAL:** Copy code exactly. Do not refactor CSV parsing or "improve" the sync logic.
  </action>
  <verify>
Run: `npx tsc --noEmit`
Check exports: syncWithGoogleSheets, parseCSVLine, generateOpulentCaption, GOOGLE_SHEET_URL
  </verify>
  <done>lib/store/sheets.ts exports sync functionality with ~180 lines</done>
</task>

<task type="auto">
  <name>Task 2: Extract lead management to lib/store/leads.ts</name>
  <files>triple-j-auto-investment-main/lib/store/leads.ts</files>
  <action>
Create `lib/store/leads.ts` by extracting from Store.tsx:
- Lines 333-350: loadLeads function
- Lines 799-837: addLead function

**Structure:**

```typescript
import { supabase } from '../../supabase/config';
import { Lead } from '../../types';
import { sendLeadNotification } from '../../services/emailService';

// Load leads from Supabase (Store.tsx lines 333-350)
export async function loadLeads(
  setLeads: React.Dispatch<React.SetStateAction<Lead[]>>
): Promise<void> {
  try {
    const { data, error } = await supabase
      .from('leads')
      .select('*')
      .order('date', { ascending: false });

    if (error) {
      console.error('Failed to load leads:', error);
      return;
    }

    setLeads(data || []);
    console.log(`✅ Loaded ${data?.length || 0} leads from Supabase`);
  } catch (error) {
    console.error('Unexpected error loading leads:', error);
  }
}

// Add lead to Supabase (Store.tsx lines 799-837)
export async function addLead(lead: Lead): Promise<void> {
  try {
    const { error } = await supabase
      .from('leads')
      .insert([{
        name: lead.name,
        email: lead.email,
        phone: lead.phone,
        interest: lead.interest,
        status: lead.status || 'New',
        date: lead.date || new Date().toISOString(),
      }]);

    if (error) {
      console.error('Failed to add lead:', error);
      alert('Failed to save lead. Please check console for details.');
      return;
    }

    console.log('✅ Lead added successfully');

    // Send email notification asynchronously (non-blocking)
    try {
      await sendLeadNotification({
        name: lead.name,
        email: lead.email,
        phone: lead.phone,
        interest: lead.interest
      });
    } catch (emailError) {
      console.error('Email notification failed, but lead was saved:', emailError);
    }
  } catch (error) {
    console.error('Unexpected error adding lead:', error);
    alert('Failed to add lead. Please try again.');
  }
}
```

**Note:** addLead does NOT need setLeads callback - the real-time subscription handles reload.
  </action>
  <verify>
Run: `npx tsc --noEmit`
Check exports: loadLeads, addLead
  </verify>
  <done>lib/store/leads.ts exports loadLeads and addLead with ~60 lines</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit` passes
2. Exports present: sheets.ts and leads.ts export their expected items
3. No UI files modified: App.tsx, pages/*.tsx unchanged
</verification>

<success_criteria>
- lib/store/sheets.ts exists with ~180 lines of sync logic
- lib/store/leads.ts exists with ~60 lines of lead management
- TypeScript compilation passes
- NO changes to Store.tsx yet (that's Plan 05)
</success_criteria>

<output>
After completion, create `.planning/phases/01-reliability-stability/01-04-SUMMARY.md`
</output>
