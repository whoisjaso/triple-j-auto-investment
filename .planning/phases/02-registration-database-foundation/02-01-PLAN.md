---
phase: 02-registration-database-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - triple-j-auto-investment-main/supabase/migrations/02_registration_schema_update.sql
  - triple-j-auto-investment-main/supabase/registration_ledger.sql
autonomous: true

must_haves:
  truths:
    - "Registrations table has 6 status stages plus Rejected"
    - "Status changes cannot go backward (except Rejected -> Submitted)"
    - "All field changes are recorded in audit trail"
    - "Registration admins can update registrations"
    - "Anonymous users can SELECT registrations (order_id as token)"
  artifacts:
    - path: "triple-j-auto-investment-main/supabase/migrations/02_registration_schema_update.sql"
      provides: "Schema migration with all database changes"
      min_lines: 150
  key_links:
    - from: "registration_audit_trigger"
      to: "registration_audit table"
      via: "AFTER INSERT/UPDATE/DELETE trigger"
      pattern: "CREATE TRIGGER.*audit"
    - from: "validate_status_transition trigger"
      to: "registrations.current_stage"
      via: "BEFORE UPDATE trigger"
      pattern: "CREATE TRIGGER.*validate"
---

<objective>
Create the database schema migration for the 6-stage registration workflow with audit trail.

Purpose: Establish the data foundation for registration tracking with proper constraints, audit capabilities, and role-based access control.

Output: A single SQL migration file that modifies existing tables, creates audit infrastructure, and updates RLS policies.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-registration-database-foundation/02-CONTEXT.md
@.planning/phases/02-registration-database-foundation/02-RESEARCH.md

# Current schema to modify
@triple-j-auto-investment-main/supabase/registration_ledger.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration file with schema changes</name>
  <files>triple-j-auto-investment-main/supabase/migrations/02_registration_schema_update.sql</files>
  <action>
Create a new SQL migration file that performs all schema changes in a single transaction.

**1. Add is_registration_admin to profiles table:**
```sql
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS is_registration_admin BOOLEAN DEFAULT FALSE;
```

**2. Modify registrations table - add new columns:**
- `customer_address TEXT` - Full mailing address
- `plate_number VARCHAR(10)` - Dealer plate assigned at sale
- `bill_of_sale_id UUID REFERENCES bills_of_sale(id)` - Optional FK (may not exist, use SET NULL)
- `notes TEXT` - Admin general notes
- `rejection_notes TEXT` - Notes when status is rejected
- `is_archived BOOLEAN DEFAULT FALSE` - Soft delete flag
- Document checklist booleans: `doc_title_front`, `doc_title_back`, `doc_130u`, `doc_insurance`, `doc_inspection` (all BOOLEAN DEFAULT FALSE)
- Milestone timestamps: `sale_date`, `submission_date`, `approval_date`, `delivery_date` (all TIMESTAMPTZ)
- `pending_change_reason TEXT` - Temporary field for audit note capture

**3. Update current_stage constraint for 6-stage workflow:**
```sql
ALTER TABLE public.registrations DROP CONSTRAINT IF EXISTS registrations_current_stage_check;
ALTER TABLE public.registrations ADD CONSTRAINT registrations_current_stage_check
  CHECK (current_stage IN (
    'sale_complete',
    'documents_collected',
    'submitted_to_dmv',
    'dmv_processing',
    'sticker_ready',
    'sticker_delivered',
    'rejected'
  ));
```

**4. Create registration_audit table:**
```sql
CREATE TABLE IF NOT EXISTS public.registration_audit (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  registration_id UUID NOT NULL REFERENCES public.registrations(id) ON DELETE SET NULL,
  operation VARCHAR(10) NOT NULL,
  changed_fields JSONB,
  full_old_record JSONB,
  full_new_record JSONB,
  changed_by UUID REFERENCES auth.users(id),
  changed_at TIMESTAMPTZ DEFAULT NOW(),
  change_reason TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
CREATE INDEX IF NOT EXISTS idx_audit_registration ON public.registration_audit(registration_id);
CREATE INDEX IF NOT EXISTS idx_audit_changed_at ON public.registration_audit(changed_at DESC);
```

**5. Create audit trigger function:**
The trigger should:
- Compute changed_fields JSONB showing old/new values for each modified field
- Capture pending_change_reason from NEW row, then clear it
- Insert audit record with operation type, changed_by from auth.uid()
- Handle INSERT, UPDATE, DELETE operations

**6. Create status transition validation trigger:**
Enforce forward-only status transitions:
- sale_complete -> documents_collected
- documents_collected -> submitted_to_dmv
- submitted_to_dmv -> dmv_processing
- dmv_processing -> sticker_ready OR rejected
- sticker_ready -> sticker_delivered
- rejected -> submitted_to_dmv (resubmission)
- sticker_delivered -> (terminal, no transitions)

Raise exception with clear message for invalid transitions.

**7. Update RLS policies:**
- DROP existing admin policies for registrations
- CREATE new policy allowing is_admin OR is_registration_admin for INSERT/UPDATE
- CREATE policy allowing ONLY is_admin for DELETE
- Keep existing public SELECT policy (USING true)
- Add RLS to registration_audit: SELECT only for is_admin OR is_registration_admin, no direct writes

**8. Auto-populate milestone dates trigger:**
Create trigger that sets milestone dates when status changes:
- sale_complete -> set sale_date if NULL
- submitted_to_dmv -> set submission_date if NULL
- sticker_ready -> set approval_date if NULL
- sticker_delivered -> set delivery_date if NULL

Include idempotent checks (IF NOT EXISTS, DROP IF EXISTS) so migration can be re-run safely.
  </action>
  <verify>
Open migration file in Supabase SQL editor or run:
```bash
# Syntax check (if psql available locally)
psql -f triple-j-auto-investment-main/supabase/migrations/02_registration_schema_update.sql --echo-errors

# Or verify file exists and has expected sections
grep -c "CREATE TABLE.*registration_audit" triple-j-auto-investment-main/supabase/migrations/02_registration_schema_update.sql
grep -c "CREATE TRIGGER.*audit" triple-j-auto-investment-main/supabase/migrations/02_registration_schema_update.sql
grep -c "validate_status_transition" triple-j-auto-investment-main/supabase/migrations/02_registration_schema_update.sql
```
  </verify>
  <done>
Migration file contains:
- profiles.is_registration_admin column
- registrations table modifications (11+ new columns)
- registration_audit table with indexes
- audit_registration_changes() trigger function
- validate_status_transition() trigger function
- auto_set_milestone_dates() trigger function
- Updated RLS policies for both tables
  </done>
</task>

<task type="auto">
  <name>Task 2: Create migration directory and document schema</name>
  <files>triple-j-auto-investment-main/supabase/migrations/README.md</files>
  <action>
Create README.md in the migrations directory documenting:

1. **Migration order:** Run after registration_ledger.sql
2. **What this migration does:** Summarize the 6-stage workflow changes
3. **Breaking changes:**
   - Stage keys changed from 7-stage to 6-stage
   - Existing data will have invalid current_stage values - include UPDATE statement to migrate:
     ```sql
     -- Migration helper: Convert old stages to new
     UPDATE public.registrations SET current_stage = CASE
       WHEN current_stage = 'payment' THEN 'sale_complete'
       WHEN current_stage = 'insurance' THEN 'documents_collected'
       WHEN current_stage = 'inspection' THEN 'documents_collected'
       WHEN current_stage = 'submission' THEN 'submitted_to_dmv'
       WHEN current_stage = 'dmv_processing' THEN 'dmv_processing'
       WHEN current_stage = 'approved' THEN 'sticker_ready'
       WHEN current_stage = 'ready' THEN 'sticker_delivered'
       ELSE 'sale_complete'
     END;
     ```
4. **Rollback instructions:** List DROP statements in reverse order
5. **New roles:** Explain is_registration_admin usage

Keep README under 80 lines, focused on essential operational information.
  </action>
  <verify>
```bash
test -f triple-j-auto-investment-main/supabase/migrations/README.md && echo "README exists"
grep -c "is_registration_admin" triple-j-auto-investment-main/supabase/migrations/README.md
```
  </verify>
  <done>
README.md exists with migration order, breaking changes, data migration helper, and rollback instructions.
  </done>
</task>

</tasks>

<verification>
1. Migration file is syntactically valid SQL
2. All 6 stages defined in constraint
3. Audit table and trigger exist
4. Status transition validation exists
5. RLS policies updated for registration_admin role
6. README documents migration process
</verification>

<success_criteria>
- [ ] Migration file `02_registration_schema_update.sql` exists with 150+ lines
- [ ] Contains all schema changes from CONTEXT.md
- [ ] Audit infrastructure (table + trigger) complete
- [ ] Status transition validation enforced at DB level
- [ ] RLS policies allow registration_admin role
- [ ] README.md documents migration process
</success_criteria>

<output>
After completion, create `.planning/phases/02-registration-database-foundation/02-01-SUMMARY.md`
</output>
