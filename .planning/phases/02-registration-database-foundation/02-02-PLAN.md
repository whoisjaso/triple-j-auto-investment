---
phase: 02-registration-database-foundation
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - triple-j-auto-investment-main/types.ts
  - triple-j-auto-investment-main/services/registrationService.ts
autonomous: true

must_haves:
  truths:
    - "TypeScript types match new 6-stage database schema"
    - "Service functions handle new fields (milestone dates, doc checklist)"
    - "Service functions pass change_reason for audit trail"
    - "Permission checks include is_registration_admin role"
  artifacts:
    - path: "triple-j-auto-investment-main/types.ts"
      provides: "Updated Registration types and REGISTRATION_STAGES constant"
      contains: "sale_complete"
    - path: "triple-j-auto-investment-main/services/registrationService.ts"
      provides: "Updated CRUD operations with audit support"
      contains: "pending_change_reason"
  key_links:
    - from: "registrationService.ts"
      to: "supabase registrations table"
      via: "transformRegistration function"
      pattern: "transformRegistration.*current_stage"
    - from: "types.ts REGISTRATION_STAGES"
      to: "Registrations.tsx"
      via: "import and map"
      pattern: "REGISTRATION_STAGES"
---

<objective>
Update TypeScript types and service layer to match the new 6-stage database schema.

Purpose: Ensure the application layer correctly interfaces with the migrated database, maintaining type safety and supporting new features (audit notes, document checklist, milestone dates).

Output: Updated types.ts with new stage enum and Registration interface; updated registrationService.ts with modified transformers and audit-aware functions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-registration-database-foundation/02-CONTEXT.md

# Files to modify
@triple-j-auto-investment-main/types.ts
@triple-j-auto-investment-main/services/registrationService.ts

# Schema reference (from Plan 01)
@triple-j-auto-investment-main/supabase/migrations/02_registration_schema_update.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update types.ts with new 6-stage schema</name>
  <files>triple-j-auto-investment-main/types.ts</files>
  <action>
Modify the registration types section (lines ~128-308) to reflect the new schema:

**1. Update RegistrationStageKey type:**
```typescript
export type RegistrationStageKey =
  | 'sale_complete'
  | 'documents_collected'
  | 'submitted_to_dmv'
  | 'dmv_processing'
  | 'sticker_ready'
  | 'sticker_delivered'
  | 'rejected';
```

**2. Update RegistrationStageStatus type:**
Remove 'waiting' status - new workflow only uses:
```typescript
export type RegistrationStageStatus = 'pending' | 'complete' | 'rejected';
```
Note: 'rejected' is now a stage, not a status. Keep simple status enum.

Actually, per CONTEXT.md the statuses should be simpler since stages handle progression. Use:
```typescript
export type RegistrationStageStatus = 'in_progress' | 'complete';
```
The rejected state is handled by current_stage = 'rejected'.

**3. Update Registration interface - add new fields:**
```typescript
export interface Registration {
  id: string;
  orderId: string;
  vehicleId?: string;
  billOfSaleId?: string;

  // Customer Info
  customerName: string;
  customerEmail?: string;
  customerPhone?: string;
  customerAddress?: string;

  // Vehicle Info (snapshot)
  vin: string;
  vehicleYear: number;
  vehicleMake: string;
  vehicleModel: string;
  plateNumber?: string;

  // Document Checklist
  docTitleFront: boolean;
  docTitleBack: boolean;
  doc130u: boolean;
  docInsurance: boolean;
  docInspection: boolean;

  // Status
  currentStage: RegistrationStageKey;

  // Milestone Dates
  saleDate?: string;
  submissionDate?: string;
  approvalDate?: string;
  deliveryDate?: string;

  // Notes
  notes?: string;
  rejectionNotes?: string;

  // Metadata
  isArchived: boolean;
  purchaseDate: string;
  createdAt: string;
  updatedAt: string;
}
```

**4. Remove RegistrationStage interface** - we no longer use the separate stages table.

**5. Update REGISTRATION_STAGES constant:**
```typescript
export const REGISTRATION_STAGES: StageConfig[] = [
  {
    key: 'sale_complete',
    label: 'Sale Complete',
    ownership: 'dealer',
    ownershipLabel: 'Triple J',
    description: 'Vehicle sold, plates assigned from dealer inventory.',
    order: 1
  },
  {
    key: 'documents_collected',
    label: 'Documents Collected',
    ownership: 'dealer',
    ownershipLabel: 'Triple J',
    description: 'All paperwork received (title, 130-U, insurance, inspection).',
    order: 2
  },
  {
    key: 'submitted_to_dmv',
    label: 'Submitted to DMV',
    ownership: 'dealer',
    ownershipLabel: 'Triple J',
    description: 'Packet uploaded to webDEALER.',
    order: 3
  },
  {
    key: 'dmv_processing',
    label: 'DMV Processing',
    ownership: 'state',
    ownershipLabel: 'State',
    description: 'Awaiting DMV review.',
    expectedDuration: '5-10 business days',
    order: 4
  },
  {
    key: 'sticker_ready',
    label: 'Sticker Ready',
    ownership: 'dealer',
    ownershipLabel: 'Triple J',
    description: 'Registration approved, sticker available for pickup/delivery.',
    order: 5
  },
  {
    key: 'sticker_delivered',
    label: 'Sticker Delivered',
    ownership: 'dealer',
    ownershipLabel: 'Triple J',
    description: 'Customer received their sticker.',
    order: 6
  },
  {
    key: 'rejected',
    label: 'Rejected',
    ownership: 'state',
    ownershipLabel: 'State',
    description: 'DMV rejected submission. Review notes and resubmit.',
    order: 0 // Special case, branches from dmv_processing
  }
];
```

**6. Update StageConfig interface:**
Add `order: number` field and remove `actionRequiredText` (no customer actions in this workflow).

**7. Add RegistrationAudit interface:**
```typescript
export interface RegistrationAudit {
  id: string;
  registrationId: string;
  operation: 'INSERT' | 'UPDATE' | 'DELETE';
  changedFields?: Record<string, { old: unknown; new: unknown }>;
  fullOldRecord?: Registration;
  fullNewRecord?: Registration;
  changedBy?: string;
  changedAt: string;
  changeReason?: string;
  createdAt: string;
}
```

**8. Add VALID_TRANSITIONS constant:**
```typescript
export const VALID_TRANSITIONS: Record<RegistrationStageKey, RegistrationStageKey[]> = {
  'sale_complete': ['documents_collected'],
  'documents_collected': ['submitted_to_dmv'],
  'submitted_to_dmv': ['dmv_processing'],
  'dmv_processing': ['sticker_ready', 'rejected'],
  'sticker_ready': ['sticker_delivered'],
  'sticker_delivered': [],
  'rejected': ['submitted_to_dmv']
};
```

**9. Update OWNERSHIP_COLORS** - keep as-is, just remove 'customer' since all stages are dealer/state owned in new workflow.
  </action>
  <verify>
```bash
cd triple-j-auto-investment-main && npx tsc --noEmit types.ts 2>&1 | head -20
```
Check that TypeScript compiles without errors for the types file.
  </verify>
  <done>
- RegistrationStageKey has 7 values (6 stages + rejected)
- Registration interface has all new fields (15+ fields)
- REGISTRATION_STAGES constant has 7 entries with new labels
- VALID_TRANSITIONS constant defines allowed paths
- RegistrationAudit interface exists
  </done>
</task>

<task type="auto">
  <name>Task 2: Update registrationService.ts transformers and functions</name>
  <files>triple-j-auto-investment-main/services/registrationService.ts</files>
  <action>
Modify registrationService.ts to work with the new schema:

**1. Update transformRegistration function (lines 21-37):**
Add all new fields to the transformer:
```typescript
const transformRegistration = (data: any): Registration => ({
  id: data.id,
  orderId: data.order_id,
  vehicleId: data.vehicle_id,
  billOfSaleId: data.bill_of_sale_id,
  customerName: data.customer_name,
  customerEmail: data.customer_email,
  customerPhone: data.customer_phone,
  customerAddress: data.customer_address,
  vin: data.vin,
  vehicleYear: data.vehicle_year,
  vehicleMake: data.vehicle_make,
  vehicleModel: data.vehicle_model,
  plateNumber: data.plate_number,
  // Document checklist
  docTitleFront: data.doc_title_front ?? false,
  docTitleBack: data.doc_title_back ?? false,
  doc130u: data.doc_130u ?? false,
  docInsurance: data.doc_insurance ?? false,
  docInspection: data.doc_inspection ?? false,
  // Status
  currentStage: data.current_stage,
  // Milestone dates
  saleDate: data.sale_date,
  submissionDate: data.submission_date,
  approvalDate: data.approval_date,
  deliveryDate: data.delivery_date,
  // Notes
  notes: data.notes,
  rejectionNotes: data.rejection_notes,
  // Metadata
  isArchived: data.is_archived ?? false,
  purchaseDate: data.purchase_date,
  createdAt: data.created_at,
  updatedAt: data.updated_at
});
```

**2. Remove transformStage function** - no longer needed.

**3. Update getAllRegistrations (lines 143-185):**
- Remove the stages fetching logic (lines 157-178)
- Keep simple registration fetch and transform
- Filter out archived registrations by default: `.eq('is_archived', false)`

**4. Update getRegistrationById (lines 190-221):**
- Remove stages fetching logic
- Just fetch and transform single registration

**5. Update getRegistrationByOrderId (lines 80-111):**
- Remove stages fetching logic
- Add filter for non-archived: `.eq('is_archived', false)`

**6. Update createRegistration (lines 226-289):**
- Set `current_stage: 'sale_complete'` (not 'payment')
- Remove call to `initialize_registration_stages` RPC
- Add new fields to insert: plate_number (from input), sale_date (NOW)
- Accept new input fields: plateNumber, customerAddress

**7. Create new updateRegistrationStatus function:**
```typescript
export async function updateRegistrationStatus(
  registrationId: string,
  newStage: RegistrationStageKey,
  options?: {
    changeReason?: string;
    rejectionNotes?: string;
  }
): Promise<boolean> {
  try {
    const updateData: Record<string, unknown> = {
      current_stage: newStage,
      updated_at: new Date().toISOString()
    };

    // Set pending_change_reason for audit trigger to capture
    if (options?.changeReason) {
      updateData.pending_change_reason = options.changeReason;
    }

    // Set rejection notes if rejecting
    if (newStage === 'rejected' && options?.rejectionNotes) {
      updateData.rejection_notes = options.rejectionNotes;
    }

    const { error } = await supabase
      .from('registrations')
      .update(updateData)
      .eq('id', registrationId);

    if (error) {
      console.error('Error updating registration status:', error);
      return false;
    }

    return true;
  } catch (error) {
    console.error('Error updating registration status:', error);
    return false;
  }
}
```

**8. Create updateDocumentChecklist function:**
```typescript
export async function updateDocumentChecklist(
  registrationId: string,
  checklist: {
    docTitleFront?: boolean;
    docTitleBack?: boolean;
    doc130u?: boolean;
    docInsurance?: boolean;
    docInspection?: boolean;
  },
  changeReason?: string
): Promise<boolean> {
  const updateData: Record<string, unknown> = {
    updated_at: new Date().toISOString()
  };

  if (checklist.docTitleFront !== undefined) updateData.doc_title_front = checklist.docTitleFront;
  if (checklist.docTitleBack !== undefined) updateData.doc_title_back = checklist.docTitleBack;
  if (checklist.doc130u !== undefined) updateData.doc_130u = checklist.doc130u;
  if (checklist.docInsurance !== undefined) updateData.doc_insurance = checklist.docInsurance;
  if (checklist.docInspection !== undefined) updateData.doc_inspection = checklist.docInspection;

  if (changeReason) {
    updateData.pending_change_reason = changeReason;
  }

  const { error } = await supabase
    .from('registrations')
    .update(updateData)
    .eq('id', registrationId);

  return !error;
}
```

**9. Create getRegistrationAudit function:**
```typescript
export async function getRegistrationAudit(registrationId: string): Promise<RegistrationAudit[]> {
  const { data, error } = await supabase
    .from('registration_audit')
    .select('*')
    .eq('registration_id', registrationId)
    .order('changed_at', { ascending: false });

  if (error) {
    console.error('Error fetching audit trail:', error);
    return [];
  }

  return (data || []).map(row => ({
    id: row.id,
    registrationId: row.registration_id,
    operation: row.operation,
    changedFields: row.changed_fields,
    fullOldRecord: row.full_old_record,
    fullNewRecord: row.full_new_record,
    changedBy: row.changed_by,
    changedAt: row.changed_at,
    changeReason: row.change_reason,
    createdAt: row.created_at
  }));
}
```

**10. Update deleteRegistration to soft delete:**
```typescript
export async function archiveRegistration(id: string): Promise<boolean> {
  const { error } = await supabase
    .from('registrations')
    .update({ is_archived: true, updated_at: new Date().toISOString() })
    .eq('id', id);
  return !error;
}
```
Keep deleteRegistration for actual deletion if needed by admins.

**11. Remove functions that depended on registration_stages table:**
- Remove `updateStageStatus` (replaced by updateRegistrationStatus)
- Remove `blockStage`
- Remove `addStageNotes`
- Remove `sendStageNotification` (will be re-added in Phase 4)
- Remove `getRegistrationsRequiringAction` (customer action stages removed)

**12. Update imports at top of file:**
Remove RegistrationStage imports, add RegistrationAudit, update RegistrationStageKey values in any constants.
  </action>
  <verify>
```bash
cd triple-j-auto-investment-main && npx tsc --noEmit services/registrationService.ts 2>&1 | head -30
```
Verify no TypeScript compilation errors.
  </verify>
  <done>
- transformRegistration handles all 20+ fields
- No references to registration_stages table
- updateRegistrationStatus supports change_reason
- updateDocumentChecklist function exists
- getRegistrationAudit function exists
- archiveRegistration for soft delete
- getAllRegistrations filters archived by default
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes for both files
2. Registration interface has all fields from database schema
3. REGISTRATION_STAGES has 7 entries (6 + rejected)
4. Service functions use new field names
5. No references to registration_stages table remain
</verification>

<success_criteria>
- [ ] types.ts compiles without errors
- [ ] registrationService.ts compiles without errors
- [ ] RegistrationStageKey has 7 values
- [ ] Registration interface has 20+ fields including doc checklist and milestones
- [ ] VALID_TRANSITIONS constant matches database constraint
- [ ] Service functions support pending_change_reason for audit
- [ ] No references to registration_stages table
</success_criteria>

<output>
After completion, create `.planning/phases/02-registration-database-foundation/02-02-SUMMARY.md`
</output>
