---
phase: 02-registration-database-foundation
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - triple-j-auto-investment-main/pages/admin/Registrations.tsx
autonomous: false

must_haves:
  truths:
    - "Admin sees 6-stage workflow (not 7)"
    - "Status changes use step buttons with confirmation dialogs"
    - "Rejection requires notes input"
    - "Document checklist is visible and editable"
    - "Audit history is viewable per registration"
  artifacts:
    - path: "triple-j-auto-investment-main/pages/admin/Registrations.tsx"
      provides: "Updated admin UI for 6-stage workflow"
      min_lines: 600
  key_links:
    - from: "Registrations.tsx"
      to: "registrationService.ts"
      via: "updateRegistrationStatus call"
      pattern: "updateRegistrationStatus"
    - from: "Registrations.tsx"
      to: "types.ts REGISTRATION_STAGES"
      via: "import and render"
      pattern: "REGISTRATION_STAGES.map"
---

<objective>
Update the admin Registrations page to use the new 6-stage workflow with step buttons and confirmation dialogs.

Purpose: Give admins a clear, controlled interface for advancing registration status with proper confirmation and audit note capture.

Output: Updated Registrations.tsx with step buttons, confirmation modals, document checklist UI, and audit history view.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-registration-database-foundation/02-CONTEXT.md

# File to modify
@triple-j-auto-investment-main/pages/admin/Registrations.tsx

# Updated types and service (from Plan 02)
@triple-j-auto-investment-main/types.ts
@triple-j-auto-investment-main/services/registrationService.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update imports and stage rendering</name>
  <files>triple-j-auto-investment-main/pages/admin/Registrations.tsx</files>
  <action>
**1. Update imports (top of file):**
- Remove RegistrationStage import
- Add VALID_TRANSITIONS import
- Update service imports: add updateRegistrationStatus, updateDocumentChecklist, getRegistrationAudit, archiveRegistration
- Remove old service imports: updateStageStatus, blockStage, addStageNotes

**2. Update STAGE_ICONS mapping (lines ~56-64):**
Replace old 7-stage icons with new 6-stage icons:
```typescript
const STAGE_ICONS: Record<RegistrationStageKey, React.ReactNode> = {
  sale_complete: <Car size={16} />,
  documents_collected: <FileText size={16} />,
  submitted_to_dmv: <Send size={16} />,  // Add Send to imports
  dmv_processing: <Building size={16} />,
  sticker_ready: <CheckCircle size={16} />,
  sticker_delivered: <Package size={16} />,
  rejected: <AlertCircle size={16} />
};
```

**3. Add state for confirmation dialog:**
```typescript
const [confirmDialog, setConfirmDialog] = useState<{
  open: boolean;
  registrationId: string;
  currentStage: RegistrationStageKey;
  targetStage: RegistrationStageKey;
  requiresNotes: boolean;
} | null>(null);
const [confirmNotes, setConfirmNotes] = useState('');
const [auditHistory, setAuditHistory] = useState<RegistrationAudit[]>([]);
const [showAuditHistory, setShowAuditHistory] = useState<string | null>(null);
```

**4. Update stats bar (lines ~296-319):**
Change "Complete" count to check for `sticker_delivered` stage:
```typescript
{registrations.filter(r => r.currentStage === 'sticker_delivered').length}
```
Add "Rejected" stat card:
```typescript
<div className="bg-tj-dark border border-gray-800 p-4">
  <p className="text-orange-400 text-[10px] uppercase tracking-widest mb-1">Rejected</p>
  <p className="text-orange-400 text-2xl font-mono">
    {registrations.filter(r => r.currentStage === 'rejected').length}
  </p>
</div>
```

**5. Remove stages-based logic throughout:**
- Remove `getStage` helper function (line ~193)
- Remove all references to `reg.stages`
- Use `reg.currentStage` directly for status display

**6. Update the expanded content section (lines ~442-575):**
Replace the old stage pipeline with new step-button interface:

```tsx
{/* Document Checklist */}
<div className="mb-6 pb-6 border-b border-gray-800">
  <h4 className="text-white text-sm uppercase tracking-widest mb-4">Document Checklist</h4>
  <div className="grid grid-cols-2 md:grid-cols-5 gap-3">
    {[
      { key: 'docTitleFront', label: 'Title (Front)' },
      { key: 'docTitleBack', label: 'Title (Back)' },
      { key: 'doc130u', label: '130-U' },
      { key: 'docInsurance', label: 'Insurance' },
      { key: 'docInspection', label: 'Inspection' }
    ].map(doc => (
      <button
        key={doc.key}
        onClick={() => handleDocToggle(reg.id, doc.key, !reg[doc.key])}
        className={`p-3 border flex items-center gap-2 transition-colors ${
          reg[doc.key as keyof Registration]
            ? 'border-green-500/50 bg-green-900/20 text-green-400'
            : 'border-gray-700 text-gray-500 hover:border-gray-600'
        }`}
      >
        {reg[doc.key as keyof Registration] ? <Check size={14} /> : <Circle size={14} />}
        <span className="text-xs">{doc.label}</span>
      </button>
    ))}
  </div>
</div>

{/* Stage Progress */}
<h4 className="text-white text-sm uppercase tracking-widest mb-4">Registration Progress</h4>
<div className="space-y-2">
  {REGISTRATION_STAGES.filter(s => s.key !== 'rejected').map((stageConfig, index) => {
    const isCurrent = reg.currentStage === stageConfig.key;
    const isComplete = stageConfig.order < (REGISTRATION_STAGES.find(s => s.key === reg.currentStage)?.order ?? 0);
    const isRejected = reg.currentStage === 'rejected';
    const canAdvanceTo = VALID_TRANSITIONS[reg.currentStage]?.includes(stageConfig.key);

    return (
      <div
        key={stageConfig.key}
        className={`flex items-center gap-4 p-3 border ${
          isCurrent
            ? 'border-tj-gold/50 bg-tj-gold/10'
            : isComplete
            ? 'border-green-500/30 bg-green-900/10'
            : 'border-gray-800'
        }`}
      >
        <span className="text-gray-600 text-xs font-mono w-6">{index + 1}</span>
        <div className={`${isCurrent ? 'text-tj-gold' : isComplete ? 'text-green-500' : 'text-gray-600'}`}>
          {STAGE_ICONS[stageConfig.key]}
        </div>
        <span className={`flex-1 text-sm ${isCurrent ? 'text-white font-medium' : isComplete ? 'text-green-400' : 'text-gray-500'}`}>
          {stageConfig.label}
        </span>

        {/* Milestone date if applicable */}
        {stageConfig.key === 'sale_complete' && reg.saleDate && (
          <span className="text-gray-500 text-xs">{formatDate(reg.saleDate)}</span>
        )}
        {stageConfig.key === 'submitted_to_dmv' && reg.submissionDate && (
          <span className="text-gray-500 text-xs">{formatDate(reg.submissionDate)}</span>
        )}
        {stageConfig.key === 'sticker_ready' && reg.approvalDate && (
          <span className="text-gray-500 text-xs">{formatDate(reg.approvalDate)}</span>
        )}
        {stageConfig.key === 'sticker_delivered' && reg.deliveryDate && (
          <span className="text-gray-500 text-xs">{formatDate(reg.deliveryDate)}</span>
        )}

        {/* Status indicator */}
        <div className="shrink-0">
          {isComplete ? (
            <CheckCircle className="text-green-400" size={14} />
          ) : isCurrent ? (
            <Clock className="text-tj-gold" size={14} />
          ) : (
            <Circle className="text-gray-600" size={14} />
          )}
        </div>

        {/* Advance button */}
        {canAdvanceTo && (
          <button
            onClick={() => openConfirmDialog(reg.id, reg.currentStage, stageConfig.key)}
            disabled={actionLoading === reg.id}
            className="px-3 py-1 bg-tj-gold text-black text-xs font-bold hover:bg-white transition-colors disabled:opacity-50"
          >
            Mark {stageConfig.label.split(' ')[0]}
          </button>
        )}
      </div>
    );
  })}

  {/* Rejected state - show if current or show reject button from dmv_processing */}
  {reg.currentStage === 'rejected' ? (
    <div className="flex items-center gap-4 p-3 border border-red-500/50 bg-red-900/20">
      <AlertCircle className="text-red-400" size={16} />
      <div className="flex-1">
        <span className="text-red-400 text-sm font-medium">Rejected by DMV</span>
        {reg.rejectionNotes && (
          <p className="text-red-300 text-xs mt-1">{reg.rejectionNotes}</p>
        )}
      </div>
      <button
        onClick={() => openConfirmDialog(reg.id, 'rejected', 'submitted_to_dmv')}
        disabled={actionLoading === reg.id}
        className="px-3 py-1 bg-amber-500 text-black text-xs font-bold hover:bg-amber-400 transition-colors disabled:opacity-50"
      >
        Resubmit
      </button>
    </div>
  ) : reg.currentStage === 'dmv_processing' && (
    <button
      onClick={() => openConfirmDialog(reg.id, reg.currentStage, 'rejected')}
      disabled={actionLoading === reg.id}
      className="w-full p-3 border border-red-500/30 text-red-400 text-sm hover:bg-red-900/20 transition-colors disabled:opacity-50 flex items-center justify-center gap-2"
    >
      <AlertCircle size={14} />
      Mark as Rejected
    </button>
  )}
</div>

{/* Notes Section */}
<div className="mt-6 pt-6 border-t border-gray-800">
  <h4 className="text-white text-sm uppercase tracking-widest mb-2">Admin Notes</h4>
  <p className="text-gray-400 text-sm">{reg.notes || 'No notes'}</p>
</div>

{/* Audit History Link */}
<button
  onClick={() => loadAuditHistory(reg.id)}
  className="mt-4 text-gray-500 text-xs hover:text-tj-gold transition-colors flex items-center gap-1"
>
  <Clock size={12} />
  View Change History
</button>
```
  </action>
  <verify>
Verify the file has the updated stage rendering by checking for key patterns:
```bash
grep -c "VALID_TRANSITIONS" triple-j-auto-investment-main/pages/admin/Registrations.tsx
grep -c "sale_complete" triple-j-auto-investment-main/pages/admin/Registrations.tsx
grep -c "docTitleFront" triple-j-auto-investment-main/pages/admin/Registrations.tsx
```
  </verify>
  <done>
- STAGE_ICONS uses new 6 stage keys
- Document checklist rendered as toggle buttons
- Stage progress uses VALID_TRANSITIONS for button visibility
- Milestone dates displayed inline
- Rejected state handled specially
- Audit history link present
  </done>
</task>

<task type="auto">
  <name>Task 2: Add confirmation dialog and handlers</name>
  <files>triple-j-auto-investment-main/pages/admin/Registrations.tsx</files>
  <action>
**1. Add handler functions after the existing handlers (~line 150):**

```typescript
// Open confirmation dialog for status change
const openConfirmDialog = (
  registrationId: string,
  currentStage: RegistrationStageKey,
  targetStage: RegistrationStageKey
) => {
  setConfirmDialog({
    open: true,
    registrationId,
    currentStage,
    targetStage,
    requiresNotes: targetStage === 'rejected'
  });
  setConfirmNotes('');
};

// Handle confirmed status change
const handleConfirmedStatusChange = async () => {
  if (!confirmDialog) return;

  setActionLoading(confirmDialog.registrationId);
  try {
    const success = await updateRegistrationStatus(
      confirmDialog.registrationId,
      confirmDialog.targetStage,
      {
        changeReason: confirmNotes || undefined,
        rejectionNotes: confirmDialog.targetStage === 'rejected' ? confirmNotes : undefined
      }
    );

    if (success) {
      await loadRegistrations();
      setConfirmDialog(null);
    }
  } catch (error) {
    console.error('Error updating status:', error);
  } finally {
    setActionLoading(null);
  }
};

// Handle document checklist toggle
const handleDocToggle = async (
  registrationId: string,
  docKey: string,
  value: boolean
) => {
  setActionLoading(registrationId);
  try {
    await updateDocumentChecklist(
      registrationId,
      { [docKey]: value }
    );
    await loadRegistrations();
  } catch (error) {
    console.error('Error updating document:', error);
  } finally {
    setActionLoading(null);
  }
};

// Load audit history for a registration
const loadAuditHistory = async (registrationId: string) => {
  const history = await getRegistrationAudit(registrationId);
  setAuditHistory(history);
  setShowAuditHistory(registrationId);
};
```

**2. Add confirmation dialog modal (before closing div, around line 760):**

```tsx
{/* Status Change Confirmation Dialog */}
{confirmDialog && (
  <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
    <div className="bg-tj-dark border border-gray-700 w-full max-w-md">
      <div className="p-6 border-b border-gray-800">
        <h3 className="text-white font-display text-lg tracking-wide">
          Confirm Status Change
        </h3>
      </div>

      <div className="p-6 space-y-4">
        <p className="text-gray-400">
          Change status from{' '}
          <span className="text-white font-medium">
            {REGISTRATION_STAGES.find(s => s.key === confirmDialog.currentStage)?.label}
          </span>
          {' '}to{' '}
          <span className={confirmDialog.targetStage === 'rejected' ? 'text-red-400' : 'text-tj-gold'}>
            {REGISTRATION_STAGES.find(s => s.key === confirmDialog.targetStage)?.label}
          </span>
          ?
        </p>

        <div>
          <label className="block text-gray-500 text-[10px] uppercase tracking-widest mb-2">
            {confirmDialog.requiresNotes ? 'Rejection Notes (Required)' : 'Change Notes (Optional)'}
          </label>
          <textarea
            value={confirmNotes}
            onChange={e => setConfirmNotes(e.target.value)}
            placeholder={confirmDialog.requiresNotes
              ? 'Enter reason for rejection from DMV...'
              : 'Add optional note for audit trail...'
            }
            className="w-full bg-black border border-gray-700 px-4 py-3 text-white text-sm focus:outline-none focus:border-tj-gold resize-none"
            rows={3}
          />
        </div>
      </div>

      <div className="p-6 border-t border-gray-800 flex justify-end gap-4">
        <button
          onClick={() => setConfirmDialog(null)}
          className="px-6 py-3 border border-gray-700 text-gray-400 hover:text-white hover:border-gray-500 transition-colors"
        >
          Cancel
        </button>
        <button
          onClick={handleConfirmedStatusChange}
          disabled={actionLoading !== null || (confirmDialog.requiresNotes && !confirmNotes.trim())}
          className={`px-6 py-3 font-bold text-sm tracking-wider transition-colors disabled:opacity-50 flex items-center gap-2 ${
            confirmDialog.targetStage === 'rejected'
              ? 'bg-red-500 text-white hover:bg-red-400'
              : 'bg-tj-gold text-black hover:bg-white'
          }`}
        >
          {actionLoading ? (
            <>
              <Loader2 className="animate-spin" size={16} />
              Updating...
            </>
          ) : (
            <>
              <Check size={16} />
              Confirm
            </>
          )}
        </button>
      </div>
    </div>
  </div>
)}

{/* Audit History Modal */}
{showAuditHistory && (
  <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
    <div className="bg-tj-dark border border-gray-700 w-full max-w-2xl max-h-[80vh] flex flex-col">
      <div className="p-6 border-b border-gray-800 flex justify-between items-center">
        <h3 className="text-white font-display text-lg tracking-wide">
          Change History
        </h3>
        <button
          onClick={() => setShowAuditHistory(null)}
          className="text-gray-500 hover:text-white transition-colors"
        >
          <X size={20} />
        </button>
      </div>

      <div className="p-6 overflow-y-auto flex-1">
        {auditHistory.length === 0 ? (
          <p className="text-gray-500 text-center py-8">No change history recorded</p>
        ) : (
          <div className="space-y-4">
            {auditHistory.map(audit => (
              <div key={audit.id} className="border border-gray-800 p-4">
                <div className="flex justify-between items-start mb-2">
                  <span className={`text-xs px-2 py-1 ${
                    audit.operation === 'INSERT' ? 'bg-green-500/20 text-green-400' :
                    audit.operation === 'UPDATE' ? 'bg-blue-500/20 text-blue-400' :
                    'bg-red-500/20 text-red-400'
                  }`}>
                    {audit.operation}
                  </span>
                  <span className="text-gray-500 text-xs">
                    {new Date(audit.changedAt).toLocaleString()}
                  </span>
                </div>

                {audit.changeReason && (
                  <p className="text-gray-400 text-sm mb-2 italic">"{audit.changeReason}"</p>
                )}

                {audit.changedFields && Object.keys(audit.changedFields).length > 0 && (
                  <div className="space-y-1">
                    {Object.entries(audit.changedFields).map(([field, values]) => (
                      <div key={field} className="text-xs">
                        <span className="text-gray-500">{field}:</span>{' '}
                        <span className="text-red-400 line-through">{String((values as any).old ?? 'null')}</span>
                        {' -> '}
                        <span className="text-green-400">{String((values as any).new ?? 'null')}</span>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  </div>
)}
```

**3. Update the create form to include new fields:**
In the create modal form, add:
- `plateNumber` input field
- `customerAddress` textarea

**4. Update createForm state and handleCreateRegistration:**
Add plateNumber and customerAddress to the form state initial values and the create call.
  </action>
  <verify>
```bash
grep -c "confirmDialog" triple-j-auto-investment-main/pages/admin/Registrations.tsx
grep -c "handleConfirmedStatusChange" triple-j-auto-investment-main/pages/admin/Registrations.tsx
grep -c "auditHistory" triple-j-auto-investment-main/pages/admin/Registrations.tsx
```
All should return positive counts.
  </verify>
  <done>
- Confirmation dialog renders with notes input
- handleConfirmedStatusChange calls updateRegistrationStatus
- handleDocToggle calls updateDocumentChecklist
- loadAuditHistory fetches and displays history
- Audit history modal shows changes with old/new values
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Updated admin Registrations page with:
- 6-stage workflow visualization
- Step buttons for status advancement
- Confirmation dialogs with notes
- Document checklist toggles
- Audit history modal
  </what-built>
  <how-to-verify>
1. Start the dev server: `cd triple-j-auto-investment-main && npm run dev`
2. Navigate to admin Registrations page
3. Verify:
   - Stats bar shows correct counts (Total, In Progress, Rejected, Complete)
   - Registration cards expand to show 6 stages (not 7)
   - Document checklist shows 5 toggle buttons
   - "Mark [Next Stage]" buttons appear for valid transitions
   - Clicking a step button opens confirmation dialog
   - Rejection requires notes, other changes have optional notes
   - "View Change History" link loads audit modal
4. Create a test registration and advance through stages
5. Verify audit history records changes with notes
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. File compiles without TypeScript errors
2. 6-stage workflow renders correctly
3. Step buttons follow VALID_TRANSITIONS rules
4. Confirmation dialog captures notes
5. Audit history displays in modal
6. Document checklist is interactive
</verification>

<success_criteria>
- [ ] No references to old 7-stage workflow
- [ ] Step buttons replace dropdown for status changes
- [ ] Confirmation dialog shows for all status changes
- [ ] Rejection requires notes (button disabled without)
- [ ] Document checklist renders 5 boolean toggles
- [ ] Audit history modal shows change details
- [ ] Human verification confirms UI works as expected
</success_criteria>

<output>
After completion, create `.planning/phases/02-registration-database-foundation/02-03-SUMMARY.md`
</output>
